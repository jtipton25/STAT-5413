<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>20 Day 20 | Notes for STAT 5413 - Spatial Statistics</title>
  <meta name="description" content="These are the lecture notes for STAT 5413 Spatial Statistics" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="20 Day 20 | Notes for STAT 5413 - Spatial Statistics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="These are the lecture notes for STAT 5413 Spatial Statistics" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="20 Day 20 | Notes for STAT 5413 - Spatial Statistics" />
  
  <meta name="twitter:description" content="These are the lecture notes for STAT 5413 Spatial Statistics" />
  

<meta name="author" content="John Tipton" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="day-19.html"/>
<link rel="next" href="day-21.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.13/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
<script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">STAT 5413 Spatial Statistics</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="day-1.html"><a href="day-1.html"><i class="fa fa-check"></i><b>1</b> Day 1</a><ul>
<li class="chapter" data-level="1.1" data-path="day-1.html"><a href="day-1.html#notation"><i class="fa fa-check"></i><b>1.1</b> Notation</a></li>
<li class="chapter" data-level="1.2" data-path="day-1.html"><a href="day-1.html#probability-distributions"><i class="fa fa-check"></i><b>1.2</b> Probability Distributions</a><ul>
<li class="chapter" data-level="1.2.1" data-path="day-1.html"><a href="day-1.html#example-linear-regression"><i class="fa fa-check"></i><b>1.2.1</b> Example: linear regression</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="day-1.html"><a href="day-1.html#hierarchical-modeling"><i class="fa fa-check"></i><b>1.3</b> Hierarchical modeling</a><ul>
<li class="chapter" data-level="1.3.1" data-path="day-1.html"><a href="day-1.html#bayesian-hierarchical-models-bhms"><i class="fa fa-check"></i><b>1.3.1</b> Bayesian Hierarchical models (BHMs)</a></li>
<li class="chapter" data-level="1.3.2" data-path="day-1.html"><a href="day-1.html#empirical-hierarchical-models-ehms"><i class="fa fa-check"></i><b>1.3.2</b> Empirical Hierarchical models (EHMs)</a></li>
<li class="chapter" data-level="1.3.3" data-path="day-1.html"><a href="day-1.html#data-model"><i class="fa fa-check"></i><b>1.3.3</b> Data Model</a></li>
<li class="chapter" data-level="1.3.4" data-path="day-1.html"><a href="day-1.html#process-model"><i class="fa fa-check"></i><b>1.3.4</b> Process Model</a></li>
<li class="chapter" data-level="1.3.5" data-path="day-1.html"><a href="day-1.html#parameter-prior-model-bmhs-only"><i class="fa fa-check"></i><b>1.3.5</b> Parameter (Prior) Model (BMHs only)</a></li>
<li class="chapter" data-level="1.3.6" data-path="day-1.html"><a href="day-1.html#posterior-distribution"><i class="fa fa-check"></i><b>1.3.6</b> Posterior Distribution</a></li>
<li class="chapter" data-level="1.3.7" data-path="day-1.html"><a href="day-1.html#scientifically-motivated-statistical-modeling"><i class="fa fa-check"></i><b>1.3.7</b> Scientifically Motivated Statistical Modeling</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="day-2.html"><a href="day-2.html"><i class="fa fa-check"></i><b>2</b> Day 2</a><ul>
<li class="chapter" data-level="2.1" data-path="day-2.html"><a href="day-2.html#spatial-data"><i class="fa fa-check"></i><b>2.1</b> Spatial Data</a></li>
<li class="chapter" data-level="2.2" data-path="day-2.html"><a href="day-2.html#types-of-spatial-data"><i class="fa fa-check"></i><b>2.2</b> Types of spatial data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="day-2.html"><a href="day-2.html#geostatistical-data"><i class="fa fa-check"></i><b>2.2.1</b> Geostatistical data</a></li>
<li class="chapter" data-level="2.2.2" data-path="day-2.html"><a href="day-2.html#areal-data"><i class="fa fa-check"></i><b>2.2.2</b> Areal data</a></li>
<li class="chapter" data-level="2.2.3" data-path="day-2.html"><a href="day-2.html#point-process-data"><i class="fa fa-check"></i><b>2.2.3</b> Point process data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="day-3.html"><a href="day-3.html"><i class="fa fa-check"></i><b>3</b> Day 3</a><ul>
<li class="chapter" data-level="3.1" data-path="day-3.html"><a href="day-3.html#anouncements"><i class="fa fa-check"></i><b>3.1</b> Anouncements</a></li>
<li class="chapter" data-level="3.2" data-path="day-3.html"><a href="day-3.html#files-for-spatial-data"><i class="fa fa-check"></i><b>3.2</b> Files for spatial data</a></li>
<li class="chapter" data-level="3.3" data-path="day-3.html"><a href="day-3.html#textbook-package"><i class="fa fa-check"></i><b>3.3</b> Textbook package</a></li>
<li class="chapter" data-level="3.4" data-path="day-3.html"><a href="day-3.html#spatial-visualization"><i class="fa fa-check"></i><b>3.4</b> Spatial Visualization</a><ul>
<li class="chapter" data-level="3.4.1" data-path="day-3.html"><a href="day-3.html#spatial-visualization-using-fields"><i class="fa fa-check"></i><b>3.4.1</b> Spatial visualization using <em>fields</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="day-4.html"><a href="day-4.html"><i class="fa fa-check"></i><b>4</b> Day 4</a><ul>
<li class="chapter" data-level="4.1" data-path="day-4.html"><a href="day-4.html#announcements"><i class="fa fa-check"></i><b>4.1</b> Announcements</a></li>
<li class="chapter" data-level="4.2" data-path="day-4.html"><a href="day-4.html#visualization-continued"><i class="fa fa-check"></i><b>4.2</b> Visualization (continued)</a><ul>
<li class="chapter" data-level="4.2.1" data-path="day-4.html"><a href="day-4.html#spatial-visualization-using-fields-1"><i class="fa fa-check"></i><b>4.2.1</b> Spatial visualization using <em>fields</em></a></li>
<li class="chapter" data-level="4.2.2" data-path="day-4.html"><a href="day-4.html#in-class-activity"><i class="fa fa-check"></i><b>4.2.2</b> In Class Activity:</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="day-4.html"><a href="day-4.html#interactive-visualization-interactive-with-html-format-only"><i class="fa fa-check"></i><b>4.3</b> Interactive visualization (Interactive with HTML format only)</a><ul>
<li class="chapter" data-level="4.3.1" data-path="day-4.html"><a href="day-4.html#interactive-display-of-data"><i class="fa fa-check"></i><b>4.3.1</b> Interactive display of data</a></li>
<li class="chapter" data-level="4.3.2" data-path="day-4.html"><a href="day-4.html#animations"><i class="fa fa-check"></i><b>4.3.2</b> Animations</a></li>
<li class="chapter" data-level="4.3.3" data-path="day-4.html"><a href="day-4.html#interactive-plotting-using-plotly"><i class="fa fa-check"></i><b>4.3.3</b> Interactive plotting using <em>plotly</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="day-5.html"><a href="day-5.html"><i class="fa fa-check"></i><b>5</b> Day 5</a><ul>
<li class="chapter" data-level="5.1" data-path="day-5.html"><a href="day-5.html#announcements-1"><i class="fa fa-check"></i><b>5.1</b> Announcements</a></li>
<li class="chapter" data-level="5.2" data-path="day-5.html"><a href="day-5.html#spatial-means-and-covariances"><i class="fa fa-check"></i><b>5.2</b> Spatial means and covariances</a><ul>
<li class="chapter" data-level="5.2.1" data-path="day-5.html"><a href="day-5.html#gaussian-processes"><i class="fa fa-check"></i><b>5.2.1</b> Gaussian processes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="day-6.html"><a href="day-6.html"><i class="fa fa-check"></i><b>6</b> Day 6</a><ul>
<li class="chapter" data-level="6.1" data-path="day-6.html"><a href="day-6.html#announcements-2"><i class="fa fa-check"></i><b>6.1</b> Announcements</a></li>
<li class="chapter" data-level="6.2" data-path="day-6.html"><a href="day-6.html#gaussian-process-assumptions"><i class="fa fa-check"></i><b>6.2</b> Gaussian process assumptions</a></li>
<li class="chapter" data-level="6.3" data-path="day-6.html"><a href="day-6.html#recall-hierachical-modeling"><i class="fa fa-check"></i><b>6.3</b> Recall Hierachical modeling</a><ul>
<li class="chapter" data-level="6.3.1" data-path="day-6.html"><a href="day-6.html#data-model-1"><i class="fa fa-check"></i><b>6.3.1</b> Data Model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="day-7.html"><a href="day-7.html"><i class="fa fa-check"></i><b>7</b> Day 7</a><ul>
<li class="chapter" data-level="7.1" data-path="day-7.html"><a href="day-7.html#common-isotropic-correlation-functions"><i class="fa fa-check"></i><b>7.1</b> Common isotropic correlation functions</a></li>
<li class="chapter" data-level="7.2" data-path="day-7.html"><a href="day-7.html#covariograms-and-semivariograms"><i class="fa fa-check"></i><b>7.2</b> Covariograms and semivariograms</a><ul>
<li class="chapter" data-level="7.2.1" data-path="day-7.html"><a href="day-7.html#semivariograms-and-variograms"><i class="fa fa-check"></i><b>7.2.1</b> Semivariograms and variograms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="day-8.html"><a href="day-8.html"><i class="fa fa-check"></i><b>8</b> Day 8</a><ul>
<li class="chapter" data-level="8.1" data-path="day-8.html"><a href="day-8.html#announcements-3"><i class="fa fa-check"></i><b>8.1</b> Announcements</a></li>
<li class="chapter" data-level="8.2" data-path="day-8.html"><a href="day-8.html#estimation-of-the-spatial-process"><i class="fa fa-check"></i><b>8.2</b> Estimation of the spatial process</a><ul>
<li class="chapter" data-level="8.2.1" data-path="day-8.html"><a href="day-8.html#estimation-of-the-spatial-process-using-variograms"><i class="fa fa-check"></i><b>8.2.1</b> Estimation of the spatial process using variograms</a></li>
<li class="chapter" data-level="8.2.2" data-path="day-8.html"><a href="day-8.html#maximum-likelihood"><i class="fa fa-check"></i><b>8.2.2</b> Maximum Likelihood</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="day-8.html"><a href="day-8.html#maximum-likelihood-1"><i class="fa fa-check"></i><b>8.3</b> Maximum likelihood</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="day-9.html"><a href="day-9.html"><i class="fa fa-check"></i><b>9</b> Day 9</a><ul>
<li class="chapter" data-level="9.1" data-path="day-9.html"><a href="day-9.html#announcements-4"><i class="fa fa-check"></i><b>9.1</b> Announcements</a></li>
<li class="chapter" data-level="9.2" data-path="day-9.html"><a href="day-9.html#asymptotic-properties-of-the-mle"><i class="fa fa-check"></i><b>9.2</b> Asymptotic properties of the MLE</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="day-10.html"><a href="day-10.html"><i class="fa fa-check"></i><b>10</b> Day 10</a><ul>
<li class="chapter" data-level="10.1" data-path="day-10.html"><a href="day-10.html#announcements-5"><i class="fa fa-check"></i><b>10.1</b> Announcements</a></li>
<li class="chapter" data-level="10.2" data-path="day-10.html"><a href="day-10.html#asymptotic-properties-of-the-mle-1"><i class="fa fa-check"></i><b>10.2</b> Asymptotic properties of the MLE</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="day-11.html"><a href="day-11.html"><i class="fa fa-check"></i><b>11</b> Day 11</a><ul>
<li class="chapter" data-level="11.1" data-path="day-11.html"><a href="day-11.html#announcements-6"><i class="fa fa-check"></i><b>11.1</b> Announcements</a></li>
<li class="chapter" data-level="11.2" data-path="day-11.html"><a href="day-11.html#example-spatial-analysis"><i class="fa fa-check"></i><b>11.2</b> Example spatial analysis</a></li>
<li class="chapter" data-level="11.3" data-path="day-11.html"><a href="day-11.html#spatial-model-fitting"><i class="fa fa-check"></i><b>11.3</b> Spatial model fitting</a><ul>
<li class="chapter" data-level="11.3.1" data-path="day-11.html"><a href="day-11.html#fit-the-maximum-likelihood-estimate-using-the-geor-package"><i class="fa fa-check"></i><b>11.3.1</b> Fit the maximum likelihood estimate using the <em>geoR</em> package</a></li>
<li class="chapter" data-level="11.3.2" data-path="day-11.html"><a href="day-11.html#fitting-a-spatial-model-using-the-nlme-package"><i class="fa fa-check"></i><b>11.3.2</b> Fitting a spatial model using the <em>nlme</em> package</a></li>
<li class="chapter" data-level="11.3.3" data-path="day-11.html"><a href="day-11.html#model-fitting-with-autokrige-function"><i class="fa fa-check"></i><b>11.3.3</b> model fitting with <em>autokrige</em> function</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="day-11.html"><a href="day-11.html#kriging"><i class="fa fa-check"></i><b>11.4</b> Kriging</a><ul>
<li class="chapter" data-level="11.4.1" data-path="day-11.html"><a href="day-11.html#kriging-equations-with-mean-mu-0"><i class="fa fa-check"></i><b>11.4.1</b> Kriging Equations with mean <span class="math inline">\(\mu = 0\)</span></a></li>
<li class="chapter" data-level="11.4.2" data-path="day-11.html"><a href="day-11.html#kriging-equations-with-unknown-mean"><i class="fa fa-check"></i><b>11.4.2</b> Kriging Equations with unknown mean</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="day-12.html"><a href="day-12.html"><i class="fa fa-check"></i><b>12</b> Day 12</a><ul>
<li class="chapter" data-level="12.1" data-path="day-12.html"><a href="day-12.html#announcements-7"><i class="fa fa-check"></i><b>12.1</b> Announcements</a></li>
<li class="chapter" data-level="12.2" data-path="day-12.html"><a href="day-12.html#introduction-to-mcmc"><i class="fa fa-check"></i><b>12.2</b> Introduction to MCMC</a></li>
<li class="chapter" data-level="12.3" data-path="day-12.html"><a href="day-12.html#example-simple-linear-regression"><i class="fa fa-check"></i><b>12.3</b> Example: Simple linear regression</a></li>
<li class="chapter" data-level="12.4" data-path="day-12.html"><a href="day-12.html#the-posterior-distribution"><i class="fa fa-check"></i><b>12.4</b> The posterior distribution</a><ul>
<li class="chapter" data-level="12.4.1" data-path="day-12.html"><a href="day-12.html#full-conditional-distribution-of-mu"><i class="fa fa-check"></i><b>12.4.1</b> Full conditional distribution of <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="12.4.2" data-path="day-12.html"><a href="day-12.html#full-conditional-distribution-for-beta"><i class="fa fa-check"></i><b>12.4.2</b> Full conditional distribution for <span class="math inline">\(\beta\)</span></a></li>
<li class="chapter" data-level="12.4.3" data-path="day-12.html"><a href="day-12.html#full-conditional-distribution-for-sigma2"><i class="fa fa-check"></i><b>12.4.3</b> Full conditional distribution for <span class="math inline">\(\sigma^2\)</span></a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="day-12.html"><a href="day-12.html#fitting-the-model"><i class="fa fa-check"></i><b>12.5</b> Fitting the model</a><ul>
<li class="chapter" data-level="12.5.1" data-path="day-12.html"><a href="day-12.html#general-recommendations-for-writing-mcmc-software"><i class="fa fa-check"></i><b>12.5.1</b> General recommendations for writing MCMC software</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="day-13.html"><a href="day-13.html"><i class="fa fa-check"></i><b>13</b> Day 13</a><ul>
<li class="chapter" data-level="13.1" data-path="day-13.html"><a href="day-13.html#announcements-8"><i class="fa fa-check"></i><b>13.1</b> Announcements</a></li>
<li class="chapter" data-level="13.2" data-path="day-13.html"><a href="day-13.html#the-metropolis-algorithm"><i class="fa fa-check"></i><b>13.2</b> The Metropolis Algorithm</a></li>
<li class="chapter" data-level="13.3" data-path="day-13.html"><a href="day-13.html#the-proposal-distribution"><i class="fa fa-check"></i><b>13.3</b> The proposal distribution</a></li>
<li class="chapter" data-level="13.4" data-path="day-13.html"><a href="day-13.html#the-metropolis-update"><i class="fa fa-check"></i><b>13.4</b> The Metropolis update</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="day-14.html"><a href="day-14.html"><i class="fa fa-check"></i><b>14</b> Day 14</a><ul>
<li class="chapter" data-level="14.1" data-path="day-14.html"><a href="day-14.html#announcements-9"><i class="fa fa-check"></i><b>14.1</b> Announcements</a></li>
<li class="chapter" data-level="14.2" data-path="day-14.html"><a href="day-14.html#the-metropolis-hastings-algorithm"><i class="fa fa-check"></i><b>14.2</b> The Metropolis-Hastings Algorithm</a></li>
<li class="chapter" data-level="14.3" data-path="day-14.html"><a href="day-14.html#the-metropolis-hastings-algorithm-1"><i class="fa fa-check"></i><b>14.3</b> The Metropolis-Hastings algorithm</a></li>
<li class="chapter" data-level="14.4" data-path="day-14.html"><a href="day-14.html#example-1"><i class="fa fa-check"></i><b>14.4</b> Example</a></li>
<li class="chapter" data-level="14.5" data-path="day-14.html"><a href="day-14.html#posterior"><i class="fa fa-check"></i><b>14.5</b> Posterior</a></li>
<li class="chapter" data-level="14.6" data-path="day-14.html"><a href="day-14.html#conditional-posterior-for-phi"><i class="fa fa-check"></i><b>14.6</b> Conditional posterior for <span class="math inline">\(\phi\)</span></a></li>
<li class="chapter" data-level="14.7" data-path="day-14.html"><a href="day-14.html#conditional-posterior-for-sigma2"><i class="fa fa-check"></i><b>14.7</b> Conditional posterior for <span class="math inline">\(\sigma^2\)</span></a></li>
<li class="chapter" data-level="14.8" data-path="day-14.html"><a href="day-14.html#mcmc-using-a-symmetric-proposal-metropolis"><i class="fa fa-check"></i><b>14.8</b> MCMC using a symmetric proposal (Metropolis)</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="day-15.html"><a href="day-15.html"><i class="fa fa-check"></i><b>15</b> Day 15</a><ul>
<li class="chapter" data-level="15.1" data-path="day-15.html"><a href="day-15.html#announcements-10"><i class="fa fa-check"></i><b>15.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="day-16.html"><a href="day-16.html"><i class="fa fa-check"></i><b>16</b> Day 16</a><ul>
<li class="chapter" data-level="16.1" data-path="day-16.html"><a href="day-16.html#announcements-11"><i class="fa fa-check"></i><b>16.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="day-17.html"><a href="day-17.html"><i class="fa fa-check"></i><b>17</b> Day 17</a><ul>
<li class="chapter" data-level="17.1" data-path="day-17.html"><a href="day-17.html#announcements-12"><i class="fa fa-check"></i><b>17.1</b> Announcements</a></li>
<li class="chapter" data-level="17.2" data-path="day-17.html"><a href="day-17.html#gaussian-process-representations"><i class="fa fa-check"></i><b>17.2</b> Gaussian process representations</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="day-18.html"><a href="day-18.html"><i class="fa fa-check"></i><b>18</b> Day 18</a><ul>
<li class="chapter" data-level="18.1" data-path="day-18.html"><a href="day-18.html#announcements-13"><i class="fa fa-check"></i><b>18.1</b> Announcements</a></li>
<li class="chapter" data-level="18.2" data-path="day-18.html"><a href="day-18.html#gaussian-process-representations-continued"><i class="fa fa-check"></i><b>18.2</b> Gaussian process representations continued</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="day-19.html"><a href="day-19.html"><i class="fa fa-check"></i><b>19</b> Day 19</a><ul>
<li class="chapter" data-level="19.1" data-path="day-19.html"><a href="day-19.html#announcements-14"><i class="fa fa-check"></i><b>19.1</b> Announcements</a></li>
<li class="chapter" data-level="19.2" data-path="day-19.html"><a href="day-19.html#stochastic-integration"><i class="fa fa-check"></i><b>19.2</b> Stochastic Integration</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="day-20.html"><a href="day-20.html"><i class="fa fa-check"></i><b>20</b> Day 20</a><ul>
<li class="chapter" data-level="20.1" data-path="day-20.html"><a href="day-20.html#announcements-15"><i class="fa fa-check"></i><b>20.1</b> Announcements</a></li>
<li class="chapter" data-level="20.2" data-path="day-20.html"><a href="day-20.html#spbayes-example"><i class="fa fa-check"></i><b>20.2</b> spBayes example</a></li>
<li class="chapter" data-level="20.3" data-path="day-20.html"><a href="day-20.html#global-vs.local-basis-function"><i class="fa fa-check"></i><b>20.3</b> Global vs. Local Basis function</a><ul>
<li class="chapter" data-level="20.3.1" data-path="day-20.html"><a href="day-20.html#an-example-global-basis-fourier-basis"><i class="fa fa-check"></i><b>20.3.1</b> An example global basis: Fourier Basis</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="day-20.html"><a href="day-20.html#example-local-basis"><i class="fa fa-check"></i><b>20.4</b> example local basis</a></li>
<li class="chapter" data-level="20.5" data-path="day-20.html"><a href="day-20.html#fitting-spatial-models-many-ways"><i class="fa fa-check"></i><b>20.5</b> Fitting spatial models many ways</a></li>
<li class="chapter" data-level="20.6" data-path="day-20.html"><a href="day-20.html#empirical-orthogonal-functions"><i class="fa fa-check"></i><b>20.6</b> Empirical Orthogonal Functions</a></li>
<li class="chapter" data-level="20.7" data-path="day-20.html"><a href="day-20.html#spatial-modeling-with-mgcv-package"><i class="fa fa-check"></i><b>20.7</b> Spatial modeling with <code>mgcv</code> package</a></li>
<li class="chapter" data-level="20.8" data-path="day-20.html"><a href="day-20.html#spatial-modeling-with-kernels"><i class="fa fa-check"></i><b>20.8</b> Spatial modeling with Kernels</a><ul>
<li class="chapter" data-level="20.8.1" data-path="day-20.html"><a href="day-20.html#kernel-regression-with-a-ridge-penalty"><i class="fa fa-check"></i><b>20.8.1</b> Kernel regression with a ridge penalty</a></li>
<li class="chapter" data-level="20.8.2" data-path="day-20.html"><a href="day-20.html#kernel-regression-with-a-lasso-penalty"><i class="fa fa-check"></i><b>20.8.2</b> Kernel regression with a lasso penalty</a></li>
<li class="chapter" data-level="20.8.3" data-path="day-20.html"><a href="day-20.html#truncated-kernels---local-support"><i class="fa fa-check"></i><b>20.8.3</b> Truncated Kernels - local support</a></li>
</ul></li>
<li class="chapter" data-level="20.9" data-path="day-20.html"><a href="day-20.html#sparse-vs.dense-matrix-computation"><i class="fa fa-check"></i><b>20.9</b> Sparse vs. Dense matrix computation</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="day-21.html"><a href="day-21.html"><i class="fa fa-check"></i><b>21</b> Day 21</a><ul>
<li class="chapter" data-level="21.1" data-path="day-21.html"><a href="day-21.html#announcements-16"><i class="fa fa-check"></i><b>21.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="day-22.html"><a href="day-22.html"><i class="fa fa-check"></i><b>22</b> Day 22</a><ul>
<li class="chapter" data-level="22.1" data-path="day-22.html"><a href="day-22.html#announcements-17"><i class="fa fa-check"></i><b>22.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="day-23.html"><a href="day-23.html"><i class="fa fa-check"></i><b>23</b> Day 23</a><ul>
<li class="chapter" data-level="23.1" data-path="day-23.html"><a href="day-23.html#announcements-18"><i class="fa fa-check"></i><b>23.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html"><i class="fa fa-check"></i><b>24</b> Day 24 – Scaling GPs for large data</a><ul>
<li class="chapter" data-level="24.1" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#announcements-19"><i class="fa fa-check"></i><b>24.1</b> Announcements</a></li>
<li class="chapter" data-level="24.2" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#local-analysis"><i class="fa fa-check"></i><b>24.2</b> Local analysis</a></li>
<li class="chapter" data-level="24.3" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#low-rank-approimxations"><i class="fa fa-check"></i><b>24.3</b> Low rank approimxations</a></li>
<li class="chapter" data-level="24.4" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#spectral-basis-functions"><i class="fa fa-check"></i><b>24.4</b> Spectral basis functions</a></li>
<li class="chapter" data-level="24.5" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#kernel-convolutions"><i class="fa fa-check"></i><b>24.5</b> Kernel convolutions</a></li>
</ul></li>
<li class="chapter" data-level="25" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html"><i class="fa fa-check"></i><b>25</b> Day 25 – Scaling GPs for large data</a><ul>
<li class="chapter" data-level="25.1" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#announcements-20"><i class="fa fa-check"></i><b>25.1</b> Announcements</a></li>
<li class="chapter" data-level="25.2" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#gaussian-predictive-process-spbayes-package"><i class="fa fa-check"></i><b>25.2</b> <span>Gaussian Predictive Process</span> (spBayes package)</a></li>
<li class="chapter" data-level="25.3" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#sparse-matrix-routines"><i class="fa fa-check"></i><b>25.3</b> Sparse matrix routines</a></li>
<li class="chapter" data-level="25.4" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#the-stochastic-pde-approach"><i class="fa fa-check"></i><b>25.4</b> The stochastic PDE approach</a></li>
<li class="chapter" data-level="25.5" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#approximate-likelihood-methods"><i class="fa fa-check"></i><b>25.5</b> Approximate likelihood methods</a></li>
<li class="chapter" data-level="25.6" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#vecchia-approximations"><i class="fa fa-check"></i><b>25.6</b> Vecchia Approximations</a></li>
</ul></li>
<li class="chapter" data-level="26" data-path="day-26.html"><a href="day-26.html"><i class="fa fa-check"></i><b>26</b> Day 26</a><ul>
<li class="chapter" data-level="26.1" data-path="day-26.html"><a href="day-26.html#announcements-21"><i class="fa fa-check"></i><b>26.1</b> Announcements</a></li>
<li class="chapter" data-level="26.2" data-path="day-26.html"><a href="day-26.html#multivariate-data"><i class="fa fa-check"></i><b>26.2</b> Multivariate Data</a></li>
<li class="chapter" data-level="26.3" data-path="day-26.html"><a href="day-26.html#classical-multivariate-geostatistics"><i class="fa fa-check"></i><b>26.3</b> Classical Multivariate Geostatistics</a><ul>
<li class="chapter" data-level="26.3.1" data-path="day-26.html"><a href="day-26.html#cross-variograms-and-cross-covariance-functions"><i class="fa fa-check"></i><b>26.3.1</b> cross-variograms and cross-covariance functions</a></li>
<li class="chapter" data-level="26.3.2" data-path="day-26.html"><a href="day-26.html#cokriging"><i class="fa fa-check"></i><b>26.3.2</b> Cokriging</a></li>
<li class="chapter" data-level="26.3.3" data-path="day-26.html"><a href="day-26.html#linear-model-of-coregionalization"><i class="fa fa-check"></i><b>26.3.3</b> Linear Model of Coregionalization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="27" data-path="day-27.html"><a href="day-27.html"><i class="fa fa-check"></i><b>27</b> Day 27</a><ul>
<li class="chapter" data-level="27.1" data-path="day-27.html"><a href="day-27.html#announcements-22"><i class="fa fa-check"></i><b>27.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="28" data-path="day-28.html"><a href="day-28.html"><i class="fa fa-check"></i><b>28</b> Day 28</a><ul>
<li class="chapter" data-level="28.1" data-path="day-28.html"><a href="day-28.html#announcements-23"><i class="fa fa-check"></i><b>28.1</b> Announcements</a></li>
<li class="chapter" data-level="28.2" data-path="day-28.html"><a href="day-28.html#intro-to-stan"><i class="fa fa-check"></i><b>28.2</b> Intro to stan</a><ul>
<li class="chapter" data-level="28.2.1" data-path="day-28.html"><a href="day-28.html#example-linear-regression-1"><i class="fa fa-check"></i><b>28.2.1</b> Example: Linear regression</a></li>
<li class="chapter" data-level="28.2.2" data-path="day-28.html"><a href="day-28.html#example-spatial-model-in-stan"><i class="fa fa-check"></i><b>28.2.2</b> Example: Spatial model in stan</a></li>
<li class="chapter" data-level="28.2.3" data-path="day-28.html"><a href="day-28.html#example-predictive-process-model-in-stan"><i class="fa fa-check"></i><b>28.2.3</b> Example: Predictive process model in stan</a></li>
</ul></li>
<li class="chapter" data-level="28.3" data-path="day-28.html"><a href="day-28.html#stan-hints-and-tips"><i class="fa fa-check"></i><b>28.3</b> stan Hints and tips</a></li>
</ul></li>
<li class="chapter" data-level="29" data-path="day-29.html"><a href="day-29.html"><i class="fa fa-check"></i><b>29</b> Day 29</a><ul>
<li class="chapter" data-level="29.1" data-path="day-29.html"><a href="day-29.html#announcements-24"><i class="fa fa-check"></i><b>29.1</b> Announcements</a></li>
<li class="chapter" data-level="29.2" data-path="day-29.html"><a href="day-29.html#areal-data-1"><i class="fa fa-check"></i><b>29.2</b> Areal Data</a></li>
</ul></li>
<li class="chapter" data-level="30" data-path="day-30.html"><a href="day-30.html"><i class="fa fa-check"></i><b>30</b> Day 30</a><ul>
<li class="chapter" data-level="30.1" data-path="day-30.html"><a href="day-30.html#announcements-25"><i class="fa fa-check"></i><b>30.1</b> Announcements</a></li>
<li class="chapter" data-level="30.2" data-path="day-30.html"><a href="day-30.html#gaussian-markov-random-fields-gmrfs"><i class="fa fa-check"></i><b>30.2</b> Gaussian Markov random fields (GMRFs)</a><ul>
<li class="chapter" data-level="30.2.1" data-path="day-30.html"><a href="day-30.html#example-2"><i class="fa fa-check"></i><b>30.2.1</b> Example:</a></li>
</ul></li>
<li class="chapter" data-level="30.3" data-path="day-30.html"><a href="day-30.html#conditional-autoregressive-models-car-models"><i class="fa fa-check"></i><b>30.3</b> Conditional Autoregressive models (CAR models)</a><ul>
<li class="chapter" data-level="30.3.1" data-path="day-30.html"><a href="day-30.html#models-built-based-on-conditional-distributions-y_i-mathbfy_-i"><i class="fa fa-check"></i><b>30.3.1</b> Models built based on conditional distributions: <span class="math inline">\(y_i | \mathbf{y}_{-i}\)</span></a></li>
<li class="chapter" data-level="30.3.2" data-path="day-30.html"><a href="day-30.html#simultaneous-autoregressive-sar-model"><i class="fa fa-check"></i><b>30.3.2</b> Simultaneous autoregressive (SAR) model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="31" data-path="day-31.html"><a href="day-31.html"><i class="fa fa-check"></i><b>31</b> Day 31</a><ul>
<li class="chapter" data-level="31.1" data-path="day-31.html"><a href="day-31.html#announcements-26"><i class="fa fa-check"></i><b>31.1</b> Announcements</a></li>
<li class="chapter" data-level="31.2" data-path="day-31.html"><a href="day-31.html#change-of-spatial-support"><i class="fa fa-check"></i><b>31.2</b> Change of Spatial Support</a></li>
<li class="chapter" data-level="31.3" data-path="day-31.html"><a href="day-31.html#modeling-change-of-support-continuous-discrete-modeling"><i class="fa fa-check"></i><b>31.3</b> Modeling change of support – continuous-discrete modeling</a></li>
<li class="chapter" data-level="31.4" data-path="day-31.html"><a href="day-31.html#modeling-change-of-support-discrete-discrete-modeling"><i class="fa fa-check"></i><b>31.4</b> Modeling change of support – discrete-discrete modeling</a></li>
</ul></li>
<li class="chapter" data-level="32" data-path="day-32.html"><a href="day-32.html"><i class="fa fa-check"></i><b>32</b> Day 32</a><ul>
<li class="chapter" data-level="32.1" data-path="day-32.html"><a href="day-32.html#announcements-27"><i class="fa fa-check"></i><b>32.1</b> Announcements</a></li>
<li class="chapter" data-level="32.2" data-path="day-32.html"><a href="day-32.html#generalized-non-gaussian-spatial-models"><i class="fa fa-check"></i><b>32.2</b> Generalized (non-Gaussian) spatial models</a><ul>
<li class="chapter" data-level="32.2.1" data-path="day-32.html"><a href="day-32.html#generalized-linear-models-glms-for-non-spatial-data"><i class="fa fa-check"></i><b>32.2.1</b> Generalized linear models (GLMs) for non-spatial data</a></li>
<li class="chapter" data-level="32.2.2" data-path="day-32.html"><a href="day-32.html#example-binary-logistic-regression"><i class="fa fa-check"></i><b>32.2.2</b> Example: binary (logistic) regression</a></li>
<li class="chapter" data-level="32.2.3" data-path="day-32.html"><a href="day-32.html#example-poisson-count-regression"><i class="fa fa-check"></i><b>32.2.3</b> Example: Poisson (count) regression</a></li>
<li class="chapter" data-level="32.2.4" data-path="day-32.html"><a href="day-32.html#generalized-linear-models-glms-for-spatial-data"><i class="fa fa-check"></i><b>32.2.4</b> Generalized linear models (GLMs) for spatial data</a></li>
<li class="chapter" data-level="32.2.5" data-path="day-32.html"><a href="day-32.html#example-spatial-binary-logistic-regression"><i class="fa fa-check"></i><b>32.2.5</b> Example: spatial binary (logistic) regression</a></li>
<li class="chapter" data-level="32.2.6" data-path="day-32.html"><a href="day-32.html#example-spatial-poisson-count-regression"><i class="fa fa-check"></i><b>32.2.6</b> Example: spatial Poisson (count) regression</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="33" data-path="day-33.html"><a href="day-33.html"><i class="fa fa-check"></i><b>33</b> Day 33</a><ul>
<li class="chapter" data-level="33.1" data-path="day-33.html"><a href="day-33.html#announcements-28"><i class="fa fa-check"></i><b>33.1</b> Announcements</a></li>
<li class="chapter" data-level="33.2" data-path="day-33.html"><a href="day-33.html#spatio-temporal-data"><i class="fa fa-check"></i><b>33.2</b> Spatio-temporal data</a></li>
</ul></li>
<li class="chapter" data-level="34" data-path="day-34.html"><a href="day-34.html"><i class="fa fa-check"></i><b>34</b> Day 34</a><ul>
<li class="chapter" data-level="34.1" data-path="day-34.html"><a href="day-34.html#announcements-29"><i class="fa fa-check"></i><b>34.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="35" data-path="day-35.html"><a href="day-35.html"><i class="fa fa-check"></i><b>35</b> Day 35</a><ul>
<li class="chapter" data-level="35.1" data-path="day-35.html"><a href="day-35.html#announcements-30"><i class="fa fa-check"></i><b>35.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="36" data-path="day-36.html"><a href="day-36.html"><i class="fa fa-check"></i><b>36</b> Day 36</a><ul>
<li class="chapter" data-level="36.1" data-path="day-36.html"><a href="day-36.html#announcements-31"><i class="fa fa-check"></i><b>36.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="37" data-path="day-37.html"><a href="day-37.html"><i class="fa fa-check"></i><b>37</b> Day 37</a><ul>
<li class="chapter" data-level="37.1" data-path="day-37.html"><a href="day-37.html#announcements-32"><i class="fa fa-check"></i><b>37.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="38" data-path="day-38.html"><a href="day-38.html"><i class="fa fa-check"></i><b>38</b> Day 38</a><ul>
<li class="chapter" data-level="38.1" data-path="day-38.html"><a href="day-38.html#announcements-33"><i class="fa fa-check"></i><b>38.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="39" data-path="day-39.html"><a href="day-39.html"><i class="fa fa-check"></i><b>39</b> Day 39</a><ul>
<li class="chapter" data-level="39.1" data-path="day-39.html"><a href="day-39.html#announcements-34"><i class="fa fa-check"></i><b>39.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="40" data-path="day-40.html"><a href="day-40.html"><i class="fa fa-check"></i><b>40</b> Day 40</a><ul>
<li class="chapter" data-level="40.1" data-path="day-40.html"><a href="day-40.html#announcements-35"><i class="fa fa-check"></i><b>40.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="41" data-path="day-41.html"><a href="day-41.html"><i class="fa fa-check"></i><b>41</b> Day 41</a><ul>
<li class="chapter" data-level="41.1" data-path="day-41.html"><a href="day-41.html#announcements-36"><i class="fa fa-check"></i><b>41.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="42" data-path="day-42.html"><a href="day-42.html"><i class="fa fa-check"></i><b>42</b> Day 42</a><ul>
<li class="chapter" data-level="42.1" data-path="day-42.html"><a href="day-42.html#announcements-37"><i class="fa fa-check"></i><b>42.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="43" data-path="day-43.html"><a href="day-43.html"><i class="fa fa-check"></i><b>43</b> Day 43</a><ul>
<li class="chapter" data-level="43.1" data-path="day-43.html"><a href="day-43.html#announcements-38"><i class="fa fa-check"></i><b>43.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Notes for STAT 5413 - Spatial Statistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="day-20" class="section level1">
<h1><span class="header-section-number">20</span> Day 20</h1>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb282-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb282-2" data-line-number="2"><span class="kw">library</span>(STRbook)</a>
<a class="sourceLine" id="cb282-3" data-line-number="3"><span class="kw">library</span>(fields)</a>
<a class="sourceLine" id="cb282-4" data-line-number="4"><span class="kw">library</span>(mvnfast)</a>
<a class="sourceLine" id="cb282-5" data-line-number="5"><span class="kw">library</span>(fda)</a>
<a class="sourceLine" id="cb282-6" data-line-number="6"><span class="kw">library</span>(spBayes)</a>
<a class="sourceLine" id="cb282-7" data-line-number="7"><span class="kw">library</span>(coda)</a>
<a class="sourceLine" id="cb282-8" data-line-number="8"><span class="kw">library</span>(mgcv)</a>
<a class="sourceLine" id="cb282-9" data-line-number="9"><span class="kw">library</span>(glmnet)</a>
<a class="sourceLine" id="cb282-10" data-line-number="10"><span class="kw">library</span>(microbenchmark)</a></code></pre></div>
<div id="announcements-15" class="section level2">
<h2><span class="header-section-number">20.1</span> Announcements</h2>
</div>
<div id="spbayes-example" class="section level2">
<h2><span class="header-section-number">20.2</span> spBayes example</h2>
<p>Fitting a spatial model using the <code>NOAA_df_1990</code> data.frame from the <code>STRbook</code> package. We will focus on the average max temperature for July 1990.</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb283-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;NOAA_df_1990&quot;</span>)</a>
<a class="sourceLine" id="cb283-2" data-line-number="2"><span class="co">## add a factor variable for left_join</span></a>
<a class="sourceLine" id="cb283-3" data-line-number="3">NOAA_df_<span class="dv">1990</span><span class="op">$</span>id_factor &lt;-<span class="st"> </span><span class="kw">factor</span>(NOAA_df_<span class="dv">1990</span><span class="op">$</span>id)</a>
<a class="sourceLine" id="cb283-4" data-line-number="4">dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb283-5" data-line-number="5"><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb283-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(id_factor) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb283-7" data-line-number="7"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_Tmax =</span> <span class="kw">mean</span>(z)) <span class="co">#</span></a>
<a class="sourceLine" id="cb283-8" data-line-number="8"></a>
<a class="sourceLine" id="cb283-9" data-line-number="9"><span class="co">## add back in the lat/lon variables</span></a>
<a class="sourceLine" id="cb283-10" data-line-number="10">dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb283-11" data-line-number="11"><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb283-12" data-line-number="12"><span class="st">    </span><span class="kw">left_join</span>(dat, <span class="dt">by =</span> <span class="st">&quot;id_factor&quot;</span>) </a></code></pre></div>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb284-1" data-line-number="1">n.samples &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb284-2" data-line-number="2"></a>
<a class="sourceLine" id="cb284-3" data-line-number="3">starting &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">sigma.sq =</span> <span class="dv">2</span>, <span class="dt">tau.sq =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb284-4" data-line-number="4">tuning &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="fl">2.5</span>, <span class="dt">sigma.sq =</span> <span class="fl">0.1</span>, <span class="dt">tau.sq =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb284-5" data-line-number="5">p &lt;-<span class="st"> </span><span class="dv">3</span> <span class="co">## use lat and lon as predictors (plus an intercept)</span></a>
<a class="sourceLine" id="cb284-6" data-line-number="6">coords &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">cbind</span>(dat<span class="op">$</span>lon, dat<span class="op">$</span>lat))</a>
<a class="sourceLine" id="cb284-7" data-line-number="7">max_dist &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">rdist</span>(coords))</a>
<a class="sourceLine" id="cb284-8" data-line-number="8">priors &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb284-9" data-line-number="9">    <span class="dt">beta.Norm   =</span> <span class="kw">list</span>(<span class="kw">rep</span>(<span class="dv">0</span>, p), <span class="kw">diag</span>(<span class="fl">1e+06</span>, p)),</a>
<a class="sourceLine" id="cb284-10" data-line-number="10">    <span class="dt">phi.Unif    =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">100</span>),</a>
<a class="sourceLine" id="cb284-11" data-line-number="11">    <span class="dt">sigma.sq.IG =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), </a>
<a class="sourceLine" id="cb284-12" data-line-number="12">    <span class="dt">tau.sq.IG   =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb284-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb284-14" data-line-number="14">cov.model &lt;-<span class="st"> &quot;exponential&quot;</span></a>
<a class="sourceLine" id="cb284-15" data-line-number="15"></a>
<a class="sourceLine" id="cb284-16" data-line-number="16">fit_e &lt;-<span class="st"> </span><span class="kw">spLM</span>(</a>
<a class="sourceLine" id="cb284-17" data-line-number="17">    dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>lon <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>lat,</a>
<a class="sourceLine" id="cb284-18" data-line-number="18">    <span class="dt">coords    =</span> coords,</a>
<a class="sourceLine" id="cb284-19" data-line-number="19">    <span class="dt">starting  =</span> starting,</a>
<a class="sourceLine" id="cb284-20" data-line-number="20">    <span class="dt">tuning    =</span> tuning, </a>
<a class="sourceLine" id="cb284-21" data-line-number="21">    <span class="dt">priors    =</span> priors, </a>
<a class="sourceLine" id="cb284-22" data-line-number="22">    <span class="dt">cov.model =</span> cov.model, </a>
<a class="sourceLine" id="cb284-23" data-line-number="23">    <span class="dt">n.samples =</span> n.samples,</a>
<a class="sourceLine" id="cb284-24" data-line-number="24">    <span class="dt">n.report  =</span> <span class="dv">1000</span></a>
<a class="sourceLine" id="cb284-25" data-line-number="25">)</a></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the exponential spatial correlation model.
## 
## Number of MCMC samples 5000.
## 
## Priors and hyperpriors:
##  beta normal:
##  mu: 0.000   0.000   0.000   
##  cov:
##  1000000.000 0.000   0.000   
##  0.000   1000000.000 0.000   
##  0.000   0.000   1000000.000 
## 
##  sigma.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  tau.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  phi Unif hyperpriors a=0.01000 and b=100.00000
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Sampled: 1000 of 5000, 20.00%
## Report interval Metrop. Acceptance rate: 12.20%
## Overall Metrop. Acceptance rate: 12.20%
## -------------------------------------------------
## Sampled: 2000 of 5000, 40.00%
## Report interval Metrop. Acceptance rate: 8.70%
## Overall Metrop. Acceptance rate: 10.45%
## -------------------------------------------------
## Sampled: 3000 of 5000, 60.00%
## Report interval Metrop. Acceptance rate: 11.00%
## Overall Metrop. Acceptance rate: 10.63%
## -------------------------------------------------
## Sampled: 4000 of 5000, 80.00%
## Report interval Metrop. Acceptance rate: 10.40%
## Overall Metrop. Acceptance rate: 10.57%
## -------------------------------------------------
## Sampled: 5000 of 5000, 100.00%
## Report interval Metrop. Acceptance rate: 11.50%
## Overall Metrop. Acceptance rate: 10.76%
## -------------------------------------------------</code></pre>
<p>The above fits the model. However, sometimes it is hard to “tune” the model to get the desired Metropolis acceptance rate. <code>spLM</code> has an option for adaptive MCMC tuning. To enable this option, we add an <code>amcmc</code> option. We are also going to change to a Matern covarince function in the next code as well.</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb286-1" data-line-number="1">n.samples    &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb286-2" data-line-number="2">batch.length &lt;-<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb286-3" data-line-number="3">n.batch      &lt;-<span class="st"> </span>n.samples <span class="op">/</span><span class="st"> </span>batch.length</a>
<a class="sourceLine" id="cb286-4" data-line-number="4"></a>
<a class="sourceLine" id="cb286-5" data-line-number="5"><span class="co">## must add in values for the smoothness paramter nu</span></a>
<a class="sourceLine" id="cb286-6" data-line-number="6">starting &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">sigma.sq =</span> <span class="dv">2</span>, <span class="dt">tau.sq =</span> <span class="dv">2</span>, <span class="dt">nu =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb286-7" data-line-number="7">tuning &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="fl">2.5</span>, <span class="dt">sigma.sq =</span> <span class="fl">0.1</span>, <span class="dt">tau.sq =</span> <span class="fl">0.1</span>, <span class="dt">nu =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb286-8" data-line-number="8">p &lt;-<span class="st"> </span><span class="dv">3</span> <span class="co">## use lat and lon as predictors (plus an intercept)</span></a>
<a class="sourceLine" id="cb286-9" data-line-number="9">coords &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">cbind</span>(dat<span class="op">$</span>lon, dat<span class="op">$</span>lat))</a>
<a class="sourceLine" id="cb286-10" data-line-number="10">max_dist &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">rdist</span>(coords))</a>
<a class="sourceLine" id="cb286-11" data-line-number="11">priors &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb286-12" data-line-number="12">    <span class="dt">beta.Norm   =</span> <span class="kw">list</span>(<span class="kw">rep</span>(<span class="dv">0</span>, p), <span class="kw">diag</span>(<span class="fl">1e+06</span>, p)),</a>
<a class="sourceLine" id="cb286-13" data-line-number="13">    <span class="dt">phi.Unif    =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">100</span>),</a>
<a class="sourceLine" id="cb286-14" data-line-number="14">    <span class="dt">nu.Unif     =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">100</span>),</a>
<a class="sourceLine" id="cb286-15" data-line-number="15">    <span class="dt">sigma.sq.IG =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), </a>
<a class="sourceLine" id="cb286-16" data-line-number="16">    <span class="dt">tau.sq.IG   =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb286-17" data-line-number="17">)</a>
<a class="sourceLine" id="cb286-18" data-line-number="18">cov.model &lt;-<span class="st"> &quot;matern&quot;</span></a>
<a class="sourceLine" id="cb286-19" data-line-number="19"></a>
<a class="sourceLine" id="cb286-20" data-line-number="20">fit_m &lt;-<span class="st"> </span><span class="kw">spLM</span>(</a>
<a class="sourceLine" id="cb286-21" data-line-number="21">    dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>lon <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>lat,</a>
<a class="sourceLine" id="cb286-22" data-line-number="22">    <span class="dt">coords    =</span> coords,</a>
<a class="sourceLine" id="cb286-23" data-line-number="23">    <span class="dt">starting  =</span> starting,</a>
<a class="sourceLine" id="cb286-24" data-line-number="24">    <span class="dt">tuning    =</span> tuning, </a>
<a class="sourceLine" id="cb286-25" data-line-number="25">    <span class="dt">priors    =</span> priors, </a>
<a class="sourceLine" id="cb286-26" data-line-number="26">    <span class="dt">cov.model =</span> cov.model, </a>
<a class="sourceLine" id="cb286-27" data-line-number="27">    <span class="dt">n.samples =</span> n.samples,</a>
<a class="sourceLine" id="cb286-28" data-line-number="28">    <span class="dt">amcmc     =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb286-29" data-line-number="29">        <span class="dt">n.batch =</span> n.batch, </a>
<a class="sourceLine" id="cb286-30" data-line-number="30">        <span class="dt">batch.length =</span> batch.length,</a>
<a class="sourceLine" id="cb286-31" data-line-number="31">        <span class="dt">accept.rate =</span> <span class="fl">0.44</span></a>
<a class="sourceLine" id="cb286-32" data-line-number="32">    ),</a>
<a class="sourceLine" id="cb286-33" data-line-number="33">    <span class="dt">n.report  =</span> <span class="dv">10</span> <span class="co">## report every 10 adaptive batches</span></a>
<a class="sourceLine" id="cb286-34" data-line-number="34">)</a>
<a class="sourceLine" id="cb286-35" data-line-number="35"><span class="co">## can update the initial tuning parameters given the adapted values</span></a></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the matern spatial correlation model.
## 
## Using adaptive MCMC.
## 
##  Number of batches 100.
##  Batch length 50.
##  Target acceptance rate 0.44000.
## 
## Priors and hyperpriors:
##  beta normal:
##  mu: 0.000   0.000   0.000   
##  cov:
##  1000000.000 0.000   0.000   
##  0.000   1000000.000 0.000   
##  0.000   0.000   1000000.000 
## 
##  sigma.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  tau.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  phi Unif hyperpriors a=0.01000 and b=100.00000
##  nu Unif hyperpriors a=0.01000 and b=100.00000
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Batch: 10 of 100, 10.00%
##  parameter   acceptance  tuning
##  sigma.sq    46.0        0.33578
##  tau.sq      52.0        0.34949
##  phi     6.0     1.43067
##  nu      44.0        0.28613
## -------------------------------------------------
## Batch: 20 of 100, 20.00%
##  parameter   acceptance  tuning
##  sigma.sq    58.0        0.36375
##  tau.sq      48.0        0.36375
##  phi     6.0     1.29453
##  nu      86.0        0.30997
## -------------------------------------------------
## Batch: 30 of 100, 30.00%
##  parameter   acceptance  tuning
##  sigma.sq    48.0        0.39404
##  tau.sq      60.0        0.37859
##  phi     8.0     1.17134
##  nu      40.0        0.32913
## -------------------------------------------------
## Batch: 40 of 100, 40.00%
##  parameter   acceptance  tuning
##  sigma.sq    48.0        0.37859
##  tau.sq      54.0        0.41841
##  phi     12.0        1.05987
##  nu      40.0        0.29781
## -------------------------------------------------
## Batch: 50 of 100, 50.00%
##  parameter   acceptance  tuning
##  sigma.sq    42.0        0.39404
##  tau.sq      40.0        0.43549
##  phi     18.0        0.95901
##  nu      64.0        0.30997
## -------------------------------------------------
## Batch: 60 of 100, 60.00%
##  parameter   acceptance  tuning
##  sigma.sq    58.0        0.42686
##  tau.sq      38.0        0.41013
##  phi     18.0        0.86775
##  nu      56.0        0.34257
## -------------------------------------------------
## Batch: 70 of 100, 70.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.43549
##  tau.sq      64.0        0.39404
##  phi     26.0        0.78517
##  nu      66.0        0.37859
## -------------------------------------------------
## Batch: 80 of 100, 80.00%
##  parameter   acceptance  tuning
##  sigma.sq    54.0        0.45326
##  tau.sq      40.0        0.37859
##  phi     22.0        0.71045
##  nu      84.0        0.41841
## -------------------------------------------------
## Batch: 90 of 100, 90.00%
##  parameter   acceptance  tuning
##  sigma.sq    38.0        0.44428
##  tau.sq      40.0        0.38624
##  phi     22.0        0.64284
##  nu      56.0        0.46241
## -------------------------------------------------
## Batch: 100 of 100, 100.00%
##  parameter   acceptance  tuning
##  sigma.sq    42.0        0.43549
##  tau.sq      56.0        0.39404
##  phi     32.0        0.58167
##  nu      80.0        0.51105
## -------------------------------------------------</code></pre>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb288-1" data-line-number="1">tuning &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="fl">0.5</span>, <span class="dt">sigma.sq =</span> <span class="fl">0.38</span>, <span class="dt">tau.sq =</span> <span class="fl">0.6</span>, <span class="dt">nu =</span> <span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb288-2" data-line-number="2">fit_m &lt;-<span class="st"> </span><span class="kw">spLM</span>(</a>
<a class="sourceLine" id="cb288-3" data-line-number="3">    dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>lon <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>lat,</a>
<a class="sourceLine" id="cb288-4" data-line-number="4">    <span class="dt">coords    =</span> coords,</a>
<a class="sourceLine" id="cb288-5" data-line-number="5">    <span class="dt">starting  =</span> starting,</a>
<a class="sourceLine" id="cb288-6" data-line-number="6">    <span class="dt">tuning    =</span> tuning, </a>
<a class="sourceLine" id="cb288-7" data-line-number="7">    <span class="dt">priors    =</span> priors, </a>
<a class="sourceLine" id="cb288-8" data-line-number="8">    <span class="dt">cov.model =</span> cov.model, </a>
<a class="sourceLine" id="cb288-9" data-line-number="9">    <span class="dt">n.samples =</span> n.samples,</a>
<a class="sourceLine" id="cb288-10" data-line-number="10">    <span class="dt">amcmc     =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb288-11" data-line-number="11">        <span class="dt">n.batch =</span> n.batch, </a>
<a class="sourceLine" id="cb288-12" data-line-number="12">        <span class="dt">batch.length =</span> batch.length,</a>
<a class="sourceLine" id="cb288-13" data-line-number="13">        <span class="dt">accept.rate =</span> <span class="fl">0.44</span></a>
<a class="sourceLine" id="cb288-14" data-line-number="14">    ),</a>
<a class="sourceLine" id="cb288-15" data-line-number="15">    <span class="dt">n.report  =</span> <span class="dv">10</span> <span class="co">## report every 10 adaptive batches</span></a>
<a class="sourceLine" id="cb288-16" data-line-number="16">)</a>
<a class="sourceLine" id="cb288-17" data-line-number="17"><span class="co">## can update the initial tuning parameters given the adapted values</span></a></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the matern spatial correlation model.
## 
## Using adaptive MCMC.
## 
##  Number of batches 100.
##  Batch length 50.
##  Target acceptance rate 0.44000.
## 
## Priors and hyperpriors:
##  beta normal:
##  mu: 0.000   0.000   0.000   
##  cov:
##  1000000.000 0.000   0.000   
##  0.000   1000000.000 0.000   
##  0.000   0.000   1000000.000 
## 
##  sigma.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  tau.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  phi Unif hyperpriors a=0.01000 and b=100.00000
##  nu Unif hyperpriors a=0.01000 and b=100.00000
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Batch: 10 of 100, 10.00%
##  parameter   acceptance  tuning
##  sigma.sq    40.0        0.55778
##  tau.sq      28.0        0.79024
##  phi     12.0        0.63982
##  nu      24.0        0.49560
## -------------------------------------------------
## Batch: 20 of 100, 20.00%
##  parameter   acceptance  tuning
##  sigma.sq    30.0        0.51490
##  tau.sq      30.0        0.75926
##  phi     22.0        0.57893
##  nu      24.0        0.44844
## -------------------------------------------------
## Batch: 30 of 100, 30.00%
##  parameter   acceptance  tuning
##  sigma.sq    42.0        0.47531
##  tau.sq      44.0        0.71504
##  phi     32.0        0.52384
##  nu      36.0        0.42232
## -------------------------------------------------
## Batch: 40 of 100, 40.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.46590
##  tau.sq      40.0        0.70088
##  phi     26.0        0.47399
##  nu      28.0        0.38213
## -------------------------------------------------
## Batch: 50 of 100, 50.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.43008
##  tau.sq      58.0        0.71504
##  phi     18.0        0.43755
##  nu      24.0        0.34577
## -------------------------------------------------
## Batch: 60 of 100, 60.00%
##  parameter   acceptance  tuning
##  sigma.sq    40.0        0.41321
##  tau.sq      38.0        0.71504
##  phi     30.0        0.39591
##  nu      42.0        0.31286
## -------------------------------------------------
## Batch: 70 of 100, 70.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.39701
##  tau.sq      50.0        0.74422
##  phi     26.0        0.35823
##  nu      34.0        0.28881
## -------------------------------------------------
## Batch: 80 of 100, 80.00%
##  parameter   acceptance  tuning
##  sigma.sq    50.0        0.39701
##  tau.sq      32.0        0.75926
##  phi     34.0        0.33069
##  nu      46.0        0.26661
## -------------------------------------------------
## Batch: 90 of 100, 90.00%
##  parameter   acceptance  tuning
##  sigma.sq    30.0        0.38915
##  tau.sq      46.0        0.74422
##  phi     52.0        0.30527
##  nu      38.0        0.24611
## -------------------------------------------------
## Batch: 100 of 100, 100.00%
##  parameter   acceptance  tuning
##  sigma.sq    48.0        0.39701
##  tau.sq      32.0        0.72949
##  phi     28.0        0.29922
##  nu      54.0        0.26133
## -------------------------------------------------</code></pre>
<p>To get the fitted parameters, we can recover these with composition sampling.</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" data-line-number="1"><span class="co">## discard the first half of the samples as burn-in</span></a>
<a class="sourceLine" id="cb290-2" data-line-number="2">burn.in &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>n.samples</a>
<a class="sourceLine" id="cb290-3" data-line-number="3"><span class="co">## trace plots for the exponential model</span></a>
<a class="sourceLine" id="cb290-4" data-line-number="4">fit_e &lt;-<span class="st"> </span><span class="kw">spRecover</span>(fit_e, <span class="dt">start =</span> burn.in, <span class="dt">thin =</span> <span class="dv">2</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb290-5" data-line-number="5">theta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_e<span class="op">$</span>p.theta.samples, fit_e<span class="op">$</span>p.theta.samples)</a>
<a class="sourceLine" id="cb290-6" data-line-number="6"><span class="kw">plot</span>(theta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb290-7" data-line-number="7">beta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_e<span class="op">$</span>p.beta.recover.samples, fit_e<span class="op">$</span>p.beta.recover.samples)  </a>
<a class="sourceLine" id="cb290-8" data-line-number="8"><span class="kw">plot</span>(beta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-156-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-156-2.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb291-1" data-line-number="1"><span class="co">## trace plots for the matern model</span></a>
<a class="sourceLine" id="cb291-2" data-line-number="2">fit_m &lt;-<span class="st"> </span><span class="kw">spRecover</span>(fit_m, <span class="dt">start =</span> burn.in, <span class="dt">thin =</span> <span class="dv">2</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb291-3" data-line-number="3">theta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_m<span class="op">$</span>p.theta.samples, fit_m<span class="op">$</span>p.theta.samples)</a>
<a class="sourceLine" id="cb291-4" data-line-number="4"><span class="kw">plot</span>(theta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb291-5" data-line-number="5">beta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_m<span class="op">$</span>p.beta.recover.samples, fit_m<span class="op">$</span>p.beta.recover.samples)  </a>
<a class="sourceLine" id="cb291-6" data-line-number="6"><span class="kw">plot</span>(beta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb291-7" data-line-number="7"><span class="kw">round</span>(<span class="kw">summary</span>(theta.samps)<span class="op">$</span>quantiles, <span class="dv">3</span>)</a></code></pre></div>
<pre><code>##            2.5%    25%    50%    75%  97.5%
## sigma.sq 14.437 20.865 25.640 32.910 62.267
## tau.sq    0.538  1.029  1.430  1.917  3.239
## phi       0.167  0.335  0.472  0.648  1.495
## nu        0.602  0.819  1.033  1.425  4.846</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-157-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-157-2.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb293-1" data-line-number="1"><span class="co">## recover the spatial random effects</span></a>
<a class="sourceLine" id="cb293-2" data-line-number="2">fit_e_w &lt;-<span class="st"> </span>fit_e<span class="op">$</span>p.w.recover.samples</a>
<a class="sourceLine" id="cb293-3" data-line-number="3">fit_m_w &lt;-<span class="st"> </span>fit_m<span class="op">$</span>p.w.recover.samples</a>
<a class="sourceLine" id="cb293-4" data-line-number="4"></a>
<a class="sourceLine" id="cb293-5" data-line-number="5"><span class="co">## recover the spatial random effects (eta&#39;s in our class notation)</span></a>
<a class="sourceLine" id="cb293-6" data-line-number="6">w.samps &lt;-<span class="st"> </span><span class="kw">cbind</span>(fit_e_w, fit_m_w)</a>
<a class="sourceLine" id="cb293-7" data-line-number="7">w.summary &lt;-<span class="st"> </span><span class="kw">apply</span>(w.samps, <span class="dv">1</span>, <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb293-8" data-line-number="8">    <span class="kw">quantile</span>(x, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</a>
<a class="sourceLine" id="cb293-9" data-line-number="9">})</a></code></pre></div>
<p>Next we can genereate predictions for the exponential model</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" data-line-number="1">states &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;state&quot;</span>)</a>
<a class="sourceLine" id="cb294-2" data-line-number="2"></a>
<a class="sourceLine" id="cb294-3" data-line-number="3">pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</a>
<a class="sourceLine" id="cb294-4" data-line-number="4">    <span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb294-5" data-line-number="5">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </a>
<a class="sourceLine" id="cb294-6" data-line-number="6">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb294-7" data-line-number="7">    )</a>
<a class="sourceLine" id="cb294-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb294-9" data-line-number="9"><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb294-10" data-line-number="10"></a>
<a class="sourceLine" id="cb294-11" data-line-number="11"><span class="co">## predict using the tuned Matern fit</span></a>
<a class="sourceLine" id="cb294-12" data-line-number="12">preds &lt;-<span class="st"> </span><span class="kw">spPredict</span>(</a>
<a class="sourceLine" id="cb294-13" data-line-number="13">    fit_m, </a>
<a class="sourceLine" id="cb294-14" data-line-number="14">    <span class="dt">start =</span> burn.in, </a>
<a class="sourceLine" id="cb294-15" data-line-number="15">    <span class="dt">thin =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb294-16" data-line-number="16">    <span class="dt">pred.coords =</span> <span class="kw">cbind</span>(pred_coords<span class="op">$</span>lon, pred_coords<span class="op">$</span>lat), </a>
<a class="sourceLine" id="cb294-17" data-line-number="17">    <span class="dt">pred.covars =</span> <span class="kw">cbind</span>(<span class="dv">1</span>, pred_coords<span class="op">$</span>lon, pred_coords<span class="op">$</span>lat)</a>
<a class="sourceLine" id="cb294-18" data-line-number="18">)</a>
<a class="sourceLine" id="cb294-19" data-line-number="19"></a>
<a class="sourceLine" id="cb294-20" data-line-number="20"><span class="co">## Calculate the prediction means and variances</span></a>
<a class="sourceLine" id="cb294-21" data-line-number="21">pred_coords<span class="op">$</span>pred_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(preds<span class="op">$</span>p.y.predictive.samples, <span class="dv">1</span>, mean)</a>
<a class="sourceLine" id="cb294-22" data-line-number="22">pred_coords<span class="op">$</span>pred_var &lt;-<span class="st"> </span><span class="kw">apply</span>(preds<span class="op">$</span>p.y.predictive.samples, <span class="dv">1</span>, var)</a>
<a class="sourceLine" id="cb294-23" data-line-number="23"></a>
<a class="sourceLine" id="cb294-24" data-line-number="24"><span class="co">## calculate 95% credible intervals for the predictions</span></a>
<a class="sourceLine" id="cb294-25" data-line-number="25">pred.summary &lt;-<span class="st"> </span><span class="kw">apply</span>(preds<span class="op">$</span>p.y.predictive.samples, <span class="dv">1</span>, <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb294-26" data-line-number="26">    <span class="kw">quantile</span>(x, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</a>
<a class="sourceLine" id="cb294-27" data-line-number="27">})</a>
<a class="sourceLine" id="cb294-28" data-line-number="28"></a>
<a class="sourceLine" id="cb294-29" data-line-number="29"><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-30" data-line-number="30"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb294-31" data-line-number="31"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb294-32" data-line-number="32">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-33" data-line-number="33"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-34" data-line-number="34"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb294-35" data-line-number="35"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a>
<a class="sourceLine" id="cb294-36" data-line-number="36"></a>
<a class="sourceLine" id="cb294-37" data-line-number="37"></a>
<a class="sourceLine" id="cb294-38" data-line-number="38"><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_var)) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-39" data-line-number="39"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb294-40" data-line-number="40"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb294-41" data-line-number="41">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-42" data-line-number="42"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-43" data-line-number="43"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average July max Temperature prediction variance in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb294-44" data-line-number="44"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Prediction at 10000 locations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the matern spatial correlation model.
## 
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Sampled: 100 of 251, 39.44%
## Sampled: 200 of 251, 79.28%</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-159-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-159-2.png" width="480" style="display: block; margin: auto;" /></p>
<p>Note these variances are higher than the MLE estimates (potentially by a lot – link to MLE fits day 11)</p>
</div>
<div id="global-vs.local-basis-function" class="section level2">
<h2><span class="header-section-number">20.3</span> Global vs. Local Basis function</h2>
<ul>
<li>simulate some data</li>
</ul>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">44</span>)</a>
<a class="sourceLine" id="cb296-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb296-3" data-line-number="3">sigma &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb296-4" data-line-number="4">x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> n)</a>
<a class="sourceLine" id="cb296-5" data-line-number="5">Sigma &lt;-<span class="st"> </span><span class="kw">exp</span>( <span class="op">-</span><span class="st"> </span><span class="kw">rdist</span>(x)<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="fl">0.02</span>)</a>
<a class="sourceLine" id="cb296-6" data-line-number="6"></a>
<a class="sourceLine" id="cb296-7" data-line-number="7"><span class="co">## Gaussian covariance with a small amount of &quot;error&quot;</span></a>
<a class="sourceLine" id="cb296-8" data-line-number="8">mu &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rmvn</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, n), Sigma <span class="op">+</span><span class="st"> </span><span class="fl">1e-10</span> <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(n))) </a>
<a class="sourceLine" id="cb296-9" data-line-number="9">y &lt;-<span class="st"> </span>mu <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, sigma)</a>
<a class="sourceLine" id="cb296-10" data-line-number="10">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb296-11" data-line-number="11">    <span class="dt">x  =</span> x,</a>
<a class="sourceLine" id="cb296-12" data-line-number="12">    <span class="dt">y  =</span> y, </a>
<a class="sourceLine" id="cb296-13" data-line-number="13">    <span class="dt">mu =</span> mu</a>
<a class="sourceLine" id="cb296-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb296-15" data-line-number="15"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu)) <span class="op">+</span></a>
<a class="sourceLine" id="cb296-16" data-line-number="16"><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb296-17" data-line-number="17"><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y))</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-160-1.png" width="480" style="display: block; margin: auto;" /></p>
<div id="an-example-global-basis-fourier-basis" class="section level3">
<h3><span class="header-section-number">20.3.1</span> An example global basis: Fourier Basis</h3>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb297-1" data-line-number="1">make_fourier_basis &lt;-<span class="st"> </span><span class="cf">function</span>(x, num_freq) {</a>
<a class="sourceLine" id="cb297-2" data-line-number="2">    <span class="co"># if (!is.integer(num_freq)) {</span></a>
<a class="sourceLine" id="cb297-3" data-line-number="3">    <span class="co">#     stop(&quot;num_freq must be an odd integer&quot;)</span></a>
<a class="sourceLine" id="cb297-4" data-line-number="4">    <span class="co"># }</span></a>
<a class="sourceLine" id="cb297-5" data-line-number="5">    <span class="co"># if (num_freq %% 2 == 0) {</span></a>
<a class="sourceLine" id="cb297-6" data-line-number="6">    <span class="co">#     stop(&quot;num_freq must be an odd integer&quot;)</span></a>
<a class="sourceLine" id="cb297-7" data-line-number="7">    <span class="co"># }</span></a>
<a class="sourceLine" id="cb297-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb297-9" data-line-number="9">    X_fourier &lt;-<span class="st"> </span><span class="kw">cbind</span>(</a>
<a class="sourceLine" id="cb297-10" data-line-number="10">        <span class="dv">1</span>, </a>
<a class="sourceLine" id="cb297-11" data-line-number="11">        <span class="kw">do.call</span>(</a>
<a class="sourceLine" id="cb297-12" data-line-number="12">            cbind, </a>
<a class="sourceLine" id="cb297-13" data-line-number="13">            <span class="kw">sapply</span>(</a>
<a class="sourceLine" id="cb297-14" data-line-number="14">                <span class="dv">1</span><span class="op">:</span>((num_freq <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="cf">function</span>(i) { </a>
<a class="sourceLine" id="cb297-15" data-line-number="15">                    <span class="kw">cbind</span>(<span class="kw">sin</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i <span class="op">*</span><span class="st"> </span>pi <span class="op">*</span><span class="st"> </span>x), <span class="kw">cos</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i <span class="op">*</span><span class="st"> </span>pi <span class="op">*</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb297-16" data-line-number="16">                }, </a>
<a class="sourceLine" id="cb297-17" data-line-number="17">            <span class="dt">simplify =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb297-18" data-line-number="18">            )</a>
<a class="sourceLine" id="cb297-19" data-line-number="19">        )</a>
<a class="sourceLine" id="cb297-20" data-line-number="20">    )</a>
<a class="sourceLine" id="cb297-21" data-line-number="21">    </a>
<a class="sourceLine" id="cb297-22" data-line-number="22"><span class="kw">return</span>(X_fourier)</a>
<a class="sourceLine" id="cb297-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb297-24" data-line-number="24"></a>
<a class="sourceLine" id="cb297-25" data-line-number="25">X_fourier &lt;-<span class="st"> </span><span class="kw">make_fourier_basis</span>(x, <span class="dt">num_freq =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb297-26" data-line-number="26">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb297-27" data-line-number="27">    <span class="dt">x         =</span> x, </a>
<a class="sourceLine" id="cb297-28" data-line-number="28">    <span class="dt">y         =</span> y,</a>
<a class="sourceLine" id="cb297-29" data-line-number="29">    <span class="dt">mu        =</span> mu,</a>
<a class="sourceLine" id="cb297-30" data-line-number="30">    <span class="dt">X_fourier =</span> <span class="kw">c</span>(X_fourier),</a>
<a class="sourceLine" id="cb297-31" data-line-number="31">    <span class="dt">basis     =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_fourier), <span class="dt">each =</span> n))</a>
<a class="sourceLine" id="cb297-32" data-line-number="32">)</a>
<a class="sourceLine" id="cb297-33" data-line-number="33"></a>
<a class="sourceLine" id="cb297-34" data-line-number="34"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb297-35" data-line-number="35"><span class="st">    </span><span class="co"># geom_point() +</span></a>
<a class="sourceLine" id="cb297-36" data-line-number="36"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> X_fourier, <span class="dt">group =</span> basis, <span class="dt">color =</span> basis)) <span class="op">+</span></a>
<a class="sourceLine" id="cb297-37" data-line-number="37"><span class="st">    </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb297-38" data-line-number="38"><span class="st">    </span><span class="kw">theme_dark</span>()</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-161-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" data-line-number="1"><span class="co">## fit a model using the Fourier basis</span></a>
<a class="sourceLine" id="cb298-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>X_fourier <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" data-line-number="1"><span class="co">## plot the basis with fitted coefficients</span></a>
<a class="sourceLine" id="cb299-2" data-line-number="2">dat<span class="op">$</span>fitted_basis &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb299-3" data-line-number="3">    <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_fourier), <span class="cf">function</span>(i) X_fourier[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i])</a>
<a class="sourceLine" id="cb299-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb299-5" data-line-number="5"></a>
<a class="sourceLine" id="cb299-6" data-line-number="6"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb299-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb299-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> fitted_basis, <span class="dt">color =</span> basis, <span class="dt">group =</span> basis)) <span class="op">+</span></a>
<a class="sourceLine" id="cb299-9" data-line-number="9"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Weighted Fourier Basis functions&quot;</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-163-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" data-line-number="1"><span class="co">## calculate the fitted function -- the sum of the bases</span></a>
<a class="sourceLine" id="cb300-2" data-line-number="2">dat<span class="op">$</span>mu_hat &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_fourier), <span class="cf">function</span>(i) X_fourier[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i]), <span class="dv">1</span>, sum)</a>
<a class="sourceLine" id="cb300-3" data-line-number="3"></a>
<a class="sourceLine" id="cb300-4" data-line-number="4"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb300-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb300-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu_hat), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd  =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb300-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu), <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb300-8" data-line-number="8"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Fitted function vs. simulated function&quot;</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-164-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>The Fourier basis is global</li>
</ul>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb301-1" data-line-number="1"><span class="co">## only a small percentage of these values are zero</span></a>
<a class="sourceLine" id="cb301-2" data-line-number="2"><span class="kw">mean</span>(X_fourier <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
<pre><code>## [1] 4e-04</code></pre>
</div>
</div>
<div id="example-local-basis" class="section level2">
<h2><span class="header-section-number">20.4</span> example local basis</h2>
<ul>
<li><p>B-splines are piecewise polynomial functions</p></li>
<li><p>degrees of freedom are the number of functions</p>
<ul>
<li>More degrees of freedom – more “wiggly” fit – potential for overfitting</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" data-line-number="1"><span class="co">## B-splines</span></a>
<a class="sourceLine" id="cb303-2" data-line-number="2">X_bs &lt;-<span class="st"> </span><span class="kw">bs</span>(x, <span class="dt">intercept =</span> <span class="ot">TRUE</span>, <span class="dt">df =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb303-3" data-line-number="3">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb303-4" data-line-number="4">    <span class="dt">x     =</span> x, </a>
<a class="sourceLine" id="cb303-5" data-line-number="5">    <span class="dt">y     =</span> y,</a>
<a class="sourceLine" id="cb303-6" data-line-number="6">    <span class="dt">mu    =</span> mu,</a>
<a class="sourceLine" id="cb303-7" data-line-number="7">    <span class="dt">X_bs  =</span> <span class="kw">c</span>(X_bs),</a>
<a class="sourceLine" id="cb303-8" data-line-number="8">    <span class="dt">basis =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_bs), <span class="dt">each =</span> n))</a>
<a class="sourceLine" id="cb303-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb303-10" data-line-number="10"></a>
<a class="sourceLine" id="cb303-11" data-line-number="11"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-12" data-line-number="12"><span class="st">    </span><span class="co"># geom_point() +</span></a>
<a class="sourceLine" id="cb303-13" data-line-number="13"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> X_bs, <span class="dt">group =</span> basis, <span class="dt">color =</span> basis)) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-14" data-line-number="14"><span class="st">    </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-15" data-line-number="15"><span class="st">    </span><span class="kw">theme_dark</span>()</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-166-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" data-line-number="1"><span class="co">## fit a model using the B-spline basis</span></a>
<a class="sourceLine" id="cb304-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>X_bs <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" data-line-number="1"><span class="co">## plot the basis with fitted coefficients</span></a>
<a class="sourceLine" id="cb305-2" data-line-number="2">dat<span class="op">$</span>fitted_basis &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb305-3" data-line-number="3">    <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_bs), <span class="cf">function</span>(i) X_bs[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i])</a>
<a class="sourceLine" id="cb305-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb305-5" data-line-number="5"></a>
<a class="sourceLine" id="cb305-6" data-line-number="6"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb305-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb305-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> fitted_basis, <span class="dt">color =</span> basis, <span class="dt">group =</span> basis)) <span class="op">+</span></a>
<a class="sourceLine" id="cb305-9" data-line-number="9"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Weighted B-spline Basis functions&quot;</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-168-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb306-1" data-line-number="1"><span class="co">## calculate the fitted function -- the sum of the bases</span></a>
<a class="sourceLine" id="cb306-2" data-line-number="2">dat<span class="op">$</span>mu_hat &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_bs), <span class="cf">function</span>(i) X_bs[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i]), <span class="dv">1</span>, sum)</a>
<a class="sourceLine" id="cb306-3" data-line-number="3"></a>
<a class="sourceLine" id="cb306-4" data-line-number="4"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb306-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb306-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu_hat), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd  =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb306-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu), <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb306-8" data-line-number="8"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Fitted function vs. simulated function&quot;</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-169-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>The B-spline basis is local</li>
</ul>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" data-line-number="1"><span class="co">## a much larger percentage of these values are zero -- can use sparse matrix</span></a>
<a class="sourceLine" id="cb307-2" data-line-number="2"><span class="co">##     routines to solve these equations much faster</span></a>
<a class="sourceLine" id="cb307-3" data-line-number="3"><span class="kw">mean</span>(X_bs <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
<pre><code>## [1] 0.3347</code></pre>
</div>
<div id="fitting-spatial-models-many-ways" class="section level2">
<h2><span class="header-section-number">20.5</span> Fitting spatial models many ways</h2>
</div>
<div id="empirical-orthogonal-functions" class="section level2">
<h2><span class="header-section-number">20.6</span> Empirical Orthogonal Functions</h2>
<ul>
<li><p>Recall the Karhunen-Loève expansion</p></li>
<li><p>Analog for PCA for spatio-temporal data</p></li>
<li><p>Use the sea surface temperature (SST) data in <span class="citation">Wikle, Zammit-Mangion, and Cressie (<a href="#ref-wikle2019spatio">2019</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;SSTlandmask&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</a>
<a class="sourceLine" id="cb309-2" data-line-number="2"><span class="kw">data</span>(<span class="st">&quot;SSTlonlat&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>) </a>
<a class="sourceLine" id="cb309-3" data-line-number="3"><span class="kw">data</span>(<span class="st">&quot;SSTdata&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</a></code></pre></div>
<p>Delete the values of SST that are over land (e.g. <code>SSTlandmask</code> is 1)</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" data-line-number="1">delete_rows &lt;-<span class="st"> </span><span class="kw">which</span>(SSTlandmask <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb310-2" data-line-number="2">SSTdata &lt;-<span class="st"> </span>SSTdata[<span class="op">-</span>delete_rows, <span class="dv">1</span><span class="op">:</span><span class="dv">396</span>]</a></code></pre></div>
<p>The eigen decomposition of the sample covariance of the data is equivalent to the singular value decomposition of the scaled and detrended data <span class="math inline">\(\mathbf{y}\)</span>.</p>
<p><span class="math display">\[\begin{align*}
\tilde{\mathbf{y}} &amp; \equiv \frac{1}{\sqrt{T - 1}} \left( \right)
\end{align*}\]</span></p>
<p>To get a spatial EOF, we need to transform the data into space-wide format</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" data-line-number="1">y &lt;-<span class="st"> </span><span class="kw">t</span>(SSTdata)</a>
<a class="sourceLine" id="cb311-2" data-line-number="2"><span class="kw">dim</span>(y)</a></code></pre></div>
<pre><code>## [1]  396 2261</code></pre>
<p>To use the equation above, we need to calculate the spatial mean and the number of spatial replicates and scale and detrend the data</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" data-line-number="1">spatial_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(SSTdata, <span class="dv">1</span>, mean)</a>
<a class="sourceLine" id="cb313-2" data-line-number="2">nT &lt;-<span class="st"> </span><span class="kw">ncol</span>(SSTdata)</a>
<a class="sourceLine" id="cb313-3" data-line-number="3">y_tilde &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(nT <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>(y <span class="op">-</span><span class="st"> </span><span class="kw">outer</span>(<span class="kw">rep</span>(<span class="dv">1</span>, nT), spatial_mean))</a></code></pre></div>
<p>We carry out the SVD on this scaled and detrended data</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" data-line-number="1">svd_y &lt;-<span class="st"> </span><span class="kw">svd</span>(y_tilde)</a></code></pre></div>
<p>which returns a list with three elements <span class="math inline">\(\mathbf{U}\)</span> <span class="math inline">\(\mathbf{D}\)</span> <span class="math inline">\(\mathbf{V}\)</span></p>
<p><span class="math display">\[\begin{align*}
\tilde{\mathbf{y}} &amp; = \mathbf{U} \mathbf{D} \mathbf{V}
\end{align*}\]</span></p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" data-line-number="1">V &lt;-<span class="st"> </span>svd_y<span class="op">$</span>v</a>
<a class="sourceLine" id="cb315-2" data-line-number="2"><span class="kw">colnames</span>(V) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;EOF&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(SSTdata))</a>
<a class="sourceLine" id="cb315-3" data-line-number="3">EOFs &lt;-<span class="st"> </span><span class="kw">cbind</span>(SSTlonlat[ <span class="op">-</span><span class="st"> </span>delete_rows, ], V)</a>
<a class="sourceLine" id="cb315-4" data-line-number="4"><span class="kw">glimpse</span>(EOFs[, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, ])</a></code></pre></div>
<pre><code>## Rows: 2,261
## Columns: 6
## $ lon  &lt;dbl&gt; 154, 156, 158, 160, 162, 164, 166, 168, 170,…
## $ lat  &lt;dbl&gt; -29, -29, -29, -29, -29, -29, -29, -29, -29,…
## $ EOF1 &lt;dbl&gt; -0.0049151, -0.0014123, 0.0002459, 0.0014550…
## $ EOF2 &lt;dbl&gt; -1.213e-02, -2.276e-03, 2.298e-03, 2.304e-03…
## $ EOF3 &lt;dbl&gt; -0.02882, -0.02553, -0.01933, -0.01906, -0.0…
## $ EOF4 &lt;dbl&gt; 8.541e-05, 6.726e-03, 8.591e-03, 1.026e-02, …</code></pre>
<p>Plot the EOFs</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> EOFs, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> EOF1)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb317-3" data-line-number="3"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-4" data-line-number="4"><span class="st">    </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="fl">1.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-5" data-line-number="5"><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb317-6" data-line-number="6"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Longitude (deg)&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb317-7" data-line-number="7"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Latitude (deg)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-8" data-line-number="8"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;First EOF&quot;</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-177-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> EOFs, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> EOF2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb318-3" data-line-number="3"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-4" data-line-number="4"><span class="st">    </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="fl">1.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-5" data-line-number="5"><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb318-6" data-line-number="6"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Longitude (deg)&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb318-7" data-line-number="7"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Latitude (deg)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-8" data-line-number="8"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Second EOF&quot;</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-178-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>Let’s assume I have data for January 1970.</li>
</ul>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" data-line-number="1">dat &lt;-<span class="st"> </span>SST_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb319-2" data-line-number="2"><span class="st">    </span><span class="kw">subset</span>(Year <span class="op">==</span><span class="st"> </span><span class="dv">1970</span> <span class="op">&amp;</span><span class="st"> </span>Month <span class="op">==</span><span class="st"> &quot;Jan&quot;</span>)</a>
<a class="sourceLine" id="cb319-3" data-line-number="3">EOFs<span class="op">$</span>y &lt;-<span class="st"> </span>dat<span class="op">$</span>sst[ <span class="op">-</span><span class="st"> </span>delete_rows]</a></code></pre></div>
<p>Model the data using the first few EOFs as basis functions</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" data-line-number="1">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1, <span class="dt">data =</span> EOFs)</a>
<a class="sourceLine" id="cb320-2" data-line-number="2"><span class="kw">summary</span>(mod)</a>
<a class="sourceLine" id="cb320-3" data-line-number="3"><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</a>
<a class="sourceLine" id="cb320-4" data-line-number="4"><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1, data = EOFs)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.0443 -0.2771  0.0635  0.3283  1.0750 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   0.2824     0.0111    25.5   &lt;2e-16 ***
## EOF1         -7.9894     0.5259   -15.2   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.455 on 2259 degrees of freedom
## Multiple R-squared:  0.0927, Adjusted R-squared:  0.0923 
## F-statistic:  231 on 1 and 2259 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-180-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" data-line-number="1">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1 <span class="op">+</span><span class="st"> </span>EOF2 <span class="op">+</span><span class="st"> </span>EOF3 <span class="op">+</span><span class="st"> </span>EOF4 <span class="op">+</span><span class="st"> </span>EOF5, <span class="dt">data =</span> EOFs)</a>
<a class="sourceLine" id="cb322-2" data-line-number="2"><span class="kw">summary</span>(mod)</a>
<a class="sourceLine" id="cb322-3" data-line-number="3"><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</a>
<a class="sourceLine" id="cb322-4" data-line-number="4"><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1 + EOF2 + EOF3 + EOF4 + EOF5, data = EOFs)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.6775 -0.2141  0.0033  0.2330  0.8828 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -0.2095     0.0217   -9.67   &lt;2e-16 ***
## EOF1        -19.7556     0.6232  -31.70   &lt;2e-16 ***
## EOF2        -12.3421     0.6165  -20.02   &lt;2e-16 ***
## EOF3        -11.8236     0.6720  -17.59   &lt;2e-16 ***
## EOF4         11.3313     0.3695   30.67   &lt;2e-16 ***
## EOF5         13.5727     0.4285   31.67   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.346 on 2255 degrees of freedom
## Multiple R-squared:  0.474,  Adjusted R-squared:  0.473 
## F-statistic:  407 on 5 and 2255 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-181-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" data-line-number="1">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1 <span class="op">+</span><span class="st"> </span>EOF2 <span class="op">+</span><span class="st"> </span>EOF3 <span class="op">+</span><span class="st"> </span>EOF4 <span class="op">+</span><span class="st"> </span>EOF5 <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb324-2" data-line-number="2"><span class="st">              </span>EOF6 <span class="op">+</span><span class="st"> </span>EOF7 <span class="op">+</span><span class="st"> </span>EOF8 <span class="op">+</span><span class="st"> </span>EOF9 <span class="op">+</span><span class="st"> </span>EOF10, <span class="dt">data =</span> EOFs)</a>
<a class="sourceLine" id="cb324-3" data-line-number="3"><span class="kw">summary</span>(mod)</a>
<a class="sourceLine" id="cb324-4" data-line-number="4"><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</a>
<a class="sourceLine" id="cb324-5" data-line-number="5"><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1 + EOF2 + EOF3 + EOF4 + EOF5 + EOF6 + EOF7 + 
##     EOF8 + EOF9 + EOF10, data = EOFs)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -1.505 -0.210  0.009  0.228  0.968 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -0.2330     0.0229  -10.16  &lt; 2e-16 ***
## EOF1        -20.3188     0.6398  -31.76  &lt; 2e-16 ***
## EOF2        -12.8966     0.6325  -20.39  &lt; 2e-16 ***
## EOF3        -12.4496     0.6930  -17.97  &lt; 2e-16 ***
## EOF4         11.4713     0.3565   32.18  &lt; 2e-16 ***
## EOF5         13.8471     0.4241   32.65  &lt; 2e-16 ***
## EOF6         -4.1098     0.3349  -12.27  &lt; 2e-16 ***
## EOF7          1.5233     0.3294    4.62  4.0e-06 ***
## EOF8         -2.5908     0.3538   -7.32  3.4e-13 ***
## EOF9          0.4330     0.3308    1.31    0.191    
## EOF10         0.5836     0.3365    1.73    0.083 .  
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.329 on 2250 degrees of freedom
## Multiple R-squared:  0.525,  Adjusted R-squared:  0.523 
## F-statistic:  249 on 10 and 2250 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-182-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" data-line-number="1">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1 <span class="op">+</span><span class="st"> </span>EOF2 <span class="op">+</span><span class="st"> </span>EOF3 <span class="op">+</span><span class="st"> </span>EOF4 <span class="op">+</span><span class="st"> </span>EOF5 <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb326-2" data-line-number="2"><span class="st">              </span>EOF6 <span class="op">+</span><span class="st"> </span>EOF7 <span class="op">+</span><span class="st"> </span>EOF8 <span class="op">+</span><span class="st"> </span>EOF9 <span class="op">+</span><span class="st"> </span>EOF10 <span class="op">+</span></a>
<a class="sourceLine" id="cb326-3" data-line-number="3"><span class="st">              </span>EOF11 <span class="op">+</span><span class="st"> </span>EOF12 <span class="op">+</span><span class="st"> </span>EOF13 <span class="op">+</span><span class="st"> </span>EOF14 <span class="op">+</span><span class="st"> </span>EOF15 <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb326-4" data-line-number="4"><span class="st">              </span>EOF16 <span class="op">+</span><span class="st"> </span>EOF17 <span class="op">+</span><span class="st"> </span>EOF18 <span class="op">+</span><span class="st"> </span>EOF19 <span class="op">+</span><span class="st"> </span>EOF20, <span class="dt">data =</span> EOFs)</a>
<a class="sourceLine" id="cb326-5" data-line-number="5"><span class="kw">summary</span>(mod)</a>
<a class="sourceLine" id="cb326-6" data-line-number="6"><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</a>
<a class="sourceLine" id="cb326-7" data-line-number="7"><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1 + EOF2 + EOF3 + EOF4 + EOF5 + EOF6 + EOF7 + 
##     EOF8 + EOF9 + EOF10 + EOF11 + EOF12 + EOF13 + EOF14 + EOF15 + 
##     EOF16 + EOF17 + EOF18 + EOF19 + EOF20, data = EOFs)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -0.9760 -0.1509  0.0125  0.1632  0.6419 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -0.1694     0.0228   -7.44  1.4e-13 ***
## EOF1        -18.7965     0.5955  -31.56  &lt; 2e-16 ***
## EOF2        -11.3979     0.5879  -19.39  &lt; 2e-16 ***
## EOF3        -10.7575     0.6516  -16.51  &lt; 2e-16 ***
## EOF4         11.0929     0.2766   40.10  &lt; 2e-16 ***
## EOF5         13.1056     0.3585   36.55  &lt; 2e-16 ***
## EOF6         -4.2775     0.2486  -17.21  &lt; 2e-16 ***
## EOF7          1.5256     0.2412    6.32  3.1e-10 ***
## EOF8         -2.2324     0.2732   -8.17  5.0e-16 ***
## EOF9          0.3487     0.2431    1.43    0.152    
## EOF10         0.3939     0.2506    1.57    0.116    
## EOF11        -0.4529     0.2419   -1.87    0.061 .  
## EOF12        -1.6805     0.2417   -6.95  4.7e-12 ***
## EOF13         1.4899     0.2412    6.18  7.8e-10 ***
## EOF14        -1.2705     0.2442   -5.20  2.1e-07 ***
## EOF15        -1.9499     0.2422   -8.05  1.3e-15 ***
## EOF16         3.8331     0.2975   12.88  &lt; 2e-16 ***
## EOF17        -3.7016     0.2470  -14.99  &lt; 2e-16 ***
## EOF18         3.7071     0.2597   14.27  &lt; 2e-16 ***
## EOF19        -5.5411     0.2420  -22.90  &lt; 2e-16 ***
## EOF20         5.5816     0.2487   22.45  &lt; 2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.241 on 2240 degrees of freedom
## Multiple R-squared:  0.747,  Adjusted R-squared:  0.744 
## F-statistic:  330 on 20 and 2240 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-183-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li><p>Disadvantages</p>
<ul>
<li>Calculation of the SVD scales with <span class="math inline">\(O(n^3)\)</span></li>
<li>Each of the EOFs are global (almost always nonzero)</li>
</ul></li>
</ul>
</div>
<div id="spatial-modeling-with-mgcv-package" class="section level2">
<h2><span class="header-section-number">20.7</span> Spatial modeling with <code>mgcv</code> package</h2>
<p>Use the same temperature data</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;NOAA_df_1990&quot;</span>)</a>
<a class="sourceLine" id="cb328-2" data-line-number="2"><span class="co">## add a factor variable for left_join</span></a>
<a class="sourceLine" id="cb328-3" data-line-number="3">NOAA_df_<span class="dv">1990</span><span class="op">$</span>id_factor &lt;-<span class="st"> </span><span class="kw">factor</span>(NOAA_df_<span class="dv">1990</span><span class="op">$</span>id)</a>
<a class="sourceLine" id="cb328-4" data-line-number="4">dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-5" data-line-number="5"><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(id_factor) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb328-7" data-line-number="7"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_Tmax =</span> <span class="kw">mean</span>(z)) <span class="co">#</span></a>
<a class="sourceLine" id="cb328-8" data-line-number="8"></a>
<a class="sourceLine" id="cb328-9" data-line-number="9"><span class="co">## add back in the lat/lon variables</span></a>
<a class="sourceLine" id="cb328-10" data-line-number="10">dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-11" data-line-number="11"><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-12" data-line-number="12"><span class="st">    </span><span class="kw">left_join</span>(dat, <span class="dt">by =</span> <span class="st">&quot;id_factor&quot;</span>) </a>
<a class="sourceLine" id="cb328-13" data-line-number="13"></a>
<a class="sourceLine" id="cb328-14" data-line-number="14">fit &lt;-<span class="st"> </span><span class="kw">gam</span>(z <span class="op">~</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(lon, lat, <span class="dt">bs =</span> <span class="st">&quot;tp&quot;</span>, <span class="dt">k =</span> <span class="dv">30</span>), <span class="dt">data =</span> dat)</a>
<a class="sourceLine" id="cb328-15" data-line-number="15"><span class="co"># tensor product of a 2-d thin plate regression spline and 1-d cr spline  </span></a></code></pre></div>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb329-1" data-line-number="1"><span class="co">## explore model residuals</span></a>
<a class="sourceLine" id="cb329-2" data-line-number="2"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb329-3" data-line-number="3"><span class="kw">gam.check</span>(fit)</a></code></pre></div>
<pre><code>## 
## Method: GCV   Optimizer: magic
## Smoothing parameter selection converged after 5 iterations.
## The RMS GCV score gradient at convergence was 0.0005041 .
## The Hessian was positive definite.
## Model rank =  30 / 32 
## 
## Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
## indicate that k is too low, especially if edf is close to k&#39;.
## 
##            k&#39; edf k-index p-value
## s(lon,lat) 29  24    0.97     0.3</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-185-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb331-1" data-line-number="1"><span class="co">## generate model predictions</span></a>
<a class="sourceLine" id="cb331-2" data-line-number="2">pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</a>
<a class="sourceLine" id="cb331-3" data-line-number="3">    <span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb331-4" data-line-number="4">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </a>
<a class="sourceLine" id="cb331-5" data-line-number="5">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb331-6" data-line-number="6">    )</a>
<a class="sourceLine" id="cb331-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb331-8" data-line-number="8"><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb331-9" data-line-number="9"></a>
<a class="sourceLine" id="cb331-10" data-line-number="10">preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> pred_coords, <span class="dt">se.fit =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb331-11" data-line-number="11">pred_coords<span class="op">$</span>pred_mean &lt;-<span class="st"> </span>preds<span class="op">$</span>fit</a>
<a class="sourceLine" id="cb331-12" data-line-number="12">pred_coords<span class="op">$</span>pred_var &lt;-<span class="st"> </span>preds<span class="op">$</span>se.fit<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb331-13" data-line-number="13"></a>
<a class="sourceLine" id="cb331-14" data-line-number="14"><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></a>
<a class="sourceLine" id="cb331-15" data-line-number="15"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb331-16" data-line-number="16"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb331-17" data-line-number="17">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb331-18" data-line-number="18"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb331-19" data-line-number="19"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb331-20" data-line-number="20"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a>
<a class="sourceLine" id="cb331-21" data-line-number="21"></a>
<a class="sourceLine" id="cb331-22" data-line-number="22"></a>
<a class="sourceLine" id="cb331-23" data-line-number="23"><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_var)) <span class="op">+</span></a>
<a class="sourceLine" id="cb331-24" data-line-number="24"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb331-25" data-line-number="25"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb331-26" data-line-number="26">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb331-27" data-line-number="27"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb331-28" data-line-number="28"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average July max Temperature prediction variance in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb331-29" data-line-number="29"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-186-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-186-2.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="spatial-modeling-with-kernels" class="section level2">
<h2><span class="header-section-number">20.8</span> Spatial modeling with Kernels</h2>
<ul>
<li><p>Kernel functions can be either local or global</p>
<ul>
<li>Gaussian, exponential kernels are global</li>
<li>Truncated Gaussian and truncated exponential are local</li>
</ul></li>
<li><p>Kernel functions require specifying a kernel shape, a “bandwith”, and the number of “knots”.</p></li>
</ul>
<p>Use the same temperature data with Gaussian Kernels</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb332-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;NOAA_df_1990&quot;</span>)</a>
<a class="sourceLine" id="cb332-2" data-line-number="2"><span class="co">## add a factor variable for left_join</span></a>
<a class="sourceLine" id="cb332-3" data-line-number="3">NOAA_df_<span class="dv">1990</span><span class="op">$</span>id_factor &lt;-<span class="st"> </span><span class="kw">factor</span>(NOAA_df_<span class="dv">1990</span><span class="op">$</span>id)</a>
<a class="sourceLine" id="cb332-4" data-line-number="4">dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb332-5" data-line-number="5"><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb332-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(id_factor) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb332-7" data-line-number="7"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_Tmax =</span> <span class="kw">mean</span>(z)) <span class="co">#</span></a>
<a class="sourceLine" id="cb332-8" data-line-number="8"></a>
<a class="sourceLine" id="cb332-9" data-line-number="9"><span class="co">## add back in the lat/lon variables</span></a>
<a class="sourceLine" id="cb332-10" data-line-number="10">dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb332-11" data-line-number="11"><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb332-12" data-line-number="12"><span class="st">    </span><span class="kw">left_join</span>(dat, <span class="dt">by =</span> <span class="st">&quot;id_factor&quot;</span>) </a></code></pre></div>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb333-1" data-line-number="1"><span class="co">## For simplicity, assume this is a square number</span></a>
<a class="sourceLine" id="cb333-2" data-line-number="2">n_knots &lt;-<span class="st"> </span><span class="dv">25</span></a>
<a class="sourceLine" id="cb333-3" data-line-number="3">knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb333-4" data-line-number="4">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </a>
<a class="sourceLine" id="cb333-5" data-line-number="5">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</a>
<a class="sourceLine" id="cb333-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb333-7" data-line-number="7"></a>
<a class="sourceLine" id="cb333-8" data-line-number="8">make_kernel_basis &lt;-<span class="st"> </span><span class="cf">function</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> <span class="dv">1</span>, <span class="dt">threshold =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb333-9" data-line-number="9">    <span class="cf">if</span> (<span class="op">!</span>(kernel <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;exponential&quot;</span>))) {</a>
<a class="sourceLine" id="cb333-10" data-line-number="10">        <span class="kw">stop</span>(<span class="st">&quot;only kernels available are gaussian and exponential&quot;</span>)</a>
<a class="sourceLine" id="cb333-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb333-12" data-line-number="12">    D &lt;-<span class="st"> </span>fields<span class="op">::</span><span class="kw">rdist</span>(<span class="kw">as.matrix</span>(coords), <span class="kw">as.matrix</span>(knots))</a>
<a class="sourceLine" id="cb333-13" data-line-number="13">    X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="kw">nrow</span>(D), <span class="kw">ncol</span>(D))</a>
<a class="sourceLine" id="cb333-14" data-line-number="14">    <span class="cf">if</span> (kernel <span class="op">==</span><span class="st"> &quot;exponential&quot;</span>) {</a>
<a class="sourceLine" id="cb333-15" data-line-number="15">        X &lt;-<span class="st"> </span><span class="kw">exp</span> (<span class="op">-</span><span class="st"> </span>D <span class="op">/</span><span class="st"> </span>bandwith)</a>
<a class="sourceLine" id="cb333-16" data-line-number="16">    } <span class="cf">else</span> <span class="cf">if</span> (kernel <span class="op">==</span><span class="st"> &quot;gaussian&quot;</span>) {</a>
<a class="sourceLine" id="cb333-17" data-line-number="17">        X &lt;-<span class="st"> </span><span class="kw">exp</span> (<span class="op">-</span><span class="st"> </span>D<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>bandwith)</a>
<a class="sourceLine" id="cb333-18" data-line-number="18">    }</a>
<a class="sourceLine" id="cb333-19" data-line-number="19">    </a>
<a class="sourceLine" id="cb333-20" data-line-number="20">    <span class="co">## add in a minimum distance threshold</span></a>
<a class="sourceLine" id="cb333-21" data-line-number="21">    <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(threshold)) {</a>
<a class="sourceLine" id="cb333-22" data-line-number="22">        X[D <span class="op">&gt;</span><span class="st"> </span>threshold] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb333-23" data-line-number="23">    }</a>
<a class="sourceLine" id="cb333-24" data-line-number="24"></a>
<a class="sourceLine" id="cb333-25" data-line-number="25">    <span class="kw">return</span>(X)</a>
<a class="sourceLine" id="cb333-26" data-line-number="26">}</a></code></pre></div>
<p>We can plot the kernels over the domain of interest using the code below. Note that it is useful to change the bandwith parameter so that the kernel covers multiple other knots</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" data-line-number="1">coords &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat<span class="op">$</span>lon, dat<span class="op">$</span>lat)</a>
<a class="sourceLine" id="cb334-2" data-line-number="2">coords_plot &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb334-3" data-line-number="3">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </a>
<a class="sourceLine" id="cb334-4" data-line-number="4">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb334-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb334-6" data-line-number="6"><span class="kw">colnames</span>(coords_plot) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb334-7" data-line-number="7"></a>
<a class="sourceLine" id="cb334-8" data-line-number="8">X_plot &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords_plot, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb334-9" data-line-number="9"></a>
<a class="sourceLine" id="cb334-10" data-line-number="10"><span class="co">## plot the kernel basis</span></a>
<a class="sourceLine" id="cb334-11" data-line-number="11">dat_plot &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb334-12" data-line-number="12">    <span class="dt">x     =</span> coords_plot[, <span class="dv">1</span>], </a>
<a class="sourceLine" id="cb334-13" data-line-number="13">    <span class="dt">y     =</span> coords_plot[, <span class="dv">2</span>],</a>
<a class="sourceLine" id="cb334-14" data-line-number="14">    <span class="dt">X     =</span> <span class="kw">c</span>(X_plot),</a>
<a class="sourceLine" id="cb334-15" data-line-number="15">    <span class="dt">basis =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_plot), <span class="dt">each =</span> <span class="kw">nrow</span>(coords_plot)))</a>
<a class="sourceLine" id="cb334-16" data-line-number="16">)</a>
<a class="sourceLine" id="cb334-17" data-line-number="17">dat_knots &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb334-18" data-line-number="18">  <span class="dt">x =</span> knots[, <span class="dv">1</span>],</a>
<a class="sourceLine" id="cb334-19" data-line-number="19">  <span class="dt">y =</span> knots[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb334-20" data-line-number="20">)</a>
<a class="sourceLine" id="cb334-21" data-line-number="21"></a>
<a class="sourceLine" id="cb334-22" data-line-number="22"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_plot, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">fill =</span> X)) <span class="op">+</span></a>
<a class="sourceLine" id="cb334-23" data-line-number="23"><span class="st">  </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb334-24" data-line-number="24"><span class="st">  </span><span class="co"># geom(aes(x = x, y = X_fourier, group = basis, color = basis)) +</span></a>
<a class="sourceLine" id="cb334-25" data-line-number="25"><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb334-26" data-line-number="26"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb334-27" data-line-number="27"><span class="st">  </span><span class="kw">facet_wrap</span>( <span class="op">~</span><span class="st"> </span>basis, <span class="dt">ncol =</span> <span class="kw">sqrt</span>(n_knots)) <span class="op">+</span></a>
<a class="sourceLine" id="cb334-28" data-line-number="28"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Kernel Basis&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb334-29" data-line-number="29"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> dat_knots, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">0.25</span>, <span class="dt">inherit.aes =</span> <span class="ot">FALSE</span>) </a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-189-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb335-1" data-line-number="1"><span class="co">## apply the kernel basis to the data</span></a>
<a class="sourceLine" id="cb335-2" data-line-number="2">bw &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">100</span>, <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb335-3" data-line-number="3">check_AICc &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="kw">length</span>(bw)) </a>
<a class="sourceLine" id="cb335-4" data-line-number="4"><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>) {</a>
<a class="sourceLine" id="cb335-5" data-line-number="5">  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(bw)) {</a>
<a class="sourceLine" id="cb335-6" data-line-number="6">    n_knots &lt;-<span class="st"> </span>j<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb335-7" data-line-number="7">    knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb335-8" data-line-number="8">      <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </a>
<a class="sourceLine" id="cb335-9" data-line-number="9">      <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</a>
<a class="sourceLine" id="cb335-10" data-line-number="10">    )</a>
<a class="sourceLine" id="cb335-11" data-line-number="11">    X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[k])</a>
<a class="sourceLine" id="cb335-12" data-line-number="12">    <span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb335-13" data-line-number="13">    X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</a>
<a class="sourceLine" id="cb335-14" data-line-number="14">    fit &lt;-<span class="st"> </span><span class="kw">lm</span>(dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> X)</a>
<a class="sourceLine" id="cb335-15" data-line-number="15">    check_AICc[j, k] &lt;-<span class="st"> </span><span class="kw">AIC</span>(fit) <span class="op">+</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(j<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(j<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">nrow</span>(X) <span class="op">-</span><span class="st"> </span>j<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb335-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb335-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb335-18" data-line-number="18"><span class="kw">matplot</span>(check_AICc, <span class="dt">type =</span> <span class="st">&#39;p&#39;</span>)</a>
<a class="sourceLine" id="cb335-19" data-line-number="19">best_idx &lt;-<span class="st"> </span><span class="kw">which</span>(check_AICc <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(check_AICc), <span class="dt">arr.ind =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb335-20" data-line-number="20"><span class="co">## the best fitting model has 5 knots and bandwidth 20</span></a>
<a class="sourceLine" id="cb335-21" data-line-number="21">best_idx</a></code></pre></div>
<pre><code>##      row col
## [1,]   5   3</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-190-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb337-1" data-line-number="1">n_knots &lt;-<span class="st"> </span>best_idx[<span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb337-2" data-line-number="2">knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb337-3" data-line-number="3">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </a>
<a class="sourceLine" id="cb337-4" data-line-number="4">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</a>
<a class="sourceLine" id="cb337-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb337-6" data-line-number="6">X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb337-7" data-line-number="7"><span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb337-8" data-line-number="8">X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</a>
<a class="sourceLine" id="cb337-9" data-line-number="9">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> X)</a></code></pre></div>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" data-line-number="1"><span class="co">## generate model predictions</span></a>
<a class="sourceLine" id="cb338-2" data-line-number="2">pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</a>
<a class="sourceLine" id="cb338-3" data-line-number="3">    <span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb338-4" data-line-number="4">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </a>
<a class="sourceLine" id="cb338-5" data-line-number="5">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb338-6" data-line-number="6">    )</a>
<a class="sourceLine" id="cb338-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb338-8" data-line-number="8"><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb338-9" data-line-number="9">X_pred &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb338-10" data-line-number="10"><span class="kw">colnames</span>(X_pred) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb338-11" data-line-number="11">X_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X_pred)</a>
<a class="sourceLine" id="cb338-12" data-line-number="12"></a>
<a class="sourceLine" id="cb338-13" data-line-number="13">preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> X_pred, <span class="dt">se.fit =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb338-14" data-line-number="14"></a>
<a class="sourceLine" id="cb338-15" data-line-number="15">dat_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb338-16" data-line-number="16">  <span class="dt">lon       =</span> pred_coords<span class="op">$</span>lon,</a>
<a class="sourceLine" id="cb338-17" data-line-number="17">  <span class="dt">lat       =</span> pred_coords<span class="op">$</span>lat,</a>
<a class="sourceLine" id="cb338-18" data-line-number="18">  <span class="co">## prediction mean</span></a>
<a class="sourceLine" id="cb338-19" data-line-number="19">  <span class="dt">pred_mean =</span> preds<span class="op">$</span>fit,</a>
<a class="sourceLine" id="cb338-20" data-line-number="20">  <span class="co">## prediction variance</span></a>
<a class="sourceLine" id="cb338-21" data-line-number="21">  <span class="dt">pred_var  =</span> preds<span class="op">$</span>se.fit<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb338-22" data-line-number="22">)</a>
<a class="sourceLine" id="cb338-23" data-line-number="23"></a>
<a class="sourceLine" id="cb338-24" data-line-number="24"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></a>
<a class="sourceLine" id="cb338-25" data-line-number="25"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb338-26" data-line-number="26"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb338-27" data-line-number="27">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb338-28" data-line-number="28"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb338-29" data-line-number="29"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb338-30" data-line-number="30"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a>
<a class="sourceLine" id="cb338-31" data-line-number="31"></a>
<a class="sourceLine" id="cb338-32" data-line-number="32"></a>
<a class="sourceLine" id="cb338-33" data-line-number="33"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_var)) <span class="op">+</span></a>
<a class="sourceLine" id="cb338-34" data-line-number="34"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb338-35" data-line-number="35"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb338-36" data-line-number="36">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb338-37" data-line-number="37"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb338-38" data-line-number="38"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average July max Temperature prediction variance in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb338-39" data-line-number="39"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-192-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-192-2.png" width="480" style="display: block; margin: auto;" /></p>
<p>Notice that the above model is overfit – see the large variance surface. This can be resolved with penalized models (ridge, lasso, elastic net, etc). Many basis-function models show “edge effects” in the model fit. This is because at the edges of the domain there are one or two basis functions that see little data and therefore have high variability in the estimate. One can either add duplicate knots or extend the spatial domain of the knots and add a penalty term to the fit.</p>
<div id="kernel-regression-with-a-ridge-penalty" class="section level3">
<h3><span class="header-section-number">20.8.1</span> Kernel regression with a ridge penalty</h3>
<ul>
<li>Note: glmnet doesn’t have a theoretically-motivated method for calculating prediction standard errors</li>
</ul>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb339-1" data-line-number="1"><span class="co">## set alpha = 0 for ridge regression</span></a>
<a class="sourceLine" id="cb339-2" data-line-number="2">X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb339-3" data-line-number="3"><span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb339-4" data-line-number="4">X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</a>
<a class="sourceLine" id="cb339-5" data-line-number="5"></a>
<a class="sourceLine" id="cb339-6" data-line-number="6">cv_fit &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb339-7" data-line-number="7">fit &lt;-<span class="st"> </span><span class="kw">glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">0</span>, <span class="dt">lambda =</span> cv_fit<span class="op">$</span>lambda.min)</a>
<a class="sourceLine" id="cb339-8" data-line-number="8"></a>
<a class="sourceLine" id="cb339-9" data-line-number="9"><span class="co">## generate model predictions</span></a>
<a class="sourceLine" id="cb339-10" data-line-number="10">pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</a>
<a class="sourceLine" id="cb339-11" data-line-number="11">    <span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb339-12" data-line-number="12">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </a>
<a class="sourceLine" id="cb339-13" data-line-number="13">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb339-14" data-line-number="14">    )</a>
<a class="sourceLine" id="cb339-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb339-16" data-line-number="16"><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb339-17" data-line-number="17"></a>
<a class="sourceLine" id="cb339-18" data-line-number="18">X_pred &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb339-19" data-line-number="19"><span class="kw">colnames</span>(X_pred) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb339-20" data-line-number="20">X_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X_pred)</a>
<a class="sourceLine" id="cb339-21" data-line-number="21"></a>
<a class="sourceLine" id="cb339-22" data-line-number="22">preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newx =</span> <span class="kw">as.matrix</span>(X_pred))</a></code></pre></div>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" data-line-number="1">dat_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb340-2" data-line-number="2">  <span class="dt">lon       =</span> pred_coords<span class="op">$</span>lon,</a>
<a class="sourceLine" id="cb340-3" data-line-number="3">  <span class="dt">lat       =</span> pred_coords<span class="op">$</span>lat,</a>
<a class="sourceLine" id="cb340-4" data-line-number="4">  <span class="dt">pred_mean =</span> <span class="kw">c</span>(preds)</a>
<a class="sourceLine" id="cb340-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb340-6" data-line-number="6"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></a>
<a class="sourceLine" id="cb340-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb340-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb340-9" data-line-number="9">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb340-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb340-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb340-12" data-line-number="12"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-194-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="kernel-regression-with-a-lasso-penalty" class="section level3">
<h3><span class="header-section-number">20.8.2</span> Kernel regression with a lasso penalty</h3>
<ul>
<li>Note: glmnet doesn’t have a theoretically-motivated method for calculating prediction standard errors</li>
</ul>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb341-1" data-line-number="1"><span class="co">## set alpha = 1 for ridge regression</span></a>
<a class="sourceLine" id="cb341-2" data-line-number="2">X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb341-3" data-line-number="3"><span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb341-4" data-line-number="4">X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</a>
<a class="sourceLine" id="cb341-5" data-line-number="5"></a>
<a class="sourceLine" id="cb341-6" data-line-number="6">cv_fit &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb341-7" data-line-number="7">fit &lt;-<span class="st"> </span><span class="kw">glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">lambda =</span> cv_fit<span class="op">$</span>lambda.min)</a>
<a class="sourceLine" id="cb341-8" data-line-number="8"></a>
<a class="sourceLine" id="cb341-9" data-line-number="9"><span class="co">## generate model predictions</span></a>
<a class="sourceLine" id="cb341-10" data-line-number="10">pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</a>
<a class="sourceLine" id="cb341-11" data-line-number="11">    <span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb341-12" data-line-number="12">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </a>
<a class="sourceLine" id="cb341-13" data-line-number="13">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb341-14" data-line-number="14">    )</a>
<a class="sourceLine" id="cb341-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb341-16" data-line-number="16"><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb341-17" data-line-number="17"></a>
<a class="sourceLine" id="cb341-18" data-line-number="18">X_pred &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb341-19" data-line-number="19"><span class="kw">colnames</span>(X_pred) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</a>
<a class="sourceLine" id="cb341-20" data-line-number="20">X_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X_pred)</a>
<a class="sourceLine" id="cb341-21" data-line-number="21"></a>
<a class="sourceLine" id="cb341-22" data-line-number="22">preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newx =</span> <span class="kw">as.matrix</span>(X_pred))</a></code></pre></div>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" data-line-number="1">dat_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</a>
<a class="sourceLine" id="cb342-2" data-line-number="2">  <span class="dt">lon       =</span> pred_coords<span class="op">$</span>lon,</a>
<a class="sourceLine" id="cb342-3" data-line-number="3">  <span class="dt">lat       =</span> pred_coords<span class="op">$</span>lat,</a>
<a class="sourceLine" id="cb342-4" data-line-number="4">  <span class="dt">pred_mean =</span> <span class="kw">c</span>(preds)</a>
<a class="sourceLine" id="cb342-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb342-6" data-line-number="6"><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb342-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </a>
<a class="sourceLine" id="cb342-9" data-line-number="9">                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb342-12" data-line-number="12"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-196-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="truncated-kernels---local-support" class="section level3">
<h3><span class="header-section-number">20.8.3</span> Truncated Kernels - local support</h3>
<p>The kernels constructed above are globally supported (dense)</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb343-1" data-line-number="1"><span class="kw">mean</span>(X_pred <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<ul>
<li>Can use traditional kernels and truncate using a threshold</li>
</ul>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb345-1" data-line-number="1">X_threshold &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb345-2" data-line-number="2">                                 <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]], <span class="dt">threshold =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb345-3" data-line-number="3"><span class="kw">mean</span>(X_threshold <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
<pre><code>## [1] 0.473</code></pre>
<p>Can use other functions as a kernel:
- Wendland basis</p>
<p><span class="math display">\[\begin{align*}
\frac{(1 - d)^6 (35 d^2 + 18d + 3)}{3} I\{d &lt; 1\}
\end{align*}\]</span></p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb347-1" data-line-number="1">wendland_basis &lt;-<span class="st"> </span><span class="cf">function</span>(d, radius) {</a>
<a class="sourceLine" id="cb347-2" data-line-number="2">    <span class="cf">if</span> (<span class="kw">any</span>(d <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)) {</a>
<a class="sourceLine" id="cb347-3" data-line-number="3">        <span class="kw">stop</span>(<span class="st">&quot;d must be nonnegative&quot;</span>)</a>
<a class="sourceLine" id="cb347-4" data-line-number="4">    }</a>
<a class="sourceLine" id="cb347-5" data-line-number="5">    d &lt;-<span class="st"> </span>d <span class="op">/</span><span class="st"> </span>radius</a>
<a class="sourceLine" id="cb347-6" data-line-number="6">    <span class="kw">return</span>(((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">^</span><span class="dv">6</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">35</span> <span class="op">*</span><span class="st"> </span>d<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">18</span> <span class="op">*</span><span class="st"> </span>d <span class="op">+</span><span class="st"> </span><span class="dv">3</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">3</span> <span class="op">*</span><span class="st"> </span>(d <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb347-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb347-8" data-line-number="8"></a>
<a class="sourceLine" id="cb347-9" data-line-number="9"><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb347-10" data-line-number="10"><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.25</span>), <span class="dt">radius =</span> <span class="fl">0.15</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb347-11" data-line-number="11"><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.75</span>), <span class="dt">radius =</span> <span class="fl">0.15</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb347-12" data-line-number="12"><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.25</span>), <span class="dt">radius =</span> <span class="fl">0.5</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb347-13" data-line-number="13"><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.75</span>), <span class="dt">radius =</span> <span class="fl">0.5</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</a></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-199-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="sparse-vs.dense-matrix-computation" class="section level2">
<h2><span class="header-section-number">20.9</span> Sparse vs. Dense matrix computation</h2>
<ul>
<li><p>uses the <code>spam64</code> package</p></li>
<li><p>compute time of <span class="math inline">\(\mathbf{X}&#39; \mathbf{X}\)</span> for dense vs. sparse matrices</p></li>
</ul>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" data-line-number="1">coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</a>
<a class="sourceLine" id="cb348-2" data-line-number="2">    <span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb348-3" data-line-number="3">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">50</span>), </a>
<a class="sourceLine" id="cb348-4" data-line-number="4">        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb348-5" data-line-number="5">    )</a>
<a class="sourceLine" id="cb348-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb348-7" data-line-number="7"><span class="kw">colnames</span>(coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</a>
<a class="sourceLine" id="cb348-8" data-line-number="8"></a>
<a class="sourceLine" id="cb348-9" data-line-number="9">n_knots &lt;-<span class="st"> </span><span class="dv">25</span><span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb348-10" data-line-number="10">knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb348-11" data-line-number="11">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </a>
<a class="sourceLine" id="cb348-12" data-line-number="12">    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</a>
<a class="sourceLine" id="cb348-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb348-14" data-line-number="14"></a>
<a class="sourceLine" id="cb348-15" data-line-number="15">X_dense &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb348-16" data-line-number="16">                                 <span class="dt">bandwith =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb348-17" data-line-number="17">X_sparse &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb348-18" data-line-number="18">                                 <span class="dt">bandwith =</span> <span class="dv">5</span>, <span class="dt">threshold =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb348-19" data-line-number="19"><span class="kw">mean</span>(X_dense <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb348-20" data-line-number="20"><span class="kw">mean</span>(X_sparse <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb348-21" data-line-number="21"><span class="co">## convert to a sparse matrix format</span></a>
<a class="sourceLine" id="cb348-22" data-line-number="22">X_sparse &lt;-<span class="st"> </span><span class="kw">as.spam</span>(X_sparse)</a>
<a class="sourceLine" id="cb348-23" data-line-number="23"></a>
<a class="sourceLine" id="cb348-24" data-line-number="24"><span class="co">## calcuate t(X) %*% X for dense and sparse matrices</span></a>
<a class="sourceLine" id="cb348-25" data-line-number="25">bm &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(</a>
<a class="sourceLine" id="cb348-26" data-line-number="26">    <span class="kw">crossprod</span>(X_dense, X_dense),</a>
<a class="sourceLine" id="cb348-27" data-line-number="27">    <span class="kw">crossprod.spam</span>(X_sparse, X_sparse),</a>
<a class="sourceLine" id="cb348-28" data-line-number="28">    <span class="dt">times =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb348-29" data-line-number="29">)</a>
<a class="sourceLine" id="cb348-30" data-line-number="30"></a>
<a class="sourceLine" id="cb348-31" data-line-number="31">bm</a>
<a class="sourceLine" id="cb348-32" data-line-number="32"><span class="kw">plot</span>(bm)</a></code></pre></div>
<pre><code>## [1] 0
## [1] 0.7948
## Unit: milliseconds
##                                expr    min     lq   mean
##         crossprod(X_dense, X_dense) 1029.7 1030.7 1034.5
##  crossprod.spam(X_sparse, X_sparse)  139.1  139.6  140.3
##  median     uq    max neval
##  1032.1 1034.8 1055.2    10
##   140.5  140.7  141.2    10</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-200-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>almost a 10-fold speedup in computation time by using sparse matrix operations</li>
</ul>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-wikle2019spatio">
<p>Wikle, Christopher K, Andrew Zammit-Mangion, and Noel Cressie. 2019. <em>Spatio-Temporal Statistics with R</em>. CRC Press.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="day-19.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="day-21.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["STAT-5413.pdf", "STAT-5413.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
