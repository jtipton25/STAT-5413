<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>20 Day 20 | Notes for STAT 5413 - Spatial Statistics</title>
  <meta name="description" content="These are the lecture notes for STAT 5413 Spatial Statistics" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="20 Day 20 | Notes for STAT 5413 - Spatial Statistics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="These are the lecture notes for STAT 5413 Spatial Statistics" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="20 Day 20 | Notes for STAT 5413 - Spatial Statistics" />
  
  <meta name="twitter:description" content="These are the lecture notes for STAT 5413 Spatial Statistics" />
  

<meta name="author" content="John Tipton" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="day-19.html"/>
<link rel="next" href="day-21.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<script src="libs/elevate-section-attrs-2.0/elevate-section-attrs.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.10/datatables.js"></script>
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.19/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<script src="libs/plotly-binding-4.9.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.49.4/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.49.4/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">STAT 5413 Spatial Statistics</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="day-1.html"><a href="day-1.html"><i class="fa fa-check"></i><b>1</b> Day 1</a>
<ul>
<li class="chapter" data-level="1.1" data-path="day-1.html"><a href="day-1.html#notation"><i class="fa fa-check"></i><b>1.1</b> Notation</a></li>
<li class="chapter" data-level="1.2" data-path="day-1.html"><a href="day-1.html#probability-distributions"><i class="fa fa-check"></i><b>1.2</b> Probability Distributions</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="day-1.html"><a href="day-1.html#example-linear-regression"><i class="fa fa-check"></i><b>1.2.1</b> Example: linear regression</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="day-1.html"><a href="day-1.html#hierarchical-modeling"><i class="fa fa-check"></i><b>1.3</b> Hierarchical modeling</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="day-1.html"><a href="day-1.html#bayesian-hierarchical-models-bhms"><i class="fa fa-check"></i><b>1.3.1</b> Bayesian Hierarchical models (BHMs)</a></li>
<li class="chapter" data-level="1.3.2" data-path="day-1.html"><a href="day-1.html#empirical-hierarchical-models-ehms"><i class="fa fa-check"></i><b>1.3.2</b> Empirical Hierarchical models (EHMs)</a></li>
<li class="chapter" data-level="1.3.3" data-path="day-1.html"><a href="day-1.html#data-model"><i class="fa fa-check"></i><b>1.3.3</b> Data Model</a></li>
<li class="chapter" data-level="1.3.4" data-path="day-1.html"><a href="day-1.html#process-model"><i class="fa fa-check"></i><b>1.3.4</b> Process Model</a></li>
<li class="chapter" data-level="1.3.5" data-path="day-1.html"><a href="day-1.html#parameter-prior-model-bmhs-only"><i class="fa fa-check"></i><b>1.3.5</b> Parameter (Prior) Model (BMHs only)</a></li>
<li class="chapter" data-level="1.3.6" data-path="day-1.html"><a href="day-1.html#posterior-distribution"><i class="fa fa-check"></i><b>1.3.6</b> Posterior Distribution</a></li>
<li class="chapter" data-level="1.3.7" data-path="day-1.html"><a href="day-1.html#scientifically-motivated-statistical-modeling"><i class="fa fa-check"></i><b>1.3.7</b> Scientifically Motivated Statistical Modeling</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="day-2.html"><a href="day-2.html"><i class="fa fa-check"></i><b>2</b> Day 2</a>
<ul>
<li class="chapter" data-level="2.1" data-path="day-2.html"><a href="day-2.html#spatial-data"><i class="fa fa-check"></i><b>2.1</b> Spatial Data</a></li>
<li class="chapter" data-level="2.2" data-path="day-2.html"><a href="day-2.html#types-of-spatial-data"><i class="fa fa-check"></i><b>2.2</b> Types of spatial data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="day-2.html"><a href="day-2.html#geostatistical-data"><i class="fa fa-check"></i><b>2.2.1</b> Geostatistical data</a></li>
<li class="chapter" data-level="2.2.2" data-path="day-2.html"><a href="day-2.html#areal-data"><i class="fa fa-check"></i><b>2.2.2</b> Areal data</a></li>
<li class="chapter" data-level="2.2.3" data-path="day-2.html"><a href="day-2.html#point-process-data"><i class="fa fa-check"></i><b>2.2.3</b> Point process data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="day-3.html"><a href="day-3.html"><i class="fa fa-check"></i><b>3</b> Day 3</a>
<ul>
<li class="chapter" data-level="3.1" data-path="day-3.html"><a href="day-3.html#anouncements"><i class="fa fa-check"></i><b>3.1</b> Anouncements</a></li>
<li class="chapter" data-level="3.2" data-path="day-3.html"><a href="day-3.html#files-for-spatial-data"><i class="fa fa-check"></i><b>3.2</b> Files for spatial data</a></li>
<li class="chapter" data-level="3.3" data-path="day-3.html"><a href="day-3.html#textbook-package"><i class="fa fa-check"></i><b>3.3</b> Textbook package</a></li>
<li class="chapter" data-level="3.4" data-path="day-3.html"><a href="day-3.html#spatial-visualization"><i class="fa fa-check"></i><b>3.4</b> Spatial Visualization</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="day-3.html"><a href="day-3.html#spatial-visualization-using-fields"><i class="fa fa-check"></i><b>3.4.1</b> Spatial visualization using <em>fields</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="day-4.html"><a href="day-4.html"><i class="fa fa-check"></i><b>4</b> Day 4</a>
<ul>
<li class="chapter" data-level="4.1" data-path="day-4.html"><a href="day-4.html#announcements"><i class="fa fa-check"></i><b>4.1</b> Announcements</a></li>
<li class="chapter" data-level="4.2" data-path="day-4.html"><a href="day-4.html#visualization-continued"><i class="fa fa-check"></i><b>4.2</b> Visualization (continued)</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="day-4.html"><a href="day-4.html#spatial-visualization-using-fields-1"><i class="fa fa-check"></i><b>4.2.1</b> Spatial visualization using <em>fields</em></a></li>
<li class="chapter" data-level="4.2.2" data-path="day-4.html"><a href="day-4.html#in-class-activity"><i class="fa fa-check"></i><b>4.2.2</b> In Class Activity:</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="day-4.html"><a href="day-4.html#interactive-visualization-interactive-with-html-format-only"><i class="fa fa-check"></i><b>4.3</b> Interactive visualization (Interactive with HTML format only)</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="day-4.html"><a href="day-4.html#interactive-display-of-data"><i class="fa fa-check"></i><b>4.3.1</b> Interactive display of data</a></li>
<li class="chapter" data-level="4.3.2" data-path="day-4.html"><a href="day-4.html#animations"><i class="fa fa-check"></i><b>4.3.2</b> Animations</a></li>
<li class="chapter" data-level="4.3.3" data-path="day-4.html"><a href="day-4.html#interactive-plotting-using-plotly"><i class="fa fa-check"></i><b>4.3.3</b> Interactive plotting using <em>plotly</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="day-5.html"><a href="day-5.html"><i class="fa fa-check"></i><b>5</b> Day 5</a>
<ul>
<li class="chapter" data-level="5.1" data-path="day-5.html"><a href="day-5.html#announcements-1"><i class="fa fa-check"></i><b>5.1</b> Announcements</a></li>
<li class="chapter" data-level="5.2" data-path="day-5.html"><a href="day-5.html#spatial-means-and-covariances"><i class="fa fa-check"></i><b>5.2</b> Spatial means and covariances</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="day-5.html"><a href="day-5.html#gaussian-processes"><i class="fa fa-check"></i><b>5.2.1</b> Gaussian processes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="day-6.html"><a href="day-6.html"><i class="fa fa-check"></i><b>6</b> Day 6</a>
<ul>
<li class="chapter" data-level="6.1" data-path="day-6.html"><a href="day-6.html#announcements-2"><i class="fa fa-check"></i><b>6.1</b> Announcements</a></li>
<li class="chapter" data-level="6.2" data-path="day-6.html"><a href="day-6.html#gaussian-process-assumptions"><i class="fa fa-check"></i><b>6.2</b> Gaussian process assumptions</a></li>
<li class="chapter" data-level="6.3" data-path="day-6.html"><a href="day-6.html#recall-hierachical-modeling"><i class="fa fa-check"></i><b>6.3</b> Recall Hierachical modeling</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="day-6.html"><a href="day-6.html#data-model-1"><i class="fa fa-check"></i><b>6.3.1</b> Data Model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="day-7.html"><a href="day-7.html"><i class="fa fa-check"></i><b>7</b> Day 7</a>
<ul>
<li class="chapter" data-level="7.1" data-path="day-7.html"><a href="day-7.html#common-isotropic-correlation-functions"><i class="fa fa-check"></i><b>7.1</b> Common isotropic correlation functions</a></li>
<li class="chapter" data-level="7.2" data-path="day-7.html"><a href="day-7.html#covariograms-and-semivariograms"><i class="fa fa-check"></i><b>7.2</b> Covariograms and semivariograms</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="day-7.html"><a href="day-7.html#semivariograms-and-variograms"><i class="fa fa-check"></i><b>7.2.1</b> Semivariograms and variograms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="day-8.html"><a href="day-8.html"><i class="fa fa-check"></i><b>8</b> Day 8</a>
<ul>
<li class="chapter" data-level="8.1" data-path="day-8.html"><a href="day-8.html#announcements-3"><i class="fa fa-check"></i><b>8.1</b> Announcements</a></li>
<li class="chapter" data-level="8.2" data-path="day-8.html"><a href="day-8.html#estimation-of-the-spatial-process"><i class="fa fa-check"></i><b>8.2</b> Estimation of the spatial process</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="day-8.html"><a href="day-8.html#estimation-of-the-spatial-process-using-variograms"><i class="fa fa-check"></i><b>8.2.1</b> Estimation of the spatial process using variograms</a></li>
<li class="chapter" data-level="8.2.2" data-path="day-8.html"><a href="day-8.html#maximum-likelihood"><i class="fa fa-check"></i><b>8.2.2</b> Maximum Likelihood</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="day-8.html"><a href="day-8.html#maximum-likelihood-1"><i class="fa fa-check"></i><b>8.3</b> Maximum likelihood</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="day-9.html"><a href="day-9.html"><i class="fa fa-check"></i><b>9</b> Day 9</a>
<ul>
<li class="chapter" data-level="9.1" data-path="day-9.html"><a href="day-9.html#announcements-4"><i class="fa fa-check"></i><b>9.1</b> Announcements</a></li>
<li class="chapter" data-level="9.2" data-path="day-9.html"><a href="day-9.html#asymptotic-properties-of-the-mle"><i class="fa fa-check"></i><b>9.2</b> Asymptotic properties of the MLE</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="day-10.html"><a href="day-10.html"><i class="fa fa-check"></i><b>10</b> Day 10</a>
<ul>
<li class="chapter" data-level="10.1" data-path="day-10.html"><a href="day-10.html#announcements-5"><i class="fa fa-check"></i><b>10.1</b> Announcements</a></li>
<li class="chapter" data-level="10.2" data-path="day-10.html"><a href="day-10.html#asymptotic-properties-of-the-mle-1"><i class="fa fa-check"></i><b>10.2</b> Asymptotic properties of the MLE</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="day-11.html"><a href="day-11.html"><i class="fa fa-check"></i><b>11</b> Day 11</a>
<ul>
<li class="chapter" data-level="11.1" data-path="day-11.html"><a href="day-11.html#announcements-6"><i class="fa fa-check"></i><b>11.1</b> Announcements</a></li>
<li class="chapter" data-level="11.2" data-path="day-11.html"><a href="day-11.html#example-spatial-analysis"><i class="fa fa-check"></i><b>11.2</b> Example spatial analysis</a></li>
<li class="chapter" data-level="11.3" data-path="day-11.html"><a href="day-11.html#spatial-model-fitting"><i class="fa fa-check"></i><b>11.3</b> Spatial model fitting</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="day-11.html"><a href="day-11.html#fit-the-maximum-likelihood-estimate-using-the-geor-package"><i class="fa fa-check"></i><b>11.3.1</b> Fit the maximum likelihood estimate using the <em>geoR</em> package</a></li>
<li class="chapter" data-level="11.3.2" data-path="day-11.html"><a href="day-11.html#fitting-a-spatial-model-using-the-nlme-package"><i class="fa fa-check"></i><b>11.3.2</b> Fitting a spatial model using the <em>nlme</em> package</a></li>
<li class="chapter" data-level="11.3.3" data-path="day-11.html"><a href="day-11.html#model-fitting-with-autokrige-function"><i class="fa fa-check"></i><b>11.3.3</b> model fitting with <em>autokrige</em> function</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="day-11.html"><a href="day-11.html#kriging"><i class="fa fa-check"></i><b>11.4</b> Kriging</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="day-11.html"><a href="day-11.html#kriging-equations-with-mean-mu-0"><i class="fa fa-check"></i><b>11.4.1</b> Kriging Equations with mean <span class="math inline">\(\mu = 0\)</span></a></li>
<li class="chapter" data-level="11.4.2" data-path="day-11.html"><a href="day-11.html#kriging-equations-with-unknown-mean"><i class="fa fa-check"></i><b>11.4.2</b> Kriging Equations with unknown mean</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="day-12.html"><a href="day-12.html"><i class="fa fa-check"></i><b>12</b> Day 12</a>
<ul>
<li class="chapter" data-level="12.1" data-path="day-12.html"><a href="day-12.html#announcements-7"><i class="fa fa-check"></i><b>12.1</b> Announcements</a></li>
<li class="chapter" data-level="12.2" data-path="day-12.html"><a href="day-12.html#introduction-to-mcmc"><i class="fa fa-check"></i><b>12.2</b> Introduction to MCMC</a></li>
<li class="chapter" data-level="12.3" data-path="day-12.html"><a href="day-12.html#example-simple-linear-regression"><i class="fa fa-check"></i><b>12.3</b> Example: Simple linear regression</a></li>
<li class="chapter" data-level="12.4" data-path="day-12.html"><a href="day-12.html#the-posterior-distribution"><i class="fa fa-check"></i><b>12.4</b> The posterior distribution</a>
<ul>
<li class="chapter" data-level="12.4.1" data-path="day-12.html"><a href="day-12.html#full-conditional-distribution-of-mu"><i class="fa fa-check"></i><b>12.4.1</b> Full conditional distribution of <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="12.4.2" data-path="day-12.html"><a href="day-12.html#full-conditional-distribution-for-beta"><i class="fa fa-check"></i><b>12.4.2</b> Full conditional distribution for <span class="math inline">\(\beta\)</span></a></li>
<li class="chapter" data-level="12.4.3" data-path="day-12.html"><a href="day-12.html#full-conditional-distribution-for-sigma2"><i class="fa fa-check"></i><b>12.4.3</b> Full conditional distribution for <span class="math inline">\(\sigma^2\)</span></a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="day-12.html"><a href="day-12.html#fitting-the-model"><i class="fa fa-check"></i><b>12.5</b> Fitting the model</a>
<ul>
<li class="chapter" data-level="12.5.1" data-path="day-12.html"><a href="day-12.html#general-recommendations-for-writing-mcmc-software"><i class="fa fa-check"></i><b>12.5.1</b> General recommendations for writing MCMC software</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="day-13.html"><a href="day-13.html"><i class="fa fa-check"></i><b>13</b> Day 13</a>
<ul>
<li class="chapter" data-level="13.1" data-path="day-13.html"><a href="day-13.html#announcements-8"><i class="fa fa-check"></i><b>13.1</b> Announcements</a></li>
<li class="chapter" data-level="13.2" data-path="day-13.html"><a href="day-13.html#the-metropolis-algorithm"><i class="fa fa-check"></i><b>13.2</b> The Metropolis Algorithm</a></li>
<li class="chapter" data-level="13.3" data-path="day-13.html"><a href="day-13.html#the-proposal-distribution"><i class="fa fa-check"></i><b>13.3</b> The proposal distribution</a></li>
<li class="chapter" data-level="13.4" data-path="day-13.html"><a href="day-13.html#the-metropolis-update"><i class="fa fa-check"></i><b>13.4</b> The Metropolis update</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="day-14.html"><a href="day-14.html"><i class="fa fa-check"></i><b>14</b> Day 14</a>
<ul>
<li class="chapter" data-level="14.1" data-path="day-14.html"><a href="day-14.html#announcements-9"><i class="fa fa-check"></i><b>14.1</b> Announcements</a></li>
<li class="chapter" data-level="14.2" data-path="day-14.html"><a href="day-14.html#the-metropolis-hastings-algorithm"><i class="fa fa-check"></i><b>14.2</b> The Metropolis-Hastings Algorithm</a></li>
<li class="chapter" data-level="14.3" data-path="day-14.html"><a href="day-14.html#the-metropolis-hastings-algorithm-1"><i class="fa fa-check"></i><b>14.3</b> The Metropolis-Hastings algorithm</a></li>
<li class="chapter" data-level="14.4" data-path="day-14.html"><a href="day-14.html#example-1"><i class="fa fa-check"></i><b>14.4</b> Example</a></li>
<li class="chapter" data-level="14.5" data-path="day-14.html"><a href="day-14.html#posterior"><i class="fa fa-check"></i><b>14.5</b> Posterior</a></li>
<li class="chapter" data-level="14.6" data-path="day-14.html"><a href="day-14.html#conditional-posterior-for-phi"><i class="fa fa-check"></i><b>14.6</b> Conditional posterior for <span class="math inline">\(\phi\)</span></a></li>
<li class="chapter" data-level="14.7" data-path="day-14.html"><a href="day-14.html#conditional-posterior-for-sigma2"><i class="fa fa-check"></i><b>14.7</b> Conditional posterior for <span class="math inline">\(\sigma^2\)</span></a></li>
<li class="chapter" data-level="14.8" data-path="day-14.html"><a href="day-14.html#mcmc-using-a-symmetric-proposal-metropolis"><i class="fa fa-check"></i><b>14.8</b> MCMC using a symmetric proposal (Metropolis)</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="day-15.html"><a href="day-15.html"><i class="fa fa-check"></i><b>15</b> Day 15</a>
<ul>
<li class="chapter" data-level="15.1" data-path="day-15.html"><a href="day-15.html#announcements-10"><i class="fa fa-check"></i><b>15.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="day-16.html"><a href="day-16.html"><i class="fa fa-check"></i><b>16</b> Day 16</a>
<ul>
<li class="chapter" data-level="16.1" data-path="day-16.html"><a href="day-16.html#announcements-11"><i class="fa fa-check"></i><b>16.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="day-17.html"><a href="day-17.html"><i class="fa fa-check"></i><b>17</b> Day 17</a>
<ul>
<li class="chapter" data-level="17.1" data-path="day-17.html"><a href="day-17.html#announcements-12"><i class="fa fa-check"></i><b>17.1</b> Announcements</a></li>
<li class="chapter" data-level="17.2" data-path="day-17.html"><a href="day-17.html#gaussian-process-representations"><i class="fa fa-check"></i><b>17.2</b> Gaussian process representations</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="day-18.html"><a href="day-18.html"><i class="fa fa-check"></i><b>18</b> Day 18</a>
<ul>
<li class="chapter" data-level="18.1" data-path="day-18.html"><a href="day-18.html#announcements-13"><i class="fa fa-check"></i><b>18.1</b> Announcements</a></li>
<li class="chapter" data-level="18.2" data-path="day-18.html"><a href="day-18.html#gaussian-process-representations-continued"><i class="fa fa-check"></i><b>18.2</b> Gaussian process representations continued</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="day-19.html"><a href="day-19.html"><i class="fa fa-check"></i><b>19</b> Day 19</a>
<ul>
<li class="chapter" data-level="19.1" data-path="day-19.html"><a href="day-19.html#announcements-14"><i class="fa fa-check"></i><b>19.1</b> Announcements</a></li>
<li class="chapter" data-level="19.2" data-path="day-19.html"><a href="day-19.html#stochastic-integration"><i class="fa fa-check"></i><b>19.2</b> Stochastic Integration</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="day-20.html"><a href="day-20.html"><i class="fa fa-check"></i><b>20</b> Day 20</a>
<ul>
<li class="chapter" data-level="20.1" data-path="day-20.html"><a href="day-20.html#announcements-15"><i class="fa fa-check"></i><b>20.1</b> Announcements</a></li>
<li class="chapter" data-level="20.2" data-path="day-20.html"><a href="day-20.html#spbayes-example"><i class="fa fa-check"></i><b>20.2</b> spBayes example</a></li>
<li class="chapter" data-level="20.3" data-path="day-20.html"><a href="day-20.html#global-vs.-local-basis-function"><i class="fa fa-check"></i><b>20.3</b> Global vs. Local Basis function</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="day-20.html"><a href="day-20.html#an-example-global-basis-fourier-basis"><i class="fa fa-check"></i><b>20.3.1</b> An example global basis: Fourier Basis</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="day-20.html"><a href="day-20.html#example-local-basis"><i class="fa fa-check"></i><b>20.4</b> example local basis</a></li>
<li class="chapter" data-level="20.5" data-path="day-20.html"><a href="day-20.html#fitting-spatial-models-many-ways"><i class="fa fa-check"></i><b>20.5</b> Fitting spatial models many ways</a></li>
<li class="chapter" data-level="20.6" data-path="day-20.html"><a href="day-20.html#empirical-orthogonal-functions"><i class="fa fa-check"></i><b>20.6</b> Empirical Orthogonal Functions</a></li>
<li class="chapter" data-level="20.7" data-path="day-20.html"><a href="day-20.html#spatial-modeling-with-mgcv-package"><i class="fa fa-check"></i><b>20.7</b> Spatial modeling with <code>mgcv</code> package</a></li>
<li class="chapter" data-level="20.8" data-path="day-20.html"><a href="day-20.html#spatial-modeling-with-kernels"><i class="fa fa-check"></i><b>20.8</b> Spatial modeling with Kernels</a>
<ul>
<li class="chapter" data-level="20.8.1" data-path="day-20.html"><a href="day-20.html#kernel-regression-with-a-ridge-penalty"><i class="fa fa-check"></i><b>20.8.1</b> Kernel regression with a ridge penalty</a></li>
<li class="chapter" data-level="20.8.2" data-path="day-20.html"><a href="day-20.html#kernel-regression-with-a-lasso-penalty"><i class="fa fa-check"></i><b>20.8.2</b> Kernel regression with a lasso penalty</a></li>
<li class="chapter" data-level="20.8.3" data-path="day-20.html"><a href="day-20.html#truncated-kernels---local-support"><i class="fa fa-check"></i><b>20.8.3</b> Truncated Kernels - local support</a></li>
</ul></li>
<li class="chapter" data-level="20.9" data-path="day-20.html"><a href="day-20.html#sparse-vs.-dense-matrix-computation"><i class="fa fa-check"></i><b>20.9</b> Sparse vs. Dense matrix computation</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="day-21.html"><a href="day-21.html"><i class="fa fa-check"></i><b>21</b> Day 21</a>
<ul>
<li class="chapter" data-level="21.1" data-path="day-21.html"><a href="day-21.html#announcements-16"><i class="fa fa-check"></i><b>21.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="day-22.html"><a href="day-22.html"><i class="fa fa-check"></i><b>22</b> Day 22</a>
<ul>
<li class="chapter" data-level="22.1" data-path="day-22.html"><a href="day-22.html#announcements-17"><i class="fa fa-check"></i><b>22.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="day-23.html"><a href="day-23.html"><i class="fa fa-check"></i><b>23</b> Day 23</a>
<ul>
<li class="chapter" data-level="23.1" data-path="day-23.html"><a href="day-23.html#announcements-18"><i class="fa fa-check"></i><b>23.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html"><i class="fa fa-check"></i><b>24</b> Day 24 – Scaling GPs for large data</a>
<ul>
<li class="chapter" data-level="24.1" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#announcements-19"><i class="fa fa-check"></i><b>24.1</b> Announcements</a></li>
<li class="chapter" data-level="24.2" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#local-analysis"><i class="fa fa-check"></i><b>24.2</b> Local analysis</a></li>
<li class="chapter" data-level="24.3" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#low-rank-approimxations"><i class="fa fa-check"></i><b>24.3</b> Low rank approimxations</a></li>
<li class="chapter" data-level="24.4" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#spectral-basis-functions"><i class="fa fa-check"></i><b>24.4</b> Spectral basis functions</a></li>
<li class="chapter" data-level="24.5" data-path="day-24-scaling-gps-for-large-data.html"><a href="day-24-scaling-gps-for-large-data.html#kernel-convolutions"><i class="fa fa-check"></i><b>24.5</b> Kernel convolutions</a></li>
</ul></li>
<li class="chapter" data-level="25" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html"><i class="fa fa-check"></i><b>25</b> Day 25 – Scaling GPs for large data</a>
<ul>
<li class="chapter" data-level="25.1" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#announcements-20"><i class="fa fa-check"></i><b>25.1</b> Announcements</a></li>
<li class="chapter" data-level="25.2" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#gaussian-predictive-process-spbayes-package"><i class="fa fa-check"></i><b>25.2</b> Gaussian Predictive Process (spBayes package)</a></li>
<li class="chapter" data-level="25.3" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#sparse-matrix-routines"><i class="fa fa-check"></i><b>25.3</b> Sparse matrix routines</a></li>
<li class="chapter" data-level="25.4" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#the-stochastic-pde-approach"><i class="fa fa-check"></i><b>25.4</b> The stochastic PDE approach</a></li>
<li class="chapter" data-level="25.5" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#approximate-likelihood-methods"><i class="fa fa-check"></i><b>25.5</b> Approximate likelihood methods</a></li>
<li class="chapter" data-level="25.6" data-path="day-25-scaling-gps-for-large-data.html"><a href="day-25-scaling-gps-for-large-data.html#vecchia-approximations"><i class="fa fa-check"></i><b>25.6</b> Vecchia Approximations</a></li>
</ul></li>
<li class="chapter" data-level="26" data-path="day-26.html"><a href="day-26.html"><i class="fa fa-check"></i><b>26</b> Day 26</a>
<ul>
<li class="chapter" data-level="26.1" data-path="day-26.html"><a href="day-26.html#announcements-21"><i class="fa fa-check"></i><b>26.1</b> Announcements</a></li>
<li class="chapter" data-level="26.2" data-path="day-26.html"><a href="day-26.html#multivariate-data"><i class="fa fa-check"></i><b>26.2</b> Multivariate Data</a></li>
<li class="chapter" data-level="26.3" data-path="day-26.html"><a href="day-26.html#classical-multivariate-geostatistics"><i class="fa fa-check"></i><b>26.3</b> Classical Multivariate Geostatistics</a>
<ul>
<li class="chapter" data-level="26.3.1" data-path="day-26.html"><a href="day-26.html#cross-variograms-and-cross-covariance-functions"><i class="fa fa-check"></i><b>26.3.1</b> cross-variograms and cross-covariance functions</a></li>
<li class="chapter" data-level="26.3.2" data-path="day-26.html"><a href="day-26.html#cokriging"><i class="fa fa-check"></i><b>26.3.2</b> Cokriging</a></li>
<li class="chapter" data-level="26.3.3" data-path="day-26.html"><a href="day-26.html#linear-model-of-coregionalization"><i class="fa fa-check"></i><b>26.3.3</b> Linear Model of Coregionalization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="27" data-path="day-27.html"><a href="day-27.html"><i class="fa fa-check"></i><b>27</b> Day 27</a>
<ul>
<li class="chapter" data-level="27.1" data-path="day-27.html"><a href="day-27.html#announcements-22"><i class="fa fa-check"></i><b>27.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="28" data-path="day-28.html"><a href="day-28.html"><i class="fa fa-check"></i><b>28</b> Day 28</a>
<ul>
<li class="chapter" data-level="28.1" data-path="day-28.html"><a href="day-28.html#announcements-23"><i class="fa fa-check"></i><b>28.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="29" data-path="day-29.html"><a href="day-29.html"><i class="fa fa-check"></i><b>29</b> Day 29</a>
<ul>
<li class="chapter" data-level="29.1" data-path="day-29.html"><a href="day-29.html#announcements-24"><i class="fa fa-check"></i><b>29.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="30" data-path="day-30.html"><a href="day-30.html"><i class="fa fa-check"></i><b>30</b> Day 30</a>
<ul>
<li class="chapter" data-level="30.1" data-path="day-30.html"><a href="day-30.html#announcements-25"><i class="fa fa-check"></i><b>30.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="31" data-path="day-31.html"><a href="day-31.html"><i class="fa fa-check"></i><b>31</b> Day 31</a>
<ul>
<li class="chapter" data-level="31.1" data-path="day-31.html"><a href="day-31.html#announcements-26"><i class="fa fa-check"></i><b>31.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="32" data-path="day-32.html"><a href="day-32.html"><i class="fa fa-check"></i><b>32</b> Day 32</a>
<ul>
<li class="chapter" data-level="32.1" data-path="day-32.html"><a href="day-32.html#announcements-27"><i class="fa fa-check"></i><b>32.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="33" data-path="day-33.html"><a href="day-33.html"><i class="fa fa-check"></i><b>33</b> Day 33</a>
<ul>
<li class="chapter" data-level="33.1" data-path="day-33.html"><a href="day-33.html#announcements-28"><i class="fa fa-check"></i><b>33.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="34" data-path="day-34.html"><a href="day-34.html"><i class="fa fa-check"></i><b>34</b> Day 34</a>
<ul>
<li class="chapter" data-level="34.1" data-path="day-34.html"><a href="day-34.html#announcements-29"><i class="fa fa-check"></i><b>34.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="35" data-path="day-35.html"><a href="day-35.html"><i class="fa fa-check"></i><b>35</b> Day 35</a>
<ul>
<li class="chapter" data-level="35.1" data-path="day-35.html"><a href="day-35.html#announcements-30"><i class="fa fa-check"></i><b>35.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="36" data-path="day-36.html"><a href="day-36.html"><i class="fa fa-check"></i><b>36</b> Day 36</a>
<ul>
<li class="chapter" data-level="36.1" data-path="day-36.html"><a href="day-36.html#announcements-31"><i class="fa fa-check"></i><b>36.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="37" data-path="day-37.html"><a href="day-37.html"><i class="fa fa-check"></i><b>37</b> Day 37</a>
<ul>
<li class="chapter" data-level="37.1" data-path="day-37.html"><a href="day-37.html#announcements-32"><i class="fa fa-check"></i><b>37.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="38" data-path="day-38.html"><a href="day-38.html"><i class="fa fa-check"></i><b>38</b> Day 38</a>
<ul>
<li class="chapter" data-level="38.1" data-path="day-38.html"><a href="day-38.html#announcements-33"><i class="fa fa-check"></i><b>38.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="39" data-path="day-39.html"><a href="day-39.html"><i class="fa fa-check"></i><b>39</b> Day 39</a>
<ul>
<li class="chapter" data-level="39.1" data-path="day-39.html"><a href="day-39.html#announcements-34"><i class="fa fa-check"></i><b>39.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="40" data-path="day-40.html"><a href="day-40.html"><i class="fa fa-check"></i><b>40</b> Day 40</a>
<ul>
<li class="chapter" data-level="40.1" data-path="day-40.html"><a href="day-40.html#announcements-35"><i class="fa fa-check"></i><b>40.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="41" data-path="day-41.html"><a href="day-41.html"><i class="fa fa-check"></i><b>41</b> Day 41</a>
<ul>
<li class="chapter" data-level="41.1" data-path="day-41.html"><a href="day-41.html#announcements-36"><i class="fa fa-check"></i><b>41.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="42" data-path="day-42.html"><a href="day-42.html"><i class="fa fa-check"></i><b>42</b> Day 42</a>
<ul>
<li class="chapter" data-level="42.1" data-path="day-42.html"><a href="day-42.html#announcements-37"><i class="fa fa-check"></i><b>42.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="43" data-path="day-43.html"><a href="day-43.html"><i class="fa fa-check"></i><b>43</b> Day 43</a>
<ul>
<li class="chapter" data-level="43.1" data-path="day-43.html"><a href="day-43.html#announcements-38"><i class="fa fa-check"></i><b>43.1</b> Announcements</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Notes for STAT 5413 - Spatial Statistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="day-20" class="section level1" number="20">
<h1 number="20"><span class="header-section-number">20</span> Day 20</h1>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="day-20.html#cb280-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb280-2"><a href="day-20.html#cb280-2"></a><span class="kw">library</span>(STRbook)</span>
<span id="cb280-3"><a href="day-20.html#cb280-3"></a><span class="kw">library</span>(fields)</span>
<span id="cb280-4"><a href="day-20.html#cb280-4"></a><span class="kw">library</span>(mvnfast)</span>
<span id="cb280-5"><a href="day-20.html#cb280-5"></a><span class="kw">library</span>(fda)</span>
<span id="cb280-6"><a href="day-20.html#cb280-6"></a><span class="kw">library</span>(spBayes)</span>
<span id="cb280-7"><a href="day-20.html#cb280-7"></a><span class="kw">library</span>(coda)</span>
<span id="cb280-8"><a href="day-20.html#cb280-8"></a><span class="kw">library</span>(mgcv)</span>
<span id="cb280-9"><a href="day-20.html#cb280-9"></a><span class="kw">library</span>(glmnet)</span>
<span id="cb280-10"><a href="day-20.html#cb280-10"></a><span class="kw">library</span>(microbenchmark)</span></code></pre></div>
<div id="announcements-15" class="section level2" number="20.1">
<h2 number="20.1"><span class="header-section-number">20.1</span> Announcements</h2>
</div>
<div id="spbayes-example" class="section level2" number="20.2">
<h2 number="20.2"><span class="header-section-number">20.2</span> spBayes example</h2>
<p>Fitting a spatial model using the <code>NOAA_df_1990</code> data.frame from the <code>STRbook</code> package. We will focus on the average max temperature for July 1990.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="day-20.html#cb281-1"></a><span class="kw">data</span>(<span class="st">&quot;NOAA_df_1990&quot;</span>)</span>
<span id="cb281-2"><a href="day-20.html#cb281-2"></a><span class="co">## add a factor variable for left_join</span></span>
<span id="cb281-3"><a href="day-20.html#cb281-3"></a>NOAA_df_<span class="dv">1990</span><span class="op">$</span>id_factor &lt;-<span class="st"> </span><span class="kw">factor</span>(NOAA_df_<span class="dv">1990</span><span class="op">$</span>id)</span>
<span id="cb281-4"><a href="day-20.html#cb281-4"></a>dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></span>
<span id="cb281-5"><a href="day-20.html#cb281-5"></a><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb281-6"><a href="day-20.html#cb281-6"></a><span class="st">    </span><span class="kw">group_by</span>(id_factor) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb281-7"><a href="day-20.html#cb281-7"></a><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_Tmax =</span> <span class="kw">mean</span>(z)) <span class="co">#</span></span>
<span id="cb281-8"><a href="day-20.html#cb281-8"></a></span>
<span id="cb281-9"><a href="day-20.html#cb281-9"></a><span class="co">## add back in the lat/lon variables</span></span>
<span id="cb281-10"><a href="day-20.html#cb281-10"></a>dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></span>
<span id="cb281-11"><a href="day-20.html#cb281-11"></a><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb281-12"><a href="day-20.html#cb281-12"></a><span class="st">    </span><span class="kw">left_join</span>(dat, <span class="dt">by =</span> <span class="st">&quot;id_factor&quot;</span>) </span></code></pre></div>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="day-20.html#cb282-1"></a>n.samples &lt;-<span class="st"> </span><span class="dv">5000</span></span>
<span id="cb282-2"><a href="day-20.html#cb282-2"></a></span>
<span id="cb282-3"><a href="day-20.html#cb282-3"></a>starting &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">sigma.sq =</span> <span class="dv">2</span>, <span class="dt">tau.sq =</span> <span class="dv">2</span>)</span>
<span id="cb282-4"><a href="day-20.html#cb282-4"></a>tuning &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="fl">2.5</span>, <span class="dt">sigma.sq =</span> <span class="fl">0.1</span>, <span class="dt">tau.sq =</span> <span class="fl">0.1</span>)</span>
<span id="cb282-5"><a href="day-20.html#cb282-5"></a>p &lt;-<span class="st"> </span><span class="dv">3</span> <span class="co">## use lat and lon as predictors (plus an intercept)</span></span>
<span id="cb282-6"><a href="day-20.html#cb282-6"></a>coords &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">cbind</span>(dat<span class="op">$</span>lon, dat<span class="op">$</span>lat))</span>
<span id="cb282-7"><a href="day-20.html#cb282-7"></a>max_dist &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">rdist</span>(coords))</span>
<span id="cb282-8"><a href="day-20.html#cb282-8"></a>priors &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb282-9"><a href="day-20.html#cb282-9"></a>    <span class="dt">beta.Norm   =</span> <span class="kw">list</span>(<span class="kw">rep</span>(<span class="dv">0</span>, p), <span class="kw">diag</span>(<span class="fl">1e+06</span>, p)),</span>
<span id="cb282-10"><a href="day-20.html#cb282-10"></a>    <span class="dt">phi.Unif    =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">100</span>),</span>
<span id="cb282-11"><a href="day-20.html#cb282-11"></a>    <span class="dt">sigma.sq.IG =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), </span>
<span id="cb282-12"><a href="day-20.html#cb282-12"></a>    <span class="dt">tau.sq.IG   =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb282-13"><a href="day-20.html#cb282-13"></a>)</span>
<span id="cb282-14"><a href="day-20.html#cb282-14"></a>cov.model &lt;-<span class="st"> &quot;exponential&quot;</span></span>
<span id="cb282-15"><a href="day-20.html#cb282-15"></a></span>
<span id="cb282-16"><a href="day-20.html#cb282-16"></a>fit_e &lt;-<span class="st"> </span><span class="kw">spLM</span>(</span>
<span id="cb282-17"><a href="day-20.html#cb282-17"></a>    dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>lon <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>lat,</span>
<span id="cb282-18"><a href="day-20.html#cb282-18"></a>    <span class="dt">coords    =</span> coords,</span>
<span id="cb282-19"><a href="day-20.html#cb282-19"></a>    <span class="dt">starting  =</span> starting,</span>
<span id="cb282-20"><a href="day-20.html#cb282-20"></a>    <span class="dt">tuning    =</span> tuning, </span>
<span id="cb282-21"><a href="day-20.html#cb282-21"></a>    <span class="dt">priors    =</span> priors, </span>
<span id="cb282-22"><a href="day-20.html#cb282-22"></a>    <span class="dt">cov.model =</span> cov.model, </span>
<span id="cb282-23"><a href="day-20.html#cb282-23"></a>    <span class="dt">n.samples =</span> n.samples,</span>
<span id="cb282-24"><a href="day-20.html#cb282-24"></a>    <span class="dt">n.report  =</span> <span class="dv">1000</span></span>
<span id="cb282-25"><a href="day-20.html#cb282-25"></a>)</span></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the exponential spatial correlation model.
## 
## Number of MCMC samples 5000.
## 
## Priors and hyperpriors:
##  beta normal:
##  mu: 0.000   0.000   0.000   
##  cov:
##  1000000.000 0.000   0.000   
##  0.000   1000000.000 0.000   
##  0.000   0.000   1000000.000 
## 
##  sigma.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  tau.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  phi Unif hyperpriors a=0.01000 and b=100.00000
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Sampled: 1000 of 5000, 20.00%
## Report interval Metrop. Acceptance rate: 12.20%
## Overall Metrop. Acceptance rate: 12.20%
## -------------------------------------------------
## Sampled: 2000 of 5000, 40.00%
## Report interval Metrop. Acceptance rate: 8.70%
## Overall Metrop. Acceptance rate: 10.45%
## -------------------------------------------------
## Sampled: 3000 of 5000, 60.00%
## Report interval Metrop. Acceptance rate: 11.00%
## Overall Metrop. Acceptance rate: 10.63%
## -------------------------------------------------
## Sampled: 4000 of 5000, 80.00%
## Report interval Metrop. Acceptance rate: 10.40%
## Overall Metrop. Acceptance rate: 10.57%
## -------------------------------------------------
## Sampled: 5000 of 5000, 100.00%
## Report interval Metrop. Acceptance rate: 11.50%
## Overall Metrop. Acceptance rate: 10.76%
## -------------------------------------------------</code></pre>
<p>The above fits the model. However, sometimes it is hard to “tune” the model to get the desired Metropolis acceptance rate. <code>spLM</code> has an option for adaptive MCMC tuning. To enable this option, we add an <code>amcmc</code> option. We are also going to change to a Matern covarince function in the next code as well.</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="day-20.html#cb284-1"></a>n.samples    &lt;-<span class="st"> </span><span class="dv">5000</span></span>
<span id="cb284-2"><a href="day-20.html#cb284-2"></a>batch.length &lt;-<span class="st"> </span><span class="dv">50</span></span>
<span id="cb284-3"><a href="day-20.html#cb284-3"></a>n.batch      &lt;-<span class="st"> </span>n.samples <span class="op">/</span><span class="st"> </span>batch.length</span>
<span id="cb284-4"><a href="day-20.html#cb284-4"></a></span>
<span id="cb284-5"><a href="day-20.html#cb284-5"></a><span class="co">## must add in values for the smoothness paramter nu</span></span>
<span id="cb284-6"><a href="day-20.html#cb284-6"></a>starting &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">sigma.sq =</span> <span class="dv">2</span>, <span class="dt">tau.sq =</span> <span class="dv">2</span>, <span class="dt">nu =</span> <span class="dv">1</span>)</span>
<span id="cb284-7"><a href="day-20.html#cb284-7"></a>tuning &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="fl">2.5</span>, <span class="dt">sigma.sq =</span> <span class="fl">0.1</span>, <span class="dt">tau.sq =</span> <span class="fl">0.1</span>, <span class="dt">nu =</span> <span class="fl">0.1</span>)</span>
<span id="cb284-8"><a href="day-20.html#cb284-8"></a>p &lt;-<span class="st"> </span><span class="dv">3</span> <span class="co">## use lat and lon as predictors (plus an intercept)</span></span>
<span id="cb284-9"><a href="day-20.html#cb284-9"></a>coords &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">cbind</span>(dat<span class="op">$</span>lon, dat<span class="op">$</span>lat))</span>
<span id="cb284-10"><a href="day-20.html#cb284-10"></a>max_dist &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">rdist</span>(coords))</span>
<span id="cb284-11"><a href="day-20.html#cb284-11"></a>priors &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb284-12"><a href="day-20.html#cb284-12"></a>    <span class="dt">beta.Norm   =</span> <span class="kw">list</span>(<span class="kw">rep</span>(<span class="dv">0</span>, p), <span class="kw">diag</span>(<span class="fl">1e+06</span>, p)),</span>
<span id="cb284-13"><a href="day-20.html#cb284-13"></a>    <span class="dt">phi.Unif    =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">100</span>),</span>
<span id="cb284-14"><a href="day-20.html#cb284-14"></a>    <span class="dt">nu.Unif     =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">100</span>),</span>
<span id="cb284-15"><a href="day-20.html#cb284-15"></a>    <span class="dt">sigma.sq.IG =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), </span>
<span id="cb284-16"><a href="day-20.html#cb284-16"></a>    <span class="dt">tau.sq.IG   =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb284-17"><a href="day-20.html#cb284-17"></a>)</span>
<span id="cb284-18"><a href="day-20.html#cb284-18"></a>cov.model &lt;-<span class="st"> &quot;matern&quot;</span></span>
<span id="cb284-19"><a href="day-20.html#cb284-19"></a></span>
<span id="cb284-20"><a href="day-20.html#cb284-20"></a>fit_m &lt;-<span class="st"> </span><span class="kw">spLM</span>(</span>
<span id="cb284-21"><a href="day-20.html#cb284-21"></a>    dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>lon <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>lat,</span>
<span id="cb284-22"><a href="day-20.html#cb284-22"></a>    <span class="dt">coords    =</span> coords,</span>
<span id="cb284-23"><a href="day-20.html#cb284-23"></a>    <span class="dt">starting  =</span> starting,</span>
<span id="cb284-24"><a href="day-20.html#cb284-24"></a>    <span class="dt">tuning    =</span> tuning, </span>
<span id="cb284-25"><a href="day-20.html#cb284-25"></a>    <span class="dt">priors    =</span> priors, </span>
<span id="cb284-26"><a href="day-20.html#cb284-26"></a>    <span class="dt">cov.model =</span> cov.model, </span>
<span id="cb284-27"><a href="day-20.html#cb284-27"></a>    <span class="dt">n.samples =</span> n.samples,</span>
<span id="cb284-28"><a href="day-20.html#cb284-28"></a>    <span class="dt">amcmc     =</span> <span class="kw">list</span>(</span>
<span id="cb284-29"><a href="day-20.html#cb284-29"></a>        <span class="dt">n.batch =</span> n.batch, </span>
<span id="cb284-30"><a href="day-20.html#cb284-30"></a>        <span class="dt">batch.length =</span> batch.length,</span>
<span id="cb284-31"><a href="day-20.html#cb284-31"></a>        <span class="dt">accept.rate =</span> <span class="fl">0.44</span></span>
<span id="cb284-32"><a href="day-20.html#cb284-32"></a>    ),</span>
<span id="cb284-33"><a href="day-20.html#cb284-33"></a>    <span class="dt">n.report  =</span> <span class="dv">10</span> <span class="co">## report every 10 adaptive batches</span></span>
<span id="cb284-34"><a href="day-20.html#cb284-34"></a>)</span>
<span id="cb284-35"><a href="day-20.html#cb284-35"></a><span class="co">## can update the initial tuning parameters given the adapted values</span></span></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the matern spatial correlation model.
## 
## Using adaptive MCMC.
## 
##  Number of batches 100.
##  Batch length 50.
##  Target acceptance rate 0.44000.
## 
## Priors and hyperpriors:
##  beta normal:
##  mu: 0.000   0.000   0.000   
##  cov:
##  1000000.000 0.000   0.000   
##  0.000   1000000.000 0.000   
##  0.000   0.000   1000000.000 
## 
##  sigma.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  tau.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  phi Unif hyperpriors a=0.01000 and b=100.00000
##  nu Unif hyperpriors a=0.01000 and b=100.00000
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Batch: 10 of 100, 10.00%
##  parameter   acceptance  tuning
##  sigma.sq    46.0        0.33578
##  tau.sq      52.0        0.34949
##  phi     6.0     1.43067
##  nu      44.0        0.28613
## -------------------------------------------------
## Batch: 20 of 100, 20.00%
##  parameter   acceptance  tuning
##  sigma.sq    58.0        0.36375
##  tau.sq      48.0        0.36375
##  phi     6.0     1.29453
##  nu      86.0        0.30997
## -------------------------------------------------
## Batch: 30 of 100, 30.00%
##  parameter   acceptance  tuning
##  sigma.sq    48.0        0.39404
##  tau.sq      60.0        0.37859
##  phi     8.0     1.17134
##  nu      40.0        0.32913
## -------------------------------------------------
## Batch: 40 of 100, 40.00%
##  parameter   acceptance  tuning
##  sigma.sq    48.0        0.37859
##  tau.sq      54.0        0.41841
##  phi     12.0        1.05987
##  nu      40.0        0.29781
## -------------------------------------------------
## Batch: 50 of 100, 50.00%
##  parameter   acceptance  tuning
##  sigma.sq    42.0        0.39404
##  tau.sq      40.0        0.43549
##  phi     18.0        0.95901
##  nu      64.0        0.30997
## -------------------------------------------------
## Batch: 60 of 100, 60.00%
##  parameter   acceptance  tuning
##  sigma.sq    58.0        0.42686
##  tau.sq      38.0        0.41013
##  phi     18.0        0.86775
##  nu      56.0        0.34257
## -------------------------------------------------
## Batch: 70 of 100, 70.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.43549
##  tau.sq      64.0        0.39404
##  phi     26.0        0.78517
##  nu      66.0        0.37859
## -------------------------------------------------
## Batch: 80 of 100, 80.00%
##  parameter   acceptance  tuning
##  sigma.sq    54.0        0.45326
##  tau.sq      40.0        0.37859
##  phi     22.0        0.71045
##  nu      84.0        0.41841
## -------------------------------------------------
## Batch: 90 of 100, 90.00%
##  parameter   acceptance  tuning
##  sigma.sq    38.0        0.44428
##  tau.sq      40.0        0.38624
##  phi     22.0        0.64284
##  nu      56.0        0.46241
## -------------------------------------------------
## Batch: 100 of 100, 100.00%
##  parameter   acceptance  tuning
##  sigma.sq    42.0        0.43549
##  tau.sq      56.0        0.39404
##  phi     32.0        0.58167
##  nu      80.0        0.51105
## -------------------------------------------------</code></pre>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="day-20.html#cb286-1"></a>tuning &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">phi =</span> <span class="fl">0.5</span>, <span class="dt">sigma.sq =</span> <span class="fl">0.38</span>, <span class="dt">tau.sq =</span> <span class="fl">0.6</span>, <span class="dt">nu =</span> <span class="fl">0.3</span>)</span>
<span id="cb286-2"><a href="day-20.html#cb286-2"></a>fit_m &lt;-<span class="st"> </span><span class="kw">spLM</span>(</span>
<span id="cb286-3"><a href="day-20.html#cb286-3"></a>    dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>lon <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>lat,</span>
<span id="cb286-4"><a href="day-20.html#cb286-4"></a>    <span class="dt">coords    =</span> coords,</span>
<span id="cb286-5"><a href="day-20.html#cb286-5"></a>    <span class="dt">starting  =</span> starting,</span>
<span id="cb286-6"><a href="day-20.html#cb286-6"></a>    <span class="dt">tuning    =</span> tuning, </span>
<span id="cb286-7"><a href="day-20.html#cb286-7"></a>    <span class="dt">priors    =</span> priors, </span>
<span id="cb286-8"><a href="day-20.html#cb286-8"></a>    <span class="dt">cov.model =</span> cov.model, </span>
<span id="cb286-9"><a href="day-20.html#cb286-9"></a>    <span class="dt">n.samples =</span> n.samples,</span>
<span id="cb286-10"><a href="day-20.html#cb286-10"></a>    <span class="dt">amcmc     =</span> <span class="kw">list</span>(</span>
<span id="cb286-11"><a href="day-20.html#cb286-11"></a>        <span class="dt">n.batch =</span> n.batch, </span>
<span id="cb286-12"><a href="day-20.html#cb286-12"></a>        <span class="dt">batch.length =</span> batch.length,</span>
<span id="cb286-13"><a href="day-20.html#cb286-13"></a>        <span class="dt">accept.rate =</span> <span class="fl">0.44</span></span>
<span id="cb286-14"><a href="day-20.html#cb286-14"></a>    ),</span>
<span id="cb286-15"><a href="day-20.html#cb286-15"></a>    <span class="dt">n.report  =</span> <span class="dv">10</span> <span class="co">## report every 10 adaptive batches</span></span>
<span id="cb286-16"><a href="day-20.html#cb286-16"></a>)</span>
<span id="cb286-17"><a href="day-20.html#cb286-17"></a><span class="co">## can update the initial tuning parameters given the adapted values</span></span></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the matern spatial correlation model.
## 
## Using adaptive MCMC.
## 
##  Number of batches 100.
##  Batch length 50.
##  Target acceptance rate 0.44000.
## 
## Priors and hyperpriors:
##  beta normal:
##  mu: 0.000   0.000   0.000   
##  cov:
##  1000000.000 0.000   0.000   
##  0.000   1000000.000 0.000   
##  0.000   0.000   1000000.000 
## 
##  sigma.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  tau.sq IG hyperpriors shape=2.00000 and scale=2.00000
##  phi Unif hyperpriors a=0.01000 and b=100.00000
##  nu Unif hyperpriors a=0.01000 and b=100.00000
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Batch: 10 of 100, 10.00%
##  parameter   acceptance  tuning
##  sigma.sq    40.0        0.55778
##  tau.sq      28.0        0.79024
##  phi     12.0        0.63982
##  nu      24.0        0.49560
## -------------------------------------------------
## Batch: 20 of 100, 20.00%
##  parameter   acceptance  tuning
##  sigma.sq    30.0        0.51490
##  tau.sq      30.0        0.75926
##  phi     22.0        0.57893
##  nu      24.0        0.44844
## -------------------------------------------------
## Batch: 30 of 100, 30.00%
##  parameter   acceptance  tuning
##  sigma.sq    42.0        0.47531
##  tau.sq      44.0        0.71504
##  phi     32.0        0.52384
##  nu      36.0        0.42232
## -------------------------------------------------
## Batch: 40 of 100, 40.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.46590
##  tau.sq      40.0        0.70088
##  phi     26.0        0.47399
##  nu      28.0        0.38213
## -------------------------------------------------
## Batch: 50 of 100, 50.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.43008
##  tau.sq      58.0        0.71504
##  phi     18.0        0.43755
##  nu      24.0        0.34577
## -------------------------------------------------
## Batch: 60 of 100, 60.00%
##  parameter   acceptance  tuning
##  sigma.sq    40.0        0.41321
##  tau.sq      38.0        0.71504
##  phi     30.0        0.39591
##  nu      42.0        0.31286
## -------------------------------------------------
## Batch: 70 of 100, 70.00%
##  parameter   acceptance  tuning
##  sigma.sq    34.0        0.39701
##  tau.sq      50.0        0.74422
##  phi     26.0        0.35823
##  nu      34.0        0.28881
## -------------------------------------------------
## Batch: 80 of 100, 80.00%
##  parameter   acceptance  tuning
##  sigma.sq    50.0        0.39701
##  tau.sq      32.0        0.75926
##  phi     34.0        0.33069
##  nu      46.0        0.26661
## -------------------------------------------------
## Batch: 90 of 100, 90.00%
##  parameter   acceptance  tuning
##  sigma.sq    30.0        0.38915
##  tau.sq      46.0        0.74422
##  phi     52.0        0.30527
##  nu      38.0        0.24611
## -------------------------------------------------
## Batch: 100 of 100, 100.00%
##  parameter   acceptance  tuning
##  sigma.sq    48.0        0.39701
##  tau.sq      32.0        0.72949
##  phi     28.0        0.29922
##  nu      54.0        0.26133
## -------------------------------------------------</code></pre>
<p>To get the fitted parameters, we can recover these with composition sampling.</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="day-20.html#cb288-1"></a><span class="co">## discard the first half of the samples as burn-in</span></span>
<span id="cb288-2"><a href="day-20.html#cb288-2"></a>burn.in &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>n.samples</span>
<span id="cb288-3"><a href="day-20.html#cb288-3"></a><span class="co">## trace plots for the exponential model</span></span>
<span id="cb288-4"><a href="day-20.html#cb288-4"></a>fit_e &lt;-<span class="st"> </span><span class="kw">spRecover</span>(fit_e, <span class="dt">start =</span> burn.in, <span class="dt">thin =</span> <span class="dv">2</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb288-5"><a href="day-20.html#cb288-5"></a>theta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_e<span class="op">$</span>p.theta.samples, fit_e<span class="op">$</span>p.theta.samples)</span>
<span id="cb288-6"><a href="day-20.html#cb288-6"></a><span class="kw">plot</span>(theta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</span>
<span id="cb288-7"><a href="day-20.html#cb288-7"></a>beta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_e<span class="op">$</span>p.beta.recover.samples, fit_e<span class="op">$</span>p.beta.recover.samples)  </span>
<span id="cb288-8"><a href="day-20.html#cb288-8"></a><span class="kw">plot</span>(beta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-156-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-156-2.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="day-20.html#cb289-1"></a><span class="co">## trace plots for the matern model</span></span>
<span id="cb289-2"><a href="day-20.html#cb289-2"></a>fit_m &lt;-<span class="st"> </span><span class="kw">spRecover</span>(fit_m, <span class="dt">start =</span> burn.in, <span class="dt">thin =</span> <span class="dv">2</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb289-3"><a href="day-20.html#cb289-3"></a>theta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_m<span class="op">$</span>p.theta.samples, fit_m<span class="op">$</span>p.theta.samples)</span>
<span id="cb289-4"><a href="day-20.html#cb289-4"></a><span class="kw">plot</span>(theta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</span>
<span id="cb289-5"><a href="day-20.html#cb289-5"></a>beta.samps &lt;-<span class="st"> </span><span class="kw">mcmc.list</span>(fit_m<span class="op">$</span>p.beta.recover.samples, fit_m<span class="op">$</span>p.beta.recover.samples)  </span>
<span id="cb289-6"><a href="day-20.html#cb289-6"></a><span class="kw">plot</span>(beta.samps, <span class="dt">density =</span> <span class="ot">FALSE</span>)</span>
<span id="cb289-7"><a href="day-20.html#cb289-7"></a><span class="kw">round</span>(<span class="kw">summary</span>(theta.samps)<span class="op">$</span>quantiles, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##            2.5%    25%    50%    75%  97.5%
## sigma.sq 14.437 20.865 25.640 32.910 62.267
## tau.sq    0.538  1.029  1.430  1.917  3.239
## phi       0.167  0.335  0.472  0.648  1.495
## nu        0.602  0.819  1.033  1.425  4.846</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-157-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-157-2.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="day-20.html#cb291-1"></a><span class="co">## recover the spatial random effects</span></span>
<span id="cb291-2"><a href="day-20.html#cb291-2"></a>fit_e_w &lt;-<span class="st"> </span>fit_e<span class="op">$</span>p.w.recover.samples</span>
<span id="cb291-3"><a href="day-20.html#cb291-3"></a>fit_m_w &lt;-<span class="st"> </span>fit_m<span class="op">$</span>p.w.recover.samples</span>
<span id="cb291-4"><a href="day-20.html#cb291-4"></a></span>
<span id="cb291-5"><a href="day-20.html#cb291-5"></a><span class="co">## recover the spatial random effects (eta&#39;s in our class notation)</span></span>
<span id="cb291-6"><a href="day-20.html#cb291-6"></a>w.samps &lt;-<span class="st"> </span><span class="kw">cbind</span>(fit_e_w, fit_m_w)</span>
<span id="cb291-7"><a href="day-20.html#cb291-7"></a>w.summary &lt;-<span class="st"> </span><span class="kw">apply</span>(w.samps, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb291-8"><a href="day-20.html#cb291-8"></a>    <span class="kw">quantile</span>(x, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span>
<span id="cb291-9"><a href="day-20.html#cb291-9"></a>})</span></code></pre></div>
<p>Next we can genereate predictions for the exponential model</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="day-20.html#cb292-1"></a>states &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;state&quot;</span>)</span>
<span id="cb292-2"><a href="day-20.html#cb292-2"></a></span>
<span id="cb292-3"><a href="day-20.html#cb292-3"></a>pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</span>
<span id="cb292-4"><a href="day-20.html#cb292-4"></a>    <span class="kw">expand.grid</span>(</span>
<span id="cb292-5"><a href="day-20.html#cb292-5"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </span>
<span id="cb292-6"><a href="day-20.html#cb292-6"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb292-7"><a href="day-20.html#cb292-7"></a>    )</span>
<span id="cb292-8"><a href="day-20.html#cb292-8"></a>)</span>
<span id="cb292-9"><a href="day-20.html#cb292-9"></a><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb292-10"><a href="day-20.html#cb292-10"></a></span>
<span id="cb292-11"><a href="day-20.html#cb292-11"></a><span class="co">## predict using the tuned Matern fit</span></span>
<span id="cb292-12"><a href="day-20.html#cb292-12"></a>preds &lt;-<span class="st"> </span><span class="kw">spPredict</span>(</span>
<span id="cb292-13"><a href="day-20.html#cb292-13"></a>    fit_m, </span>
<span id="cb292-14"><a href="day-20.html#cb292-14"></a>    <span class="dt">start =</span> burn.in, </span>
<span id="cb292-15"><a href="day-20.html#cb292-15"></a>    <span class="dt">thin =</span> <span class="dv">10</span>, </span>
<span id="cb292-16"><a href="day-20.html#cb292-16"></a>    <span class="dt">pred.coords =</span> <span class="kw">cbind</span>(pred_coords<span class="op">$</span>lon, pred_coords<span class="op">$</span>lat), </span>
<span id="cb292-17"><a href="day-20.html#cb292-17"></a>    <span class="dt">pred.covars =</span> <span class="kw">cbind</span>(<span class="dv">1</span>, pred_coords<span class="op">$</span>lon, pred_coords<span class="op">$</span>lat)</span>
<span id="cb292-18"><a href="day-20.html#cb292-18"></a>)</span>
<span id="cb292-19"><a href="day-20.html#cb292-19"></a></span>
<span id="cb292-20"><a href="day-20.html#cb292-20"></a><span class="co">## Calculate the prediction means and variances</span></span>
<span id="cb292-21"><a href="day-20.html#cb292-21"></a>pred_coords<span class="op">$</span>pred_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(preds<span class="op">$</span>p.y.predictive.samples, <span class="dv">1</span>, mean)</span>
<span id="cb292-22"><a href="day-20.html#cb292-22"></a>pred_coords<span class="op">$</span>pred_var &lt;-<span class="st"> </span><span class="kw">apply</span>(preds<span class="op">$</span>p.y.predictive.samples, <span class="dv">1</span>, var)</span>
<span id="cb292-23"><a href="day-20.html#cb292-23"></a></span>
<span id="cb292-24"><a href="day-20.html#cb292-24"></a><span class="co">## calculate 95% credible intervals for the predictions</span></span>
<span id="cb292-25"><a href="day-20.html#cb292-25"></a>pred.summary &lt;-<span class="st"> </span><span class="kw">apply</span>(preds<span class="op">$</span>p.y.predictive.samples, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb292-26"><a href="day-20.html#cb292-26"></a>    <span class="kw">quantile</span>(x, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span>
<span id="cb292-27"><a href="day-20.html#cb292-27"></a>})</span>
<span id="cb292-28"><a href="day-20.html#cb292-28"></a></span>
<span id="cb292-29"><a href="day-20.html#cb292-29"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></span>
<span id="cb292-30"><a href="day-20.html#cb292-30"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb292-31"><a href="day-20.html#cb292-31"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb292-32"><a href="day-20.html#cb292-32"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb292-33"><a href="day-20.html#cb292-33"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb292-34"><a href="day-20.html#cb292-34"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb292-35"><a href="day-20.html#cb292-35"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span>
<span id="cb292-36"><a href="day-20.html#cb292-36"></a></span>
<span id="cb292-37"><a href="day-20.html#cb292-37"></a></span>
<span id="cb292-38"><a href="day-20.html#cb292-38"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_var)) <span class="op">+</span></span>
<span id="cb292-39"><a href="day-20.html#cb292-39"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb292-40"><a href="day-20.html#cb292-40"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb292-41"><a href="day-20.html#cb292-41"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb292-42"><a href="day-20.html#cb292-42"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb292-43"><a href="day-20.html#cb292-43"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average July max Temperature prediction variance in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb292-44"><a href="day-20.html#cb292-44"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span></code></pre></div>
<pre><code>## ----------------------------------------
##  General model description
## ----------------------------------------
## Model fit with 136 observations.
## 
## Prediction at 10000 locations.
## 
## Number of covariates 3 (including intercept if specified).
## 
## Using the matern spatial correlation model.
## 
## -------------------------------------------------
##      Sampling
## -------------------------------------------------
## Sampled: 100 of 251, 39.44%
## Sampled: 200 of 251, 79.28%</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-159-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-159-2.png" width="480" style="display: block; margin: auto;" /></p>
<p>Note these variances are higher than the MLE estimates (potentially by a lot – link to MLE fits day 11)</p>
</div>
<div id="global-vs.-local-basis-function" class="section level2" number="20.3">
<h2 number="20.3"><span class="header-section-number">20.3</span> Global vs. Local Basis function</h2>
<ul>
<li>simulate some data</li>
</ul>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="day-20.html#cb294-1"></a><span class="kw">set.seed</span>(<span class="dv">44</span>)</span>
<span id="cb294-2"><a href="day-20.html#cb294-2"></a>n &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb294-3"><a href="day-20.html#cb294-3"></a>sigma &lt;-<span class="st"> </span><span class="fl">0.2</span></span>
<span id="cb294-4"><a href="day-20.html#cb294-4"></a>x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> n)</span>
<span id="cb294-5"><a href="day-20.html#cb294-5"></a>Sigma &lt;-<span class="st"> </span><span class="kw">exp</span>( <span class="op">-</span><span class="st"> </span><span class="kw">rdist</span>(x)<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="fl">0.02</span>)</span>
<span id="cb294-6"><a href="day-20.html#cb294-6"></a></span>
<span id="cb294-7"><a href="day-20.html#cb294-7"></a><span class="co">## Gaussian covariance with a small amount of &quot;error&quot;</span></span>
<span id="cb294-8"><a href="day-20.html#cb294-8"></a>mu &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rmvn</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, n), Sigma <span class="op">+</span><span class="st"> </span><span class="fl">1e-10</span> <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(n))) </span>
<span id="cb294-9"><a href="day-20.html#cb294-9"></a>y &lt;-<span class="st"> </span>mu <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, sigma)</span>
<span id="cb294-10"><a href="day-20.html#cb294-10"></a>dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb294-11"><a href="day-20.html#cb294-11"></a>    <span class="dt">x  =</span> x,</span>
<span id="cb294-12"><a href="day-20.html#cb294-12"></a>    <span class="dt">y  =</span> y, </span>
<span id="cb294-13"><a href="day-20.html#cb294-13"></a>    <span class="dt">mu =</span> mu</span>
<span id="cb294-14"><a href="day-20.html#cb294-14"></a>)</span>
<span id="cb294-15"><a href="day-20.html#cb294-15"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu)) <span class="op">+</span></span>
<span id="cb294-16"><a href="day-20.html#cb294-16"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb294-17"><a href="day-20.html#cb294-17"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y))</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-160-1.png" width="480" style="display: block; margin: auto;" /></p>
<div id="an-example-global-basis-fourier-basis" class="section level3" number="20.3.1">
<h3 number="20.3.1"><span class="header-section-number">20.3.1</span> An example global basis: Fourier Basis</h3>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="day-20.html#cb295-1"></a>make_fourier_basis &lt;-<span class="st"> </span><span class="cf">function</span>(x, num_freq) {</span>
<span id="cb295-2"><a href="day-20.html#cb295-2"></a>    <span class="co"># if (!is.integer(num_freq)) {</span></span>
<span id="cb295-3"><a href="day-20.html#cb295-3"></a>    <span class="co">#     stop(&quot;num_freq must be an odd integer&quot;)</span></span>
<span id="cb295-4"><a href="day-20.html#cb295-4"></a>    <span class="co"># }</span></span>
<span id="cb295-5"><a href="day-20.html#cb295-5"></a>    <span class="co"># if (num_freq %% 2 == 0) {</span></span>
<span id="cb295-6"><a href="day-20.html#cb295-6"></a>    <span class="co">#     stop(&quot;num_freq must be an odd integer&quot;)</span></span>
<span id="cb295-7"><a href="day-20.html#cb295-7"></a>    <span class="co"># }</span></span>
<span id="cb295-8"><a href="day-20.html#cb295-8"></a>    </span>
<span id="cb295-9"><a href="day-20.html#cb295-9"></a>    X_fourier &lt;-<span class="st"> </span><span class="kw">cbind</span>(</span>
<span id="cb295-10"><a href="day-20.html#cb295-10"></a>        <span class="dv">1</span>, </span>
<span id="cb295-11"><a href="day-20.html#cb295-11"></a>        <span class="kw">do.call</span>(</span>
<span id="cb295-12"><a href="day-20.html#cb295-12"></a>            cbind, </span>
<span id="cb295-13"><a href="day-20.html#cb295-13"></a>            <span class="kw">sapply</span>(</span>
<span id="cb295-14"><a href="day-20.html#cb295-14"></a>                <span class="dv">1</span><span class="op">:</span>((num_freq <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="cf">function</span>(i) { </span>
<span id="cb295-15"><a href="day-20.html#cb295-15"></a>                    <span class="kw">cbind</span>(<span class="kw">sin</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i <span class="op">*</span><span class="st"> </span>pi <span class="op">*</span><span class="st"> </span>x), <span class="kw">cos</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i <span class="op">*</span><span class="st"> </span>pi <span class="op">*</span><span class="st"> </span>x))</span>
<span id="cb295-16"><a href="day-20.html#cb295-16"></a>                }, </span>
<span id="cb295-17"><a href="day-20.html#cb295-17"></a>            <span class="dt">simplify =</span> <span class="ot">FALSE</span></span>
<span id="cb295-18"><a href="day-20.html#cb295-18"></a>            )</span>
<span id="cb295-19"><a href="day-20.html#cb295-19"></a>        )</span>
<span id="cb295-20"><a href="day-20.html#cb295-20"></a>    )</span>
<span id="cb295-21"><a href="day-20.html#cb295-21"></a>    </span>
<span id="cb295-22"><a href="day-20.html#cb295-22"></a><span class="kw">return</span>(X_fourier)</span>
<span id="cb295-23"><a href="day-20.html#cb295-23"></a>}</span>
<span id="cb295-24"><a href="day-20.html#cb295-24"></a></span>
<span id="cb295-25"><a href="day-20.html#cb295-25"></a>X_fourier &lt;-<span class="st"> </span><span class="kw">make_fourier_basis</span>(x, <span class="dt">num_freq =</span> <span class="dv">5</span>)</span>
<span id="cb295-26"><a href="day-20.html#cb295-26"></a>dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb295-27"><a href="day-20.html#cb295-27"></a>    <span class="dt">x         =</span> x, </span>
<span id="cb295-28"><a href="day-20.html#cb295-28"></a>    <span class="dt">y         =</span> y,</span>
<span id="cb295-29"><a href="day-20.html#cb295-29"></a>    <span class="dt">mu        =</span> mu,</span>
<span id="cb295-30"><a href="day-20.html#cb295-30"></a>    <span class="dt">X_fourier =</span> <span class="kw">c</span>(X_fourier),</span>
<span id="cb295-31"><a href="day-20.html#cb295-31"></a>    <span class="dt">basis     =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_fourier), <span class="dt">each =</span> n))</span>
<span id="cb295-32"><a href="day-20.html#cb295-32"></a>)</span>
<span id="cb295-33"><a href="day-20.html#cb295-33"></a></span>
<span id="cb295-34"><a href="day-20.html#cb295-34"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb295-35"><a href="day-20.html#cb295-35"></a><span class="st">    </span><span class="co"># geom_point() +</span></span>
<span id="cb295-36"><a href="day-20.html#cb295-36"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> X_fourier, <span class="dt">group =</span> basis, <span class="dt">color =</span> basis)) <span class="op">+</span></span>
<span id="cb295-37"><a href="day-20.html#cb295-37"></a><span class="st">    </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></span>
<span id="cb295-38"><a href="day-20.html#cb295-38"></a><span class="st">    </span><span class="kw">theme_dark</span>()</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-161-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="day-20.html#cb296-1"></a><span class="co">## fit a model using the Fourier basis</span></span>
<span id="cb296-2"><a href="day-20.html#cb296-2"></a>fit &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>X_fourier <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="day-20.html#cb297-1"></a><span class="co">## plot the basis with fitted coefficients</span></span>
<span id="cb297-2"><a href="day-20.html#cb297-2"></a>dat<span class="op">$</span>fitted_basis &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb297-3"><a href="day-20.html#cb297-3"></a>    <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_fourier), <span class="cf">function</span>(i) X_fourier[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i])</span>
<span id="cb297-4"><a href="day-20.html#cb297-4"></a>)</span>
<span id="cb297-5"><a href="day-20.html#cb297-5"></a></span>
<span id="cb297-6"><a href="day-20.html#cb297-6"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb297-7"><a href="day-20.html#cb297-7"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb297-8"><a href="day-20.html#cb297-8"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> fitted_basis, <span class="dt">color =</span> basis, <span class="dt">group =</span> basis)) <span class="op">+</span></span>
<span id="cb297-9"><a href="day-20.html#cb297-9"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Weighted Fourier Basis functions&quot;</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-163-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="day-20.html#cb298-1"></a><span class="co">## calculate the fitted function -- the sum of the bases</span></span>
<span id="cb298-2"><a href="day-20.html#cb298-2"></a>dat<span class="op">$</span>mu_hat &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_fourier), <span class="cf">function</span>(i) X_fourier[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i]), <span class="dv">1</span>, sum)</span>
<span id="cb298-3"><a href="day-20.html#cb298-3"></a></span>
<span id="cb298-4"><a href="day-20.html#cb298-4"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb298-5"><a href="day-20.html#cb298-5"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb298-6"><a href="day-20.html#cb298-6"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu_hat), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd  =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb298-7"><a href="day-20.html#cb298-7"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu), <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb298-8"><a href="day-20.html#cb298-8"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Fitted function vs. simulated function&quot;</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-164-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>The Fourier basis is global</li>
</ul>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="day-20.html#cb299-1"></a><span class="co">## only a small percentage of these values are zero</span></span>
<span id="cb299-2"><a href="day-20.html#cb299-2"></a><span class="kw">mean</span>(X_fourier <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 4e-04</code></pre>
</div>
</div>
<div id="example-local-basis" class="section level2" number="20.4">
<h2 number="20.4"><span class="header-section-number">20.4</span> example local basis</h2>
<ul>
<li><p>B-splines are piecewise polynomial functions</p></li>
<li><p>degrees of freedom are the number of functions</p>
<ul>
<li>More degrees of freedom – more “wiggly” fit – potential for overfitting</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="day-20.html#cb301-1"></a><span class="co">## B-splines</span></span>
<span id="cb301-2"><a href="day-20.html#cb301-2"></a>X_bs &lt;-<span class="st"> </span><span class="kw">bs</span>(x, <span class="dt">intercept =</span> <span class="ot">TRUE</span>, <span class="dt">df =</span> <span class="dv">6</span>)</span>
<span id="cb301-3"><a href="day-20.html#cb301-3"></a>dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb301-4"><a href="day-20.html#cb301-4"></a>    <span class="dt">x     =</span> x, </span>
<span id="cb301-5"><a href="day-20.html#cb301-5"></a>    <span class="dt">y     =</span> y,</span>
<span id="cb301-6"><a href="day-20.html#cb301-6"></a>    <span class="dt">mu    =</span> mu,</span>
<span id="cb301-7"><a href="day-20.html#cb301-7"></a>    <span class="dt">X_bs  =</span> <span class="kw">c</span>(X_bs),</span>
<span id="cb301-8"><a href="day-20.html#cb301-8"></a>    <span class="dt">basis =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_bs), <span class="dt">each =</span> n))</span>
<span id="cb301-9"><a href="day-20.html#cb301-9"></a>)</span>
<span id="cb301-10"><a href="day-20.html#cb301-10"></a></span>
<span id="cb301-11"><a href="day-20.html#cb301-11"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb301-12"><a href="day-20.html#cb301-12"></a><span class="st">    </span><span class="co"># geom_point() +</span></span>
<span id="cb301-13"><a href="day-20.html#cb301-13"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> X_bs, <span class="dt">group =</span> basis, <span class="dt">color =</span> basis)) <span class="op">+</span></span>
<span id="cb301-14"><a href="day-20.html#cb301-14"></a><span class="st">    </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></span>
<span id="cb301-15"><a href="day-20.html#cb301-15"></a><span class="st">    </span><span class="kw">theme_dark</span>()</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-166-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="day-20.html#cb302-1"></a><span class="co">## fit a model using the B-spline basis</span></span>
<span id="cb302-2"><a href="day-20.html#cb302-2"></a>fit &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>X_bs <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="day-20.html#cb303-1"></a><span class="co">## plot the basis with fitted coefficients</span></span>
<span id="cb303-2"><a href="day-20.html#cb303-2"></a>dat<span class="op">$</span>fitted_basis &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb303-3"><a href="day-20.html#cb303-3"></a>    <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_bs), <span class="cf">function</span>(i) X_bs[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i])</span>
<span id="cb303-4"><a href="day-20.html#cb303-4"></a>)</span>
<span id="cb303-5"><a href="day-20.html#cb303-5"></a></span>
<span id="cb303-6"><a href="day-20.html#cb303-6"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb303-7"><a href="day-20.html#cb303-7"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb303-8"><a href="day-20.html#cb303-8"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> fitted_basis, <span class="dt">color =</span> basis, <span class="dt">group =</span> basis)) <span class="op">+</span></span>
<span id="cb303-9"><a href="day-20.html#cb303-9"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Weighted B-spline Basis functions&quot;</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-168-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="day-20.html#cb304-1"></a><span class="co">## calculate the fitted function -- the sum of the bases</span></span>
<span id="cb304-2"><a href="day-20.html#cb304-2"></a>dat<span class="op">$</span>mu_hat &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_bs), <span class="cf">function</span>(i) X_bs[, i] <span class="op">*</span><span class="st"> </span>fit<span class="op">$</span>coefficients[i]), <span class="dv">1</span>, sum)</span>
<span id="cb304-3"><a href="day-20.html#cb304-3"></a></span>
<span id="cb304-4"><a href="day-20.html#cb304-4"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb304-5"><a href="day-20.html#cb304-5"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb304-6"><a href="day-20.html#cb304-6"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu_hat), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd  =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb304-7"><a href="day-20.html#cb304-7"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> mu), <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb304-8"><a href="day-20.html#cb304-8"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Fitted function vs. simulated function&quot;</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-169-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>The B-spline basis is local</li>
</ul>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="day-20.html#cb305-1"></a><span class="co">## a much larger percentage of these values are zero -- can use sparse matrix</span></span>
<span id="cb305-2"><a href="day-20.html#cb305-2"></a><span class="co">##     routines to solve these equations much faster</span></span>
<span id="cb305-3"><a href="day-20.html#cb305-3"></a><span class="kw">mean</span>(X_bs <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 0.3347</code></pre>
</div>
<div id="fitting-spatial-models-many-ways" class="section level2" number="20.5">
<h2 number="20.5"><span class="header-section-number">20.5</span> Fitting spatial models many ways</h2>
</div>
<div id="empirical-orthogonal-functions" class="section level2" number="20.6">
<h2 number="20.6"><span class="header-section-number">20.6</span> Empirical Orthogonal Functions</h2>
<ul>
<li><p>Recall the Karhunen-Loève expansion</p></li>
<li><p>Analog for PCA for spatio-temporal data</p></li>
<li><p>Use the sea surface temperature (SST) data in <span class="citation">Wikle, Zammit-Mangion, and Cressie (<a href="references.html#ref-wikle2019spatio" role="doc-biblioref">2019</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="day-20.html#cb307-1"></a><span class="kw">data</span>(<span class="st">&quot;SSTlandmask&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</span>
<span id="cb307-2"><a href="day-20.html#cb307-2"></a><span class="kw">data</span>(<span class="st">&quot;SSTlonlat&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>) </span>
<span id="cb307-3"><a href="day-20.html#cb307-3"></a><span class="kw">data</span>(<span class="st">&quot;SSTdata&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</span></code></pre></div>
<p>Delete the values of SST that are over land (e.g. <code>SSTlandmask</code> is 1)</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="day-20.html#cb308-1"></a>delete_rows &lt;-<span class="st"> </span><span class="kw">which</span>(SSTlandmask <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb308-2"><a href="day-20.html#cb308-2"></a>SSTdata &lt;-<span class="st"> </span>SSTdata[<span class="op">-</span>delete_rows, <span class="dv">1</span><span class="op">:</span><span class="dv">396</span>]</span></code></pre></div>
<p>The eigen decomposition of the sample covariance of the data is equivalent to the singular value decomposition of the scaled and detrended data <span class="math inline">\(\mathbf{y}\)</span>.</p>
<p><span class="math display">\[\begin{align*}
\tilde{\mathbf{y}} &amp; \equiv \frac{1}{\sqrt{T - 1}} \left( \right)
\end{align*}\]</span></p>
<p>To get a spatial EOF, we need to transform the data into space-wide format</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="day-20.html#cb309-1"></a>y &lt;-<span class="st"> </span><span class="kw">t</span>(SSTdata)</span>
<span id="cb309-2"><a href="day-20.html#cb309-2"></a><span class="kw">dim</span>(y)</span></code></pre></div>
<pre><code>## [1]  396 2261</code></pre>
<p>To use the equation above, we need to calculate the spatial mean and the number of spatial replicates and scale and detrend the data</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="day-20.html#cb311-1"></a>spatial_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(SSTdata, <span class="dv">1</span>, mean)</span>
<span id="cb311-2"><a href="day-20.html#cb311-2"></a>nT &lt;-<span class="st"> </span><span class="kw">ncol</span>(SSTdata)</span>
<span id="cb311-3"><a href="day-20.html#cb311-3"></a>y_tilde &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(nT <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>(y <span class="op">-</span><span class="st"> </span><span class="kw">outer</span>(<span class="kw">rep</span>(<span class="dv">1</span>, nT), spatial_mean))</span></code></pre></div>
<p>We carry out the SVD on this scaled and detrended data</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="day-20.html#cb312-1"></a>svd_y &lt;-<span class="st"> </span><span class="kw">svd</span>(y_tilde)</span></code></pre></div>
<p>which returns a list with three elements <span class="math inline">\(\mathbf{U}\)</span> <span class="math inline">\(\mathbf{D}\)</span> <span class="math inline">\(\mathbf{V}\)</span></p>
<p><span class="math display">\[\begin{align*}
\tilde{\mathbf{y}} &amp; = \mathbf{U} \mathbf{D} \mathbf{V}
\end{align*}\]</span></p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="day-20.html#cb313-1"></a>V &lt;-<span class="st"> </span>svd_y<span class="op">$</span>v</span>
<span id="cb313-2"><a href="day-20.html#cb313-2"></a><span class="kw">colnames</span>(V) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;EOF&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(SSTdata))</span>
<span id="cb313-3"><a href="day-20.html#cb313-3"></a>EOFs &lt;-<span class="st"> </span><span class="kw">cbind</span>(SSTlonlat[ <span class="op">-</span><span class="st"> </span>delete_rows, ], V)</span>
<span id="cb313-4"><a href="day-20.html#cb313-4"></a><span class="kw">glimpse</span>(EOFs[, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, ])</span></code></pre></div>
<pre><code>## Observations: 2,261
## Variables: 6
## $ lon  &lt;dbl&gt; 154, 156, 158, 160, 162, 164, 166, 168, 170,…
## $ lat  &lt;dbl&gt; -29, -29, -29, -29, -29, -29, -29, -29, -29,…
## $ EOF1 &lt;dbl&gt; -0.0049151, -0.0014123, 0.0002459, 0.0014550…
## $ EOF2 &lt;dbl&gt; -1.213e-02, -2.276e-03, 2.298e-03, 2.304e-03…
## $ EOF3 &lt;dbl&gt; -0.02882, -0.02553, -0.01933, -0.01906, -0.0…
## $ EOF4 &lt;dbl&gt; 8.541e-05, 6.726e-03, 8.591e-03, 1.026e-02, …</code></pre>
<p>Plot the EOFs</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="day-20.html#cb315-1"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> EOFs, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> EOF1)) <span class="op">+</span></span>
<span id="cb315-2"><a href="day-20.html#cb315-2"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb315-3"><a href="day-20.html#cb315-3"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></span>
<span id="cb315-4"><a href="day-20.html#cb315-4"></a><span class="st">    </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="fl">1.3</span>) <span class="op">+</span></span>
<span id="cb315-5"><a href="day-20.html#cb315-5"></a><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb315-6"><a href="day-20.html#cb315-6"></a><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Longitude (deg)&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb315-7"><a href="day-20.html#cb315-7"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Latitude (deg)&quot;</span>) <span class="op">+</span></span>
<span id="cb315-8"><a href="day-20.html#cb315-8"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;First EOF&quot;</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-177-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="day-20.html#cb316-1"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> EOFs, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> EOF2)) <span class="op">+</span></span>
<span id="cb316-2"><a href="day-20.html#cb316-2"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb316-3"><a href="day-20.html#cb316-3"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></span>
<span id="cb316-4"><a href="day-20.html#cb316-4"></a><span class="st">    </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="fl">1.3</span>) <span class="op">+</span></span>
<span id="cb316-5"><a href="day-20.html#cb316-5"></a><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb316-6"><a href="day-20.html#cb316-6"></a><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Longitude (deg)&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb316-7"><a href="day-20.html#cb316-7"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Latitude (deg)&quot;</span>) <span class="op">+</span></span>
<span id="cb316-8"><a href="day-20.html#cb316-8"></a><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Second EOF&quot;</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-178-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>Let’s assume I have data for January 1970.</li>
</ul>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="day-20.html#cb317-1"></a>dat &lt;-<span class="st"> </span>SST_df <span class="op">%&gt;%</span></span>
<span id="cb317-2"><a href="day-20.html#cb317-2"></a><span class="st">    </span><span class="kw">subset</span>(Year <span class="op">==</span><span class="st"> </span><span class="dv">1970</span> <span class="op">&amp;</span><span class="st"> </span>Month <span class="op">==</span><span class="st"> &quot;Jan&quot;</span>)</span>
<span id="cb317-3"><a href="day-20.html#cb317-3"></a>EOFs<span class="op">$</span>y &lt;-<span class="st"> </span>dat<span class="op">$</span>sst[ <span class="op">-</span><span class="st"> </span>delete_rows]</span></code></pre></div>
<p>Model the data using the first few EOFs as basis functions</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="day-20.html#cb318-1"></a>mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1, <span class="dt">data =</span> EOFs)</span>
<span id="cb318-2"><a href="day-20.html#cb318-2"></a><span class="kw">summary</span>(mod)</span>
<span id="cb318-3"><a href="day-20.html#cb318-3"></a><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</span>
<span id="cb318-4"><a href="day-20.html#cb318-4"></a><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1, data = EOFs)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.0443 -0.2771  0.0635  0.3283  1.0750 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   0.2824     0.0111    25.5   &lt;2e-16 ***
## EOF1         -7.9894     0.5259   -15.2   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.455 on 2259 degrees of freedom
## Multiple R-squared:  0.0927, Adjusted R-squared:  0.0923 
## F-statistic:  231 on 1 and 2259 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-180-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="day-20.html#cb320-1"></a>mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1 <span class="op">+</span><span class="st"> </span>EOF2 <span class="op">+</span><span class="st"> </span>EOF3 <span class="op">+</span><span class="st"> </span>EOF4 <span class="op">+</span><span class="st"> </span>EOF5, <span class="dt">data =</span> EOFs)</span>
<span id="cb320-2"><a href="day-20.html#cb320-2"></a><span class="kw">summary</span>(mod)</span>
<span id="cb320-3"><a href="day-20.html#cb320-3"></a><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</span>
<span id="cb320-4"><a href="day-20.html#cb320-4"></a><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1 + EOF2 + EOF3 + EOF4 + EOF5, data = EOFs)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.6775 -0.2141  0.0033  0.2330  0.8828 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -0.2095     0.0217   -9.67   &lt;2e-16 ***
## EOF1        -19.7556     0.6232  -31.70   &lt;2e-16 ***
## EOF2        -12.3421     0.6165  -20.02   &lt;2e-16 ***
## EOF3        -11.8236     0.6720  -17.59   &lt;2e-16 ***
## EOF4         11.3313     0.3695   30.67   &lt;2e-16 ***
## EOF5         13.5727     0.4285   31.67   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.346 on 2255 degrees of freedom
## Multiple R-squared:  0.474,  Adjusted R-squared:  0.473 
## F-statistic:  407 on 5 and 2255 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-181-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="day-20.html#cb322-1"></a>mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1 <span class="op">+</span><span class="st"> </span>EOF2 <span class="op">+</span><span class="st"> </span>EOF3 <span class="op">+</span><span class="st"> </span>EOF4 <span class="op">+</span><span class="st"> </span>EOF5 <span class="op">+</span><span class="st"> </span></span>
<span id="cb322-2"><a href="day-20.html#cb322-2"></a><span class="st">              </span>EOF6 <span class="op">+</span><span class="st"> </span>EOF7 <span class="op">+</span><span class="st"> </span>EOF8 <span class="op">+</span><span class="st"> </span>EOF9 <span class="op">+</span><span class="st"> </span>EOF10, <span class="dt">data =</span> EOFs)</span>
<span id="cb322-3"><a href="day-20.html#cb322-3"></a><span class="kw">summary</span>(mod)</span>
<span id="cb322-4"><a href="day-20.html#cb322-4"></a><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</span>
<span id="cb322-5"><a href="day-20.html#cb322-5"></a><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1 + EOF2 + EOF3 + EOF4 + EOF5 + EOF6 + EOF7 + 
##     EOF8 + EOF9 + EOF10, data = EOFs)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -1.505 -0.210  0.009  0.228  0.968 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -0.2330     0.0229  -10.16  &lt; 2e-16 ***
## EOF1        -20.3188     0.6398  -31.76  &lt; 2e-16 ***
## EOF2        -12.8966     0.6325  -20.39  &lt; 2e-16 ***
## EOF3        -12.4496     0.6930  -17.97  &lt; 2e-16 ***
## EOF4         11.4713     0.3565   32.18  &lt; 2e-16 ***
## EOF5         13.8471     0.4241   32.65  &lt; 2e-16 ***
## EOF6         -4.1098     0.3349  -12.27  &lt; 2e-16 ***
## EOF7          1.5233     0.3294    4.62  4.0e-06 ***
## EOF8         -2.5908     0.3538   -7.32  3.4e-13 ***
## EOF9          0.4330     0.3308    1.31    0.191    
## EOF10         0.5836     0.3365    1.73    0.083 .  
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.329 on 2250 degrees of freedom
## Multiple R-squared:  0.525,  Adjusted R-squared:  0.523 
## F-statistic:  249 on 10 and 2250 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-182-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="day-20.html#cb324-1"></a>mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>EOF1 <span class="op">+</span><span class="st"> </span>EOF2 <span class="op">+</span><span class="st"> </span>EOF3 <span class="op">+</span><span class="st"> </span>EOF4 <span class="op">+</span><span class="st"> </span>EOF5 <span class="op">+</span><span class="st"> </span></span>
<span id="cb324-2"><a href="day-20.html#cb324-2"></a><span class="st">              </span>EOF6 <span class="op">+</span><span class="st"> </span>EOF7 <span class="op">+</span><span class="st"> </span>EOF8 <span class="op">+</span><span class="st"> </span>EOF9 <span class="op">+</span><span class="st"> </span>EOF10 <span class="op">+</span></span>
<span id="cb324-3"><a href="day-20.html#cb324-3"></a><span class="st">              </span>EOF11 <span class="op">+</span><span class="st"> </span>EOF12 <span class="op">+</span><span class="st"> </span>EOF13 <span class="op">+</span><span class="st"> </span>EOF14 <span class="op">+</span><span class="st"> </span>EOF15 <span class="op">+</span><span class="st"> </span></span>
<span id="cb324-4"><a href="day-20.html#cb324-4"></a><span class="st">              </span>EOF16 <span class="op">+</span><span class="st"> </span>EOF17 <span class="op">+</span><span class="st"> </span>EOF18 <span class="op">+</span><span class="st"> </span>EOF19 <span class="op">+</span><span class="st"> </span>EOF20, <span class="dt">data =</span> EOFs)</span>
<span id="cb324-5"><a href="day-20.html#cb324-5"></a><span class="kw">summary</span>(mod)</span>
<span id="cb324-6"><a href="day-20.html#cb324-6"></a><span class="kw">plot</span>(EOFs<span class="op">$</span>y, <span class="kw">predict</span>(mod), <span class="dt">main =</span> <span class="st">&quot;Fitted vs. Predicted&quot;</span>)</span>
<span id="cb324-7"><a href="day-20.html#cb324-7"></a><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ EOF1 + EOF2 + EOF3 + EOF4 + EOF5 + EOF6 + EOF7 + 
##     EOF8 + EOF9 + EOF10 + EOF11 + EOF12 + EOF13 + EOF14 + EOF15 + 
##     EOF16 + EOF17 + EOF18 + EOF19 + EOF20, data = EOFs)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -0.9760 -0.1509  0.0125  0.1632  0.6419 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -0.1694     0.0228   -7.44  1.4e-13 ***
## EOF1        -18.7965     0.5955  -31.56  &lt; 2e-16 ***
## EOF2        -11.3979     0.5879  -19.39  &lt; 2e-16 ***
## EOF3        -10.7575     0.6516  -16.51  &lt; 2e-16 ***
## EOF4         11.0929     0.2766   40.10  &lt; 2e-16 ***
## EOF5         13.1056     0.3585   36.55  &lt; 2e-16 ***
## EOF6         -4.2775     0.2486  -17.21  &lt; 2e-16 ***
## EOF7          1.5256     0.2412    6.32  3.1e-10 ***
## EOF8         -2.2324     0.2732   -8.17  5.0e-16 ***
## EOF9          0.3487     0.2431    1.43    0.152    
## EOF10         0.3939     0.2506    1.57    0.116    
## EOF11        -0.4529     0.2419   -1.87    0.061 .  
## EOF12        -1.6805     0.2417   -6.95  4.7e-12 ***
## EOF13         1.4899     0.2412    6.18  7.8e-10 ***
## EOF14        -1.2705     0.2442   -5.20  2.1e-07 ***
## EOF15        -1.9499     0.2422   -8.05  1.3e-15 ***
## EOF16         3.8331     0.2975   12.88  &lt; 2e-16 ***
## EOF17        -3.7016     0.2470  -14.99  &lt; 2e-16 ***
## EOF18         3.7071     0.2597   14.27  &lt; 2e-16 ***
## EOF19        -5.5411     0.2420  -22.90  &lt; 2e-16 ***
## EOF20         5.5816     0.2487   22.45  &lt; 2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.241 on 2240 degrees of freedom
## Multiple R-squared:  0.747,  Adjusted R-squared:  0.744 
## F-statistic:  330 on 20 and 2240 DF,  p-value: &lt;2e-16</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-183-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li><p>Disadvantages</p>
<ul>
<li>Calculation of the SVD scales with <span class="math inline">\(O(n^3)\)</span></li>
<li>Each of the EOFs are global (almost always nonzero)</li>
</ul></li>
</ul>
</div>
<div id="spatial-modeling-with-mgcv-package" class="section level2" number="20.7">
<h2 number="20.7"><span class="header-section-number">20.7</span> Spatial modeling with <code>mgcv</code> package</h2>
<p>Use the same temperature data</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="day-20.html#cb326-1"></a><span class="kw">data</span>(<span class="st">&quot;NOAA_df_1990&quot;</span>)</span>
<span id="cb326-2"><a href="day-20.html#cb326-2"></a><span class="co">## add a factor variable for left_join</span></span>
<span id="cb326-3"><a href="day-20.html#cb326-3"></a>NOAA_df_<span class="dv">1990</span><span class="op">$</span>id_factor &lt;-<span class="st"> </span><span class="kw">factor</span>(NOAA_df_<span class="dv">1990</span><span class="op">$</span>id)</span>
<span id="cb326-4"><a href="day-20.html#cb326-4"></a>dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></span>
<span id="cb326-5"><a href="day-20.html#cb326-5"></a><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb326-6"><a href="day-20.html#cb326-6"></a><span class="st">    </span><span class="kw">group_by</span>(id_factor) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb326-7"><a href="day-20.html#cb326-7"></a><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_Tmax =</span> <span class="kw">mean</span>(z)) <span class="co">#</span></span>
<span id="cb326-8"><a href="day-20.html#cb326-8"></a></span>
<span id="cb326-9"><a href="day-20.html#cb326-9"></a><span class="co">## add back in the lat/lon variables</span></span>
<span id="cb326-10"><a href="day-20.html#cb326-10"></a>dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></span>
<span id="cb326-11"><a href="day-20.html#cb326-11"></a><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb326-12"><a href="day-20.html#cb326-12"></a><span class="st">    </span><span class="kw">left_join</span>(dat, <span class="dt">by =</span> <span class="st">&quot;id_factor&quot;</span>) </span>
<span id="cb326-13"><a href="day-20.html#cb326-13"></a></span>
<span id="cb326-14"><a href="day-20.html#cb326-14"></a>fit &lt;-<span class="st"> </span><span class="kw">gam</span>(z <span class="op">~</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(lon, lat, <span class="dt">bs =</span> <span class="st">&quot;tp&quot;</span>, <span class="dt">k =</span> <span class="dv">30</span>), <span class="dt">data =</span> dat)</span>
<span id="cb326-15"><a href="day-20.html#cb326-15"></a><span class="co"># tensor product of a 2-d thin plate regression spline and 1-d cr spline  </span></span></code></pre></div>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="day-20.html#cb327-1"></a><span class="co">## explore model residuals</span></span>
<span id="cb327-2"><a href="day-20.html#cb327-2"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb327-3"><a href="day-20.html#cb327-3"></a><span class="kw">gam.check</span>(fit)</span></code></pre></div>
<pre><code>## 
## Method: GCV   Optimizer: magic
## Smoothing parameter selection converged after 5 iterations.
## The RMS GCV score gradient at convergence was 0.0005041 .
## The Hessian was positive definite.
## Model rank =  30 / 32 
## 
## Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
## indicate that k is too low, especially if edf is close to k&#39;.
## 
##            k&#39; edf k-index p-value
## s(lon,lat) 29  24    0.97     0.3</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-185-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="day-20.html#cb329-1"></a><span class="co">## generate model predictions</span></span>
<span id="cb329-2"><a href="day-20.html#cb329-2"></a>pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</span>
<span id="cb329-3"><a href="day-20.html#cb329-3"></a>    <span class="kw">expand.grid</span>(</span>
<span id="cb329-4"><a href="day-20.html#cb329-4"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </span>
<span id="cb329-5"><a href="day-20.html#cb329-5"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb329-6"><a href="day-20.html#cb329-6"></a>    )</span>
<span id="cb329-7"><a href="day-20.html#cb329-7"></a>)</span>
<span id="cb329-8"><a href="day-20.html#cb329-8"></a><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb329-9"><a href="day-20.html#cb329-9"></a></span>
<span id="cb329-10"><a href="day-20.html#cb329-10"></a>preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> pred_coords, <span class="dt">se.fit =</span> <span class="ot">TRUE</span>)</span>
<span id="cb329-11"><a href="day-20.html#cb329-11"></a>pred_coords<span class="op">$</span>pred_mean &lt;-<span class="st"> </span>preds<span class="op">$</span>fit</span>
<span id="cb329-12"><a href="day-20.html#cb329-12"></a>pred_coords<span class="op">$</span>pred_var &lt;-<span class="st"> </span>preds<span class="op">$</span>se.fit<span class="op">^</span><span class="dv">2</span></span>
<span id="cb329-13"><a href="day-20.html#cb329-13"></a></span>
<span id="cb329-14"><a href="day-20.html#cb329-14"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></span>
<span id="cb329-15"><a href="day-20.html#cb329-15"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb329-16"><a href="day-20.html#cb329-16"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb329-17"><a href="day-20.html#cb329-17"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb329-18"><a href="day-20.html#cb329-18"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb329-19"><a href="day-20.html#cb329-19"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb329-20"><a href="day-20.html#cb329-20"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span>
<span id="cb329-21"><a href="day-20.html#cb329-21"></a></span>
<span id="cb329-22"><a href="day-20.html#cb329-22"></a></span>
<span id="cb329-23"><a href="day-20.html#cb329-23"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> pred_coords, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_var)) <span class="op">+</span></span>
<span id="cb329-24"><a href="day-20.html#cb329-24"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb329-25"><a href="day-20.html#cb329-25"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb329-26"><a href="day-20.html#cb329-26"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb329-27"><a href="day-20.html#cb329-27"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb329-28"><a href="day-20.html#cb329-28"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average July max Temperature prediction variance in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb329-29"><a href="day-20.html#cb329-29"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-186-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-186-2.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="spatial-modeling-with-kernels" class="section level2" number="20.8">
<h2 number="20.8"><span class="header-section-number">20.8</span> Spatial modeling with Kernels</h2>
<ul>
<li><p>Kernel functions can be either local or global</p>
<ul>
<li>Gaussian, exponential kernels are global</li>
<li>Truncated Gaussian and truncated exponential are local</li>
</ul></li>
<li><p>Kernel functions require specifying a kernel shape, a “bandwith”, and the number of “knots”.</p></li>
</ul>
<p>Use the same temperature data with Gaussian Kernels</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="day-20.html#cb330-1"></a><span class="kw">data</span>(<span class="st">&quot;NOAA_df_1990&quot;</span>)</span>
<span id="cb330-2"><a href="day-20.html#cb330-2"></a><span class="co">## add a factor variable for left_join</span></span>
<span id="cb330-3"><a href="day-20.html#cb330-3"></a>NOAA_df_<span class="dv">1990</span><span class="op">$</span>id_factor &lt;-<span class="st"> </span><span class="kw">factor</span>(NOAA_df_<span class="dv">1990</span><span class="op">$</span>id)</span>
<span id="cb330-4"><a href="day-20.html#cb330-4"></a>dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></span>
<span id="cb330-5"><a href="day-20.html#cb330-5"></a><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb330-6"><a href="day-20.html#cb330-6"></a><span class="st">    </span><span class="kw">group_by</span>(id_factor) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb330-7"><a href="day-20.html#cb330-7"></a><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_Tmax =</span> <span class="kw">mean</span>(z)) <span class="co">#</span></span>
<span id="cb330-8"><a href="day-20.html#cb330-8"></a></span>
<span id="cb330-9"><a href="day-20.html#cb330-9"></a><span class="co">## add back in the lat/lon variables</span></span>
<span id="cb330-10"><a href="day-20.html#cb330-10"></a>dat &lt;-<span class="st"> </span>NOAA_df_<span class="dv">1990</span> <span class="op">%&gt;%</span></span>
<span id="cb330-11"><a href="day-20.html#cb330-11"></a><span class="st">    </span><span class="kw">subset</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span> <span class="op">&amp;</span><span class="st"> </span>month <span class="op">==</span><span class="st"> </span><span class="dv">7</span> <span class="op">&amp;</span><span class="st"> </span>proc <span class="op">==</span><span class="st"> &quot;Tmax&quot;</span> <span class="op">&amp;</span><span class="st"> </span>day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb330-12"><a href="day-20.html#cb330-12"></a><span class="st">    </span><span class="kw">left_join</span>(dat, <span class="dt">by =</span> <span class="st">&quot;id_factor&quot;</span>) </span></code></pre></div>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="day-20.html#cb331-1"></a><span class="co">## For simplicity, assume this is a square number</span></span>
<span id="cb331-2"><a href="day-20.html#cb331-2"></a>n_knots &lt;-<span class="st"> </span><span class="dv">25</span></span>
<span id="cb331-3"><a href="day-20.html#cb331-3"></a>knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb331-4"><a href="day-20.html#cb331-4"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </span>
<span id="cb331-5"><a href="day-20.html#cb331-5"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</span>
<span id="cb331-6"><a href="day-20.html#cb331-6"></a>)</span>
<span id="cb331-7"><a href="day-20.html#cb331-7"></a></span>
<span id="cb331-8"><a href="day-20.html#cb331-8"></a>make_kernel_basis &lt;-<span class="st"> </span><span class="cf">function</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> <span class="dv">1</span>, <span class="dt">threshold =</span> <span class="ot">NULL</span>) {</span>
<span id="cb331-9"><a href="day-20.html#cb331-9"></a>    <span class="cf">if</span> (<span class="op">!</span>(kernel <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;exponential&quot;</span>))) {</span>
<span id="cb331-10"><a href="day-20.html#cb331-10"></a>        <span class="kw">stop</span>(<span class="st">&quot;only kernels available are gaussian and exponential&quot;</span>)</span>
<span id="cb331-11"><a href="day-20.html#cb331-11"></a>    }</span>
<span id="cb331-12"><a href="day-20.html#cb331-12"></a>    D &lt;-<span class="st"> </span>fields<span class="op">::</span><span class="kw">rdist</span>(<span class="kw">as.matrix</span>(coords), <span class="kw">as.matrix</span>(knots))</span>
<span id="cb331-13"><a href="day-20.html#cb331-13"></a>    X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="kw">nrow</span>(D), <span class="kw">ncol</span>(D))</span>
<span id="cb331-14"><a href="day-20.html#cb331-14"></a>    <span class="cf">if</span> (kernel <span class="op">==</span><span class="st"> &quot;exponential&quot;</span>) {</span>
<span id="cb331-15"><a href="day-20.html#cb331-15"></a>        X &lt;-<span class="st"> </span><span class="kw">exp</span> (<span class="op">-</span><span class="st"> </span>D <span class="op">/</span><span class="st"> </span>bandwith)</span>
<span id="cb331-16"><a href="day-20.html#cb331-16"></a>    } <span class="cf">else</span> <span class="cf">if</span> (kernel <span class="op">==</span><span class="st"> &quot;gaussian&quot;</span>) {</span>
<span id="cb331-17"><a href="day-20.html#cb331-17"></a>        X &lt;-<span class="st"> </span><span class="kw">exp</span> (<span class="op">-</span><span class="st"> </span>D<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>bandwith)</span>
<span id="cb331-18"><a href="day-20.html#cb331-18"></a>    }</span>
<span id="cb331-19"><a href="day-20.html#cb331-19"></a>    </span>
<span id="cb331-20"><a href="day-20.html#cb331-20"></a>    <span class="co">## add in a minimum distance threshold</span></span>
<span id="cb331-21"><a href="day-20.html#cb331-21"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(threshold)) {</span>
<span id="cb331-22"><a href="day-20.html#cb331-22"></a>        X[D <span class="op">&gt;</span><span class="st"> </span>threshold] &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb331-23"><a href="day-20.html#cb331-23"></a>    }</span>
<span id="cb331-24"><a href="day-20.html#cb331-24"></a></span>
<span id="cb331-25"><a href="day-20.html#cb331-25"></a>    <span class="kw">return</span>(X)</span>
<span id="cb331-26"><a href="day-20.html#cb331-26"></a>}</span></code></pre></div>
<p>We can plot the kernels over the domain of interest using the code below. Note that it is useful to change the bandwith parameter so that the kernel covers multiple other knots</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="day-20.html#cb332-1"></a>coords &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat<span class="op">$</span>lon, dat<span class="op">$</span>lat)</span>
<span id="cb332-2"><a href="day-20.html#cb332-2"></a>coords_plot &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb332-3"><a href="day-20.html#cb332-3"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </span>
<span id="cb332-4"><a href="day-20.html#cb332-4"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb332-5"><a href="day-20.html#cb332-5"></a>)</span>
<span id="cb332-6"><a href="day-20.html#cb332-6"></a><span class="kw">colnames</span>(coords_plot) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb332-7"><a href="day-20.html#cb332-7"></a></span>
<span id="cb332-8"><a href="day-20.html#cb332-8"></a>X_plot &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords_plot, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> <span class="dv">20</span>)</span>
<span id="cb332-9"><a href="day-20.html#cb332-9"></a></span>
<span id="cb332-10"><a href="day-20.html#cb332-10"></a><span class="co">## plot the kernel basis</span></span>
<span id="cb332-11"><a href="day-20.html#cb332-11"></a>dat_plot &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb332-12"><a href="day-20.html#cb332-12"></a>    <span class="dt">x     =</span> coords_plot[, <span class="dv">1</span>], </span>
<span id="cb332-13"><a href="day-20.html#cb332-13"></a>    <span class="dt">y     =</span> coords_plot[, <span class="dv">2</span>],</span>
<span id="cb332-14"><a href="day-20.html#cb332-14"></a>    <span class="dt">X     =</span> <span class="kw">c</span>(X_plot),</span>
<span id="cb332-15"><a href="day-20.html#cb332-15"></a>    <span class="dt">basis =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X_plot), <span class="dt">each =</span> <span class="kw">nrow</span>(coords_plot)))</span>
<span id="cb332-16"><a href="day-20.html#cb332-16"></a>)</span>
<span id="cb332-17"><a href="day-20.html#cb332-17"></a>dat_knots &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb332-18"><a href="day-20.html#cb332-18"></a>  <span class="dt">x =</span> knots[, <span class="dv">1</span>],</span>
<span id="cb332-19"><a href="day-20.html#cb332-19"></a>  <span class="dt">y =</span> knots[, <span class="dv">2</span>]</span>
<span id="cb332-20"><a href="day-20.html#cb332-20"></a>)</span>
<span id="cb332-21"><a href="day-20.html#cb332-21"></a></span>
<span id="cb332-22"><a href="day-20.html#cb332-22"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_plot, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">fill =</span> X)) <span class="op">+</span></span>
<span id="cb332-23"><a href="day-20.html#cb332-23"></a><span class="st">  </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb332-24"><a href="day-20.html#cb332-24"></a><span class="st">  </span><span class="co"># geom(aes(x = x, y = X_fourier, group = basis, color = basis)) +</span></span>
<span id="cb332-25"><a href="day-20.html#cb332-25"></a><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="op">+</span></span>
<span id="cb332-26"><a href="day-20.html#cb332-26"></a><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb332-27"><a href="day-20.html#cb332-27"></a><span class="st">  </span><span class="kw">facet_wrap</span>( <span class="op">~</span><span class="st"> </span>basis, <span class="dt">ncol =</span> <span class="kw">sqrt</span>(n_knots)) <span class="op">+</span></span>
<span id="cb332-28"><a href="day-20.html#cb332-28"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Kernel Basis&quot;</span>) <span class="op">+</span></span>
<span id="cb332-29"><a href="day-20.html#cb332-29"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> dat_knots, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">0.25</span>, <span class="dt">inherit.aes =</span> <span class="ot">FALSE</span>) </span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-189-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="day-20.html#cb333-1"></a><span class="co">## apply the kernel basis to the data</span></span>
<span id="cb333-2"><a href="day-20.html#cb333-2"></a>bw &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">100</span>, <span class="dv">1000</span>)</span>
<span id="cb333-3"><a href="day-20.html#cb333-3"></a>check_AICc &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="kw">length</span>(bw)) </span>
<span id="cb333-4"><a href="day-20.html#cb333-4"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>) {</span>
<span id="cb333-5"><a href="day-20.html#cb333-5"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(bw)) {</span>
<span id="cb333-6"><a href="day-20.html#cb333-6"></a>    n_knots &lt;-<span class="st"> </span>j<span class="op">^</span><span class="dv">2</span></span>
<span id="cb333-7"><a href="day-20.html#cb333-7"></a>    knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb333-8"><a href="day-20.html#cb333-8"></a>      <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </span>
<span id="cb333-9"><a href="day-20.html#cb333-9"></a>      <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</span>
<span id="cb333-10"><a href="day-20.html#cb333-10"></a>    )</span>
<span id="cb333-11"><a href="day-20.html#cb333-11"></a>    X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[k])</span>
<span id="cb333-12"><a href="day-20.html#cb333-12"></a>    <span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb333-13"><a href="day-20.html#cb333-13"></a>    X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</span>
<span id="cb333-14"><a href="day-20.html#cb333-14"></a>    fit &lt;-<span class="st"> </span><span class="kw">lm</span>(dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> X)</span>
<span id="cb333-15"><a href="day-20.html#cb333-15"></a>    check_AICc[j, k] &lt;-<span class="st"> </span><span class="kw">AIC</span>(fit) <span class="op">+</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(j<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(j<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">nrow</span>(X) <span class="op">-</span><span class="st"> </span>j<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb333-16"><a href="day-20.html#cb333-16"></a>  }</span>
<span id="cb333-17"><a href="day-20.html#cb333-17"></a>}</span>
<span id="cb333-18"><a href="day-20.html#cb333-18"></a><span class="kw">matplot</span>(check_AICc, <span class="dt">type =</span> <span class="st">&#39;p&#39;</span>)</span>
<span id="cb333-19"><a href="day-20.html#cb333-19"></a>best_idx &lt;-<span class="st"> </span><span class="kw">which</span>(check_AICc <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(check_AICc), <span class="dt">arr.ind =</span> <span class="ot">TRUE</span>)</span>
<span id="cb333-20"><a href="day-20.html#cb333-20"></a><span class="co">## the best fitting model has 5 knots and bandwidth 20</span></span>
<span id="cb333-21"><a href="day-20.html#cb333-21"></a>best_idx</span></code></pre></div>
<pre><code>##      row col
## [1,]   5   3</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-190-1.png" width="480" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="day-20.html#cb335-1"></a>n_knots &lt;-<span class="st"> </span>best_idx[<span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span></span>
<span id="cb335-2"><a href="day-20.html#cb335-2"></a>knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb335-3"><a href="day-20.html#cb335-3"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </span>
<span id="cb335-4"><a href="day-20.html#cb335-4"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</span>
<span id="cb335-5"><a href="day-20.html#cb335-5"></a>)</span>
<span id="cb335-6"><a href="day-20.html#cb335-6"></a>X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</span>
<span id="cb335-7"><a href="day-20.html#cb335-7"></a><span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb335-8"><a href="day-20.html#cb335-8"></a>X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</span>
<span id="cb335-9"><a href="day-20.html#cb335-9"></a>fit &lt;-<span class="st"> </span><span class="kw">lm</span>(dat<span class="op">$</span>z <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> X)</span></code></pre></div>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="day-20.html#cb336-1"></a><span class="co">## generate model predictions</span></span>
<span id="cb336-2"><a href="day-20.html#cb336-2"></a>pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</span>
<span id="cb336-3"><a href="day-20.html#cb336-3"></a>    <span class="kw">expand.grid</span>(</span>
<span id="cb336-4"><a href="day-20.html#cb336-4"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </span>
<span id="cb336-5"><a href="day-20.html#cb336-5"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb336-6"><a href="day-20.html#cb336-6"></a>    )</span>
<span id="cb336-7"><a href="day-20.html#cb336-7"></a>)</span>
<span id="cb336-8"><a href="day-20.html#cb336-8"></a><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb336-9"><a href="day-20.html#cb336-9"></a>X_pred &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</span>
<span id="cb336-10"><a href="day-20.html#cb336-10"></a><span class="kw">colnames</span>(X_pred) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb336-11"><a href="day-20.html#cb336-11"></a>X_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X_pred)</span>
<span id="cb336-12"><a href="day-20.html#cb336-12"></a></span>
<span id="cb336-13"><a href="day-20.html#cb336-13"></a>preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> X_pred, <span class="dt">se.fit =</span> <span class="ot">TRUE</span>)</span>
<span id="cb336-14"><a href="day-20.html#cb336-14"></a></span>
<span id="cb336-15"><a href="day-20.html#cb336-15"></a>dat_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb336-16"><a href="day-20.html#cb336-16"></a>  <span class="dt">lon       =</span> pred_coords<span class="op">$</span>lon,</span>
<span id="cb336-17"><a href="day-20.html#cb336-17"></a>  <span class="dt">lat       =</span> pred_coords<span class="op">$</span>lat,</span>
<span id="cb336-18"><a href="day-20.html#cb336-18"></a>  <span class="co">## prediction mean</span></span>
<span id="cb336-19"><a href="day-20.html#cb336-19"></a>  <span class="dt">pred_mean =</span> preds<span class="op">$</span>fit,</span>
<span id="cb336-20"><a href="day-20.html#cb336-20"></a>  <span class="co">## prediction variance</span></span>
<span id="cb336-21"><a href="day-20.html#cb336-21"></a>  <span class="dt">pred_var  =</span> preds<span class="op">$</span>se.fit<span class="op">^</span><span class="dv">2</span></span>
<span id="cb336-22"><a href="day-20.html#cb336-22"></a>)</span>
<span id="cb336-23"><a href="day-20.html#cb336-23"></a></span>
<span id="cb336-24"><a href="day-20.html#cb336-24"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></span>
<span id="cb336-25"><a href="day-20.html#cb336-25"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb336-26"><a href="day-20.html#cb336-26"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb336-27"><a href="day-20.html#cb336-27"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb336-28"><a href="day-20.html#cb336-28"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb336-29"><a href="day-20.html#cb336-29"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb336-30"><a href="day-20.html#cb336-30"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span>
<span id="cb336-31"><a href="day-20.html#cb336-31"></a></span>
<span id="cb336-32"><a href="day-20.html#cb336-32"></a></span>
<span id="cb336-33"><a href="day-20.html#cb336-33"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_var)) <span class="op">+</span></span>
<span id="cb336-34"><a href="day-20.html#cb336-34"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb336-35"><a href="day-20.html#cb336-35"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb336-36"><a href="day-20.html#cb336-36"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb336-37"><a href="day-20.html#cb336-37"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb336-38"><a href="day-20.html#cb336-38"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average July max Temperature prediction variance in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb336-39"><a href="day-20.html#cb336-39"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-192-1.png" width="480" style="display: block; margin: auto;" /><img src="STAT-5413_files/figure-html/unnamed-chunk-192-2.png" width="480" style="display: block; margin: auto;" /></p>
<p>Notice that the above model is overfit – see the large variance surface. This can be resolved with penalized models (ridge, lasso, elastic net, etc). Many basis-function models show “edge effects” in the model fit. This is because at the edges of the domain there are one or two basis functions that see little data and therefore have high variability in the estimate. One can either add duplicate knots or extend the spatial domain of the knots and add a penalty term to the fit.</p>
<div id="kernel-regression-with-a-ridge-penalty" class="section level3" number="20.8.1">
<h3 number="20.8.1"><span class="header-section-number">20.8.1</span> Kernel regression with a ridge penalty</h3>
<ul>
<li>Note: glmnet doesn’t have a theoretically-motivated method for calculating prediction standard errors</li>
</ul>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="day-20.html#cb337-1"></a><span class="co">## set alpha = 0 for ridge regression</span></span>
<span id="cb337-2"><a href="day-20.html#cb337-2"></a>X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</span>
<span id="cb337-3"><a href="day-20.html#cb337-3"></a><span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb337-4"><a href="day-20.html#cb337-4"></a>X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</span>
<span id="cb337-5"><a href="day-20.html#cb337-5"></a></span>
<span id="cb337-6"><a href="day-20.html#cb337-6"></a>cv_fit &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb337-7"><a href="day-20.html#cb337-7"></a>fit &lt;-<span class="st"> </span><span class="kw">glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">0</span>, <span class="dt">lambda =</span> cv_fit<span class="op">$</span>lambda.min)</span>
<span id="cb337-8"><a href="day-20.html#cb337-8"></a></span>
<span id="cb337-9"><a href="day-20.html#cb337-9"></a><span class="co">## generate model predictions</span></span>
<span id="cb337-10"><a href="day-20.html#cb337-10"></a>pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</span>
<span id="cb337-11"><a href="day-20.html#cb337-11"></a>    <span class="kw">expand.grid</span>(</span>
<span id="cb337-12"><a href="day-20.html#cb337-12"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </span>
<span id="cb337-13"><a href="day-20.html#cb337-13"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb337-14"><a href="day-20.html#cb337-14"></a>    )</span>
<span id="cb337-15"><a href="day-20.html#cb337-15"></a>)</span>
<span id="cb337-16"><a href="day-20.html#cb337-16"></a><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb337-17"><a href="day-20.html#cb337-17"></a></span>
<span id="cb337-18"><a href="day-20.html#cb337-18"></a>X_pred &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</span>
<span id="cb337-19"><a href="day-20.html#cb337-19"></a><span class="kw">colnames</span>(X_pred) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb337-20"><a href="day-20.html#cb337-20"></a>X_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X_pred)</span>
<span id="cb337-21"><a href="day-20.html#cb337-21"></a></span>
<span id="cb337-22"><a href="day-20.html#cb337-22"></a>preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newx =</span> <span class="kw">as.matrix</span>(X_pred))</span></code></pre></div>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="day-20.html#cb338-1"></a>dat_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb338-2"><a href="day-20.html#cb338-2"></a>  <span class="dt">lon       =</span> pred_coords<span class="op">$</span>lon,</span>
<span id="cb338-3"><a href="day-20.html#cb338-3"></a>  <span class="dt">lat       =</span> pred_coords<span class="op">$</span>lat,</span>
<span id="cb338-4"><a href="day-20.html#cb338-4"></a>  <span class="dt">pred_mean =</span> <span class="kw">c</span>(preds)</span>
<span id="cb338-5"><a href="day-20.html#cb338-5"></a>)</span>
<span id="cb338-6"><a href="day-20.html#cb338-6"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></span>
<span id="cb338-7"><a href="day-20.html#cb338-7"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb338-8"><a href="day-20.html#cb338-8"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb338-9"><a href="day-20.html#cb338-9"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb338-10"><a href="day-20.html#cb338-10"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb338-11"><a href="day-20.html#cb338-11"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb338-12"><a href="day-20.html#cb338-12"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-194-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="kernel-regression-with-a-lasso-penalty" class="section level3" number="20.8.2">
<h3 number="20.8.2"><span class="header-section-number">20.8.2</span> Kernel regression with a lasso penalty</h3>
<ul>
<li>Note: glmnet doesn’t have a theoretically-motivated method for calculating prediction standard errors</li>
</ul>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="day-20.html#cb339-1"></a><span class="co">## set alpha = 1 for ridge regression</span></span>
<span id="cb339-2"><a href="day-20.html#cb339-2"></a>X &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</span>
<span id="cb339-3"><a href="day-20.html#cb339-3"></a><span class="kw">colnames</span>(X) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb339-4"><a href="day-20.html#cb339-4"></a>X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X)</span>
<span id="cb339-5"><a href="day-20.html#cb339-5"></a></span>
<span id="cb339-6"><a href="day-20.html#cb339-6"></a>cv_fit &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb339-7"><a href="day-20.html#cb339-7"></a>fit &lt;-<span class="st"> </span><span class="kw">glmnet</span>(<span class="kw">as.matrix</span>(X), dat<span class="op">$</span>z, <span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">lambda =</span> cv_fit<span class="op">$</span>lambda.min)</span>
<span id="cb339-8"><a href="day-20.html#cb339-8"></a></span>
<span id="cb339-9"><a href="day-20.html#cb339-9"></a><span class="co">## generate model predictions</span></span>
<span id="cb339-10"><a href="day-20.html#cb339-10"></a>pred_coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</span>
<span id="cb339-11"><a href="day-20.html#cb339-11"></a>    <span class="kw">expand.grid</span>(</span>
<span id="cb339-12"><a href="day-20.html#cb339-12"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">100</span>), </span>
<span id="cb339-13"><a href="day-20.html#cb339-13"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">100</span>)</span>
<span id="cb339-14"><a href="day-20.html#cb339-14"></a>    )</span>
<span id="cb339-15"><a href="day-20.html#cb339-15"></a>)</span>
<span id="cb339-16"><a href="day-20.html#cb339-16"></a><span class="kw">colnames</span>(pred_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb339-17"><a href="day-20.html#cb339-17"></a></span>
<span id="cb339-18"><a href="day-20.html#cb339-18"></a>X_pred &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]])</span>
<span id="cb339-19"><a href="day-20.html#cb339-19"></a><span class="kw">colnames</span>(X_pred) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(X))</span>
<span id="cb339-20"><a href="day-20.html#cb339-20"></a>X_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(X_pred)</span>
<span id="cb339-21"><a href="day-20.html#cb339-21"></a></span>
<span id="cb339-22"><a href="day-20.html#cb339-22"></a>preds &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newx =</span> <span class="kw">as.matrix</span>(X_pred))</span></code></pre></div>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="day-20.html#cb340-1"></a>dat_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb340-2"><a href="day-20.html#cb340-2"></a>  <span class="dt">lon       =</span> pred_coords<span class="op">$</span>lon,</span>
<span id="cb340-3"><a href="day-20.html#cb340-3"></a>  <span class="dt">lat       =</span> pred_coords<span class="op">$</span>lat,</span>
<span id="cb340-4"><a href="day-20.html#cb340-4"></a>  <span class="dt">pred_mean =</span> <span class="kw">c</span>(preds)</span>
<span id="cb340-5"><a href="day-20.html#cb340-5"></a>)</span>
<span id="cb340-6"><a href="day-20.html#cb340-6"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> dat_pred, <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">fill =</span> pred_mean)) <span class="op">+</span></span>
<span id="cb340-7"><a href="day-20.html#cb340-7"></a><span class="st">    </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb340-8"><a href="day-20.html#cb340-8"></a><span class="st">    </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> states, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), </span>
<span id="cb340-9"><a href="day-20.html#cb340-9"></a>                 <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb340-10"><a href="day-20.html#cb340-10"></a><span class="st">    </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="op">+</span></span>
<span id="cb340-11"><a href="day-20.html#cb340-11"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Average July max Temperature in 1990&quot;</span>)  <span class="op">+</span></span>
<span id="cb340-12"><a href="day-20.html#cb340-12"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lon), <span class="dt">ylim =</span> <span class="kw">range</span>(dat<span class="op">$</span>lat), <span class="dt">ratio =</span> <span class="fl">1.3</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-196-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="truncated-kernels---local-support" class="section level3" number="20.8.3">
<h3 number="20.8.3"><span class="header-section-number">20.8.3</span> Truncated Kernels - local support</h3>
<p>The kernels constructed above are globally supported (dense)</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="day-20.html#cb341-1"></a><span class="kw">mean</span>(X_pred <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<ul>
<li>Can use traditional kernels and truncate using a threshold</li>
</ul>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="day-20.html#cb343-1"></a>X_threshold &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(pred_coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb343-2"><a href="day-20.html#cb343-2"></a>                                 <span class="dt">bandwith =</span> bw[best_idx[<span class="dv">2</span>]], <span class="dt">threshold =</span> <span class="dv">10</span>)</span>
<span id="cb343-3"><a href="day-20.html#cb343-3"></a><span class="kw">mean</span>(X_threshold <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 0.473</code></pre>
<p>Can use other functions as a kernel:
- Wendland basis</p>
<p><span class="math display">\[\begin{align*}
\frac{(1 - d)^6 (35 d^2 + 18d + 3)}{3} I\{d &lt; 1\}
\end{align*}\]</span></p>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="day-20.html#cb345-1"></a>wendland_basis &lt;-<span class="st"> </span><span class="cf">function</span>(d, radius) {</span>
<span id="cb345-2"><a href="day-20.html#cb345-2"></a>    <span class="cf">if</span> (<span class="kw">any</span>(d <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)) {</span>
<span id="cb345-3"><a href="day-20.html#cb345-3"></a>        <span class="kw">stop</span>(<span class="st">&quot;d must be nonnegative&quot;</span>)</span>
<span id="cb345-4"><a href="day-20.html#cb345-4"></a>    }</span>
<span id="cb345-5"><a href="day-20.html#cb345-5"></a>    d &lt;-<span class="st"> </span>d <span class="op">/</span><span class="st"> </span>radius</span>
<span id="cb345-6"><a href="day-20.html#cb345-6"></a>    <span class="kw">return</span>(((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">^</span><span class="dv">6</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">35</span> <span class="op">*</span><span class="st"> </span>d<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">18</span> <span class="op">*</span><span class="st"> </span>d <span class="op">+</span><span class="st"> </span><span class="dv">3</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">3</span> <span class="op">*</span><span class="st"> </span>(d <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb345-7"><a href="day-20.html#cb345-7"></a>}</span>
<span id="cb345-8"><a href="day-20.html#cb345-8"></a></span>
<span id="cb345-9"><a href="day-20.html#cb345-9"></a><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>))</span>
<span id="cb345-10"><a href="day-20.html#cb345-10"></a><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.25</span>), <span class="dt">radius =</span> <span class="fl">0.15</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</span>
<span id="cb345-11"><a href="day-20.html#cb345-11"></a><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.75</span>), <span class="dt">radius =</span> <span class="fl">0.15</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</span>
<span id="cb345-12"><a href="day-20.html#cb345-12"></a><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.25</span>), <span class="dt">radius =</span> <span class="fl">0.5</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</span>
<span id="cb345-13"><a href="day-20.html#cb345-13"></a><span class="kw">curve</span>(<span class="kw">wendland_basis</span>(<span class="kw">abs</span>(x <span class="op">-</span><span class="st"> </span><span class="fl">0.75</span>), <span class="dt">radius =</span> <span class="fl">0.5</span>), <span class="dt">n =</span> <span class="dv">1000</span>)</span></code></pre></div>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-199-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="sparse-vs.-dense-matrix-computation" class="section level2" number="20.9">
<h2 number="20.9"><span class="header-section-number">20.9</span> Sparse vs. Dense matrix computation</h2>
<ul>
<li><p>uses the <code>spam64</code> package</p></li>
<li><p>compute time of <span class="math inline">\(\mathbf{X}&#39; \mathbf{X}\)</span> for dense vs. sparse matrices</p></li>
</ul>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="day-20.html#cb346-1"></a>coords &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(</span>
<span id="cb346-2"><a href="day-20.html#cb346-2"></a>    <span class="kw">expand.grid</span>(</span>
<span id="cb346-3"><a href="day-20.html#cb346-3"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="dv">50</span>), </span>
<span id="cb346-4"><a href="day-20.html#cb346-4"></a>        <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="dv">50</span>)</span>
<span id="cb346-5"><a href="day-20.html#cb346-5"></a>    )</span>
<span id="cb346-6"><a href="day-20.html#cb346-6"></a>)</span>
<span id="cb346-7"><a href="day-20.html#cb346-7"></a><span class="kw">colnames</span>(coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb346-8"><a href="day-20.html#cb346-8"></a></span>
<span id="cb346-9"><a href="day-20.html#cb346-9"></a>n_knots &lt;-<span class="st"> </span><span class="dv">25</span><span class="op">^</span><span class="dv">2</span></span>
<span id="cb346-10"><a href="day-20.html#cb346-10"></a>knots &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb346-11"><a href="day-20.html#cb346-11"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lon), <span class="kw">max</span>(dat<span class="op">$</span>lon), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots)), </span>
<span id="cb346-12"><a href="day-20.html#cb346-12"></a>    <span class="kw">seq</span>(<span class="kw">min</span>(dat<span class="op">$</span>lat), <span class="kw">max</span>(dat<span class="op">$</span>lat), <span class="dt">length =</span> <span class="kw">sqrt</span>(n_knots))</span>
<span id="cb346-13"><a href="day-20.html#cb346-13"></a>)</span>
<span id="cb346-14"><a href="day-20.html#cb346-14"></a></span>
<span id="cb346-15"><a href="day-20.html#cb346-15"></a>X_dense &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb346-16"><a href="day-20.html#cb346-16"></a>                                 <span class="dt">bandwith =</span> <span class="dv">5</span>)</span>
<span id="cb346-17"><a href="day-20.html#cb346-17"></a>X_sparse &lt;-<span class="st"> </span><span class="kw">make_kernel_basis</span>(coords, knots, <span class="dt">kernel =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb346-18"><a href="day-20.html#cb346-18"></a>                                 <span class="dt">bandwith =</span> <span class="dv">5</span>, <span class="dt">threshold =</span> <span class="dv">5</span>)</span>
<span id="cb346-19"><a href="day-20.html#cb346-19"></a><span class="kw">mean</span>(X_dense <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb346-20"><a href="day-20.html#cb346-20"></a><span class="kw">mean</span>(X_sparse <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb346-21"><a href="day-20.html#cb346-21"></a><span class="co">## convert to a sparse matrix format</span></span>
<span id="cb346-22"><a href="day-20.html#cb346-22"></a>X_sparse &lt;-<span class="st"> </span><span class="kw">as.spam</span>(X_sparse)</span>
<span id="cb346-23"><a href="day-20.html#cb346-23"></a></span>
<span id="cb346-24"><a href="day-20.html#cb346-24"></a><span class="co">## calcuate t(X) %*% X for dense and sparse matrices</span></span>
<span id="cb346-25"><a href="day-20.html#cb346-25"></a>bm &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(</span>
<span id="cb346-26"><a href="day-20.html#cb346-26"></a>    <span class="kw">crossprod</span>(X_dense, X_dense),</span>
<span id="cb346-27"><a href="day-20.html#cb346-27"></a>    <span class="kw">crossprod.spam</span>(X_sparse, X_sparse),</span>
<span id="cb346-28"><a href="day-20.html#cb346-28"></a>    <span class="dt">times =</span> <span class="dv">10</span></span>
<span id="cb346-29"><a href="day-20.html#cb346-29"></a>)</span>
<span id="cb346-30"><a href="day-20.html#cb346-30"></a></span>
<span id="cb346-31"><a href="day-20.html#cb346-31"></a>bm</span>
<span id="cb346-32"><a href="day-20.html#cb346-32"></a><span class="kw">plot</span>(bm)</span></code></pre></div>
<pre><code>## [1] 0
## [1] 0.7948
## Unit: milliseconds
##                                expr   min    lq  mean
##         crossprod(X_dense, X_dense) 978.6 980.9 986.3
##  crossprod.spam(X_sparse, X_sparse) 131.4 131.7 132.5
##  median    uq   max neval
##   986.2 991.5 993.2    10
##   132.3 133.4 133.9    10</code></pre>
<p><img src="STAT-5413_files/figure-html/unnamed-chunk-200-1.png" width="480" style="display: block; margin: auto;" /></p>
<ul>
<li>almost a 10-fold speedup in computation time by using sparse matrix operations</li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="day-19.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="day-21.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["STAT-5413.pdf", "STAT-5413.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
